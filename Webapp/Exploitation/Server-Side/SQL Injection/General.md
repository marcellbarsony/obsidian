---
id: General
aliases: []
tags: []
---

# SQL Injection

[SQL injection](https://en.wikipedia.org/wiki/SQL_injection)
is a [code injection](https://en.wikipedia.org/wiki/Code_injection)
technique used to attack data-driven applications,
in which malicious SQL statements are inserted
into an entry field for execution
(*e.g., to dump the database contents to the attacker*)

<!-- Info {{{-->
> [!info]- Resources
>
> - [Wikipedia](https://en.wikipedia.org/wiki/SQL_injection)
>
> Queries
>
> - [Stacked queries](https://www.sqlinjection.net/stacked-queries/)
> - [Union queries](https://www.mysqltutorial.org/mysql-basics/mysql-union/)
>
> PortSwigger Academy
>
> - [SQL Injection](https://portswigger.net/web-security/sql-injection)
> - [SQL Injection Learning Path](https://portswigger.net/web-security/learning-paths/sql-injection)
>
<!-- }}} -->

**Example**

1. The [[PHP/General|PHP]] web application is using an SQL database

```php
$searchInput =  $_POST['findUser'];
$query = "select * from logins where username like '%$searchInput'";
$result = $conn->query($query);
```

2. The code executes a [[MySQL/General|MySQL]] query directly,
   without input sanitization

```sql
select * from logins where username like '%$searchInput'
```

3. User inputs a malicious query

```sql
1'; DROP TABLE users;`
```

4. The query gets misinterpreted

```sql
select * from logins where username like '%1'; DROP TABLE users;--'
```

<!-- Info {{{-->
> [!info]
>
> - `'`: Escape the bounds of the user input
> - `DROP TABLE users`: Delete the table
> - `--`: Comment out the trailing single quote to avoid syntax error
>
<!-- }}} -->

___

<!-- Types {{{-->
## Types

SQL Injections are categorized
based on how and where we retrieve their output

<!-- Info {{{-->
> [!info]- SQL Injection Types
>
> ![[sql-injection-types.png]]
>
<!-- }}} -->

<!-- In-band {{{-->
### In-band

**In-band SQL injection** is where the attacker receives the result
as a direct response using the same communicatin channel

<!-- Union-based {{{-->
#### Union-based

**Union-based SQL injection** is where the attacker
uses the [UNION](https://dev.mysql.com/doc/en/union.html) SQL clause
to receive a result that combines legitimate information with sensitive data

<!-- }}} -->

<!-- Error-based {{{-->
#### Error-based

**Error-based SQL injection** is used to display PHP or SQL errors
on the front-end

<!-- Example {{{-->
> [!example]-
>
> The web applicaiton is issuing a query
>
> ```sql
> SELECT * FROM users WHERE user_id = 'current_user'
> ```
>
> A malicious user may provides a `current_user` value
>
> ```sql
> 1'
> ```
>
> The query becomes
>
> ```sql
> SELECT * FROM users WHERE user_id = '1''
> ```
>
> The doubled single quote causes the database to report an error
>
> ```
> You have an error in your SQL syntax; check the manual that corresponds to
> your MySQL server version for the right syntax to use near "' at line 1
> Warning: mysql_fetch_array() expects parameter 1 to be resource, boolean
> given in /hj/var/www/query.php on line 37
> ```
>
> The attacker can see that the application is using a MySQL database,
> and can now focus on MySQL-specific attacks
>
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

<!-- Blind {{{-->
### Blind

**Blind SQL injection** doesn't display the output

<!-- Boolean-based {{{-->
#### Boolean-based

**Boolean-based SQL injection** is using SQL conditional statements
to control whether the page returns any output at all

<!-- }}} -->

<!-- Time-based {{{-->
#### Time-based

**Time-based SQL injections** using SQL conditional statements
that delay the page response if the conditional statement returns `true`
using the [Sleep()](https://dev.mysql.com/doc/en/miscellaneous-functions.html#function_sleep)
function

<!-- }}} -->

<!-- }}} -->

<!-- Out-of-band {{{-->
### Out-of-band

**Out-of-band SQL injection** is when the output cannot be accessed directly
and may have to be redirected to a remote location
(*e.g., DNS record*)

<!-- }}} -->

___
<!-- }}} -->

<!-- Databases {{{-->
## Databases

Backend database structures (*Database Management Systems*)
used to store and retrieve data related to the web applicaiton

<!-- Tip {{{-->
> [!tip]- DBMS Features
>
>
> | Feature  | Description |
> | -------- | ----------- |
> | Concurrency | A real-world application might have multiple users interacting with it simultaneously. A DBMS makes sure that these concurrent interactions succeed without corrupting or losing any data. |
> | Consistency | With so many concurrent interactions, the DBMS needs to ensure that the data remains consistent and valid throughout the database. |
> | Security | DBMS provides fine-grained security controls through user authentication and permissions. This will prevent unauthorized viewing or editing of sensitive data. |
> | Reliability | It is easy to backup databases and rolls them back to a previous state in case of data loss or a breach. |
> | Structured Query Language | SQL simplifies user interaction with the database with an intuitive syntax supporting various operations. |
>
<!-- }}} -->

1. **Tier 1**: Client side application

The user sends a HTTP(S) Request

2. **Tier 2**: Application server (*middleware*)

The backend interprets the request and
issue queries to the database

3. Database Management system

The database performs the requested operation
and constructs a response
(*e.g., insertion, retrieval, deletion, updating*)

<!-- Example {{{-->
> [!example]-
>
> ![[sql-general.png]]
>
<!-- }}} -->

<!-- Reational Databases {{{-->
### Reational Databases

**Relational Databases** utilize SQL
and use a schema (*template*)
to dictate the stored data structure

Relational Databases using a key
(*relational database management system (RDBMS)*)
to link one table to another

The relationship between tables within a database is called a Schema

<!-- }}} -->

<!-- Non-Relational Databases {{{-->
### Non-Relational Databases

**Non-Relational Databases** (*NoSQL databases*)
utilize a variety of methods for communications

NoSQL databases doesn't use tables, rows, columns,
or prime keys, relationships and schemas

NoSQL database stores data using various storage models,
depending on the type of data stored

- Key-Value (*e.g., json, xml*)
- Document-Based
- Wide-Column
- Graph

<!-- Example {{{-->
> [!example]-
>
> Key-Value model
>
> ```json
> {
>   "100001": {
>     "date": "01-01-2021",
>     "content": "Welcome to this web application."
>   },
>   "100002": {
>     "date": "02-01-2021",
>     "content": "This is the first post on this web app."
>   },
>   "100003": {
>     "date": "02-01-2021",
>     "content": "Reminder: Tomorrow is the ..."
>   }
> }
> ```
>
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Prevention {{{-->
## Prevention

SQL injections are usually caused by poorly coded web applications
or poorly secured back-end server and databases privileges

<!-- Input Sanitization {{{-->
### Input Sanitization

Libraries provide multiple functions to sanitize user inputs
and escape characters (*e.g., `'`, `"`*)

[mysqli_real_escape_string()](https://www.php.net/manual/en/mysqli.real-escape-string.php)

<!-- Example {{{-->
> [!example]-
>
> ```php
> <SNIP>
> $username = mysqli_real_escape_string($conn, $_POST['username']);
> $password = mysqli_real_escape_string($conn, $_POST['password']);
>
> $query = "SELECT * FROM logins WHERE username='". $username. "' AND password = '" . $password . "';" ;
> echo "Executing query: " . $query . "<br /><br />";
> <SNIP>
> ```
>
<!-- }}} -->

[pg_escape_string()](https://www.php.net/manual/en/function.pg-escape-string.php)
(*PostgreSQL*)

<!-- Example {{{-->
> [!example]-
>
> ```php
> <?php
>   // Connect to the database
>   $dbconn = pg_connect('dbname=foo');
>
>   // Read in a text file (containing apostrophes and backslashes)
>   $data = file_get_contents('letter.txt');
>
>   // Escape the text data
>   $escaped = pg_escape_string($data);
>
>   // Insert it into the database
>   pg_query("INSERT INTO correspondence (name, data) VALUES ('My letter', '{$escaped}')");
> ?>
> ```
>
<!-- }}} -->

<!-- }}} -->

<!-- Input Validation {{{-->
### Input Validation

User input can be validated based on the data
used to query to ensure that it matches the expected input

[preg_match()](https://www.php.net/manual/en/function.preg-match.php)

<!-- Example {{{-->
> [!example]-
>
> Restrict user input to [[RegEx/General|RegEx]] defined characters
>
> ```php
> <SNIP>
> $pattern = "/^[A-Za-z\s]+$/";
> $code = $_GET["port_code"];
>
> if(!preg_match($pattern, $code)) {
>   die("</table></div><p style='font-size: 15px;'>Invalid input! Please try again.</p>");
> }
>
> $q = "Select * from ports where port_code ilike '%" . $code . "%'";
> <SNIP>
> ```
<!-- }}} -->


<!-- }}} -->

<!-- User Privileges {{{-->
### User Privileges

Ensure the user querying the database has minimal set of permissions

<!-- Warning {{{-->
> [!warning]
>
> Superusers and users with administrative privileges
> should never be used with web applications
>
<!-- }}} -->

<!-- }}} -->

<!-- Web Application Firewalls {{{-->
### Web Application Firewalls

**Web Application Firewalls** (*[[WAF]]*)
are used to detect malicious input
and reject any HTTP requests containing them

WAFs help in preventing SQL Injection
even when the application logic is flawed
(*e.g., reject any request containing the string `INFORMATION_SCHEMA`*)

<!-- }}} -->

<!-- Parameterized Queries {{{-->
### Parameterized Queries

**Parameterized queries** contain placeholders for the input data,
which is then escaped and passed on by the drivers.

Use placeholders and then fill them with PHP functions
instead of directly passing the data into the SQL query

<!-- Example {{{-->
> [!example]-
>
> The query is modified to contain two placeholders,
> marked with `?` where the username and password will be placed
>
> Bind the username and password to the query
> using the [mysqli_stmt_bind_param()](https://www.php.net/manual/en/mysqli-stmt.bind-param.php)
> function to will safely escape any quotes
> and place the values in the query
>
> ```php
> <SNIP>
>   $username = $_POST['username'];
>   $password = $_POST['password'];
>
>   $query = "SELECT * FROM logins WHERE username=? AND password = ?" ;
>   $stmt = mysqli_prepare($conn, $query);
>   mysqli_stmt_bind_param($stmt, 'ss', $username, $password);
>   mysqli_stmt_execute($stmt);
>   $result = mysqli_stmt_get_result($stmt);
>
>   $row = mysqli_fetch_array($result);
>   mysqli_stmt_close($stmt);
> <SNIP>
> ```
<!-- }}} -->


<!-- }}} -->

___
<!-- }}} -->
