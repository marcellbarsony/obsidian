---
id: File  Upload
aliases: []
tags:
  - Webapp/Exploitation/File-Upload/General
---

# File Upload Functionality

**File Upload Vulnerabilities** arise when user input and uploaded files
are not correctly filtered and validated.
Failing to propersly enforce restrictions may lead attackers
exploit the file upload feature and perform malicious activities
(*e.g, executing arbitrary commands on the back-end server*)

[Unrestricted File Upload](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
allows any unauthenticated user to upload any file type

<!-- Info - Resoruces {{{-->
> [!info]- Resources
>
> [OWASP WSTG](https://owasp.org/www-project-web-security-testing-guide/stable/)
>
> - [Test Upload of Unexpected File Types](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/10-Business_Logic_Testing/08-Test_Upload_of_Unexpected_File_Types)
> - [Test Upload of Malicious File Types](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/10-Business_Logic_Testing/09-Test_Upload_of_Malicious_Files)
> - [Test File Extensions Handling for Sensitive Information](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/03-Test_File_Extensions_Handling_for_Sensitive_Information)
>
> [PayloadsAllTheThings](https://swisskyrepo.github.io/PayloadsAllTheThings/)
>
> - [Upload Insecure Files](https://swisskyrepo.github.io/PayloadsAllTheThings/Upload%20Insecure%20Files)
> - [htaccess](https://swisskyrepo.github.io/PayloadsAllTheThings/Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/)
>
> [PortSwigger Academy](https://portswigger.net/web-security)
>
> - [File Uploads](https://portswigger.net/web-security/file-upload)
>
<!-- }}} -->

<!-- Info - Mindmap {{{-->
> [!info]- Mindmap
>
> [Source](https://swisskyrepo.github.io/PayloadsAllTheThings/Upload%20Insecure%20Files/#methodology)
>
> ![[file-upload-mindmap.png]]
>
<!-- }}} -->

___

<!-- HTML Forms {{{-->
## HTML Forms

When submitting HTML forms,
the browser typically sends the provided data in a [[POST]] request
with the content type `application/x-www-form-urlencoded`

When large binary data is ten,
the content type `multipart/form-data` is preferred.

<!-- Example {{{-->
> [!example]-
>
> The message body is split into separate parts
> for each of the form's inputs
>
> ```sh
> POST /images HTTP/1.1
>     Host: normal-website.com
>     Content-Length: 12345
>     Content-Type: multipart/form-data; boundary=---------------------------012345678901234567890123456
>
>     ---------------------------012345678901234567890123456
>     Content-Disposition: form-data; name="image"; filename="example.jpg"
>     Content-Type: image/jpeg
>
>     [...binary content of example.jpg...]
>
>     ---------------------------012345678901234567890123456
>     Content-Disposition: form-data; name="description"
>
>     This is an interesting description of my image.
>
>     ---------------------------012345678901234567890123456
>     Content-Disposition: form-data; name="username"
>
>     wiener
>     ---------------------------012345678901234567890123456--
> ```
<!-- }}} -->


<!-- }}} -->

<!-- Prevention {{{-->
## Prevention

<!-- Extension Validation {{{-->
### Extension Validation

Implement both withelist and blacklist filters

- [[Exploitation#Whitelist Filters|Whitelist Filter]]:
  Check if the file name ends with the extensions
- [[Exploitation#Blacklist Filters|Blacklist Filter]]:
  Check if the extension exists anywhere within the file name

<!-- Example {{{-->
> [!example]-
>
> The blacklist filter will prevent uploading malicious scripts
> if the whitelist is ever bypassed (*e.g. `shell.php.jpg`*)
>
>
> ```php
> $fileName = basename($_FILES["uploadFile"]["name"]);
>
> // Blacklist Test
> if (preg_match('/^.*\.ph(p|ps|ar|tml)/', $fileName)) {
>     echo "Only images are allowed";
>     die();
> }
>
> // Whitelist Test
> if (!preg_match('/^.*\.(jpg|jpeg|png|gif)$/', $fileName)) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
<!-- }}} -->

<!-- }}} -->

<!-- Content Validation {{{-->
### Content Validation

Validate [[Content-Type]] header and
[File Signature](https://en.wikipedia.org/wiki/List_of_file_signatures)
(*[Magic Bytes](https://web.archive.org/web/20240522030920/https://opensource.apple.com/source/file/file-23/file/magic/magic.mime)*)

<!-- Example {{{-->
> [!example]-
>
> ```php
> $fileName = basename($_FILES["uploadFile"]["name"]);
> $contentType = $_FILES['uploadFile']['type'];
> $MIMEtype = mime_content_type($_FILES['uploadFile']['tmp_name']);
>
> // whitelist test
> if (!preg_match('/^.*\.png$/', $fileName)) {
>     echo "Only PNG images are allowed";
>     die();
> }
>
> // content test
> foreach (array($contentType, $MIMEtype) as $type) {
>     if (!in_array($type, array('image/png'))) {
>         echo "Only PNG images are allowed";
>         die();
>     }
> }
> ```
>
<!-- }}} -->

<!-- }}} -->

<!-- Upload Disclosure {{{-->
### Upload Disclosure

- Users should not have direct access to the upload directory
  but receive [403 Forbidden](https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Status/403)

> [!todo]

<!-- }}} -->

<!-- Additional Measures {{{-->
### Additional Measures

Disable specific functions that may be used
to execute system commands through the web application

<!-- Example {{{-->
> [!example]-
>
> In PHP, use the `disable_functions` configuration in `php.ini`
> to disable `exec`, `shell_exec`, `system`, `passthru`, etc.
>
<!-- }}} -->

- Disable showing system or server errors
- Limit file size
- Update any used libraries
- Scan uploaded files for malware or malicious strings
- Utilize a Web Application Firewall (WAF)
  as a secondary layer of protection

<!-- }}} -->

___
<!-- }}} -->
