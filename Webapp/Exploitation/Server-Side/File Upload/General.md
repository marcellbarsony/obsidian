---
id: Upload
aliases: []
tags:
  - Webapp/Exploitation/Upload-Functionality
---

# File Upload Functionality

If user input and uploaded files
are not correctly filtered and validated,
attackers may be able to exploit the file upload feature
to perform malicious activities
(*e.g, executing arbitrary commands on the back-end server*)

[Unrestricted File Upload](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
allows any unauthenticated user to upload any file type

<!-- Info - Resoruces {{{-->
> [!info]- Resources
>
> [OWASP WSTG](https://owasp.org/www-project-web-security-testing-guide/stable/)
>
> - [Test Upload of Unexpected File Types](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/10-Business_Logic_Testing/08-Test_Upload_of_Unexpected_File_Types)
> - [Test Upload of Malicious File Types](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/10-Business_Logic_Testing/09-Test_Upload_of_Malicious_Files)
> - [Test File Extensions Handling for Sensitive Information](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/03-Test_File_Extensions_Handling_for_Sensitive_Information)
>
> [PayloadsAllTheThings](https://swisskyrepo.github.io/PayloadsAllTheThings/)
>
> - [Upload Insecure Files](https://swisskyrepo.github.io/PayloadsAllTheThings/Upload%20Insecure%20Files)
> - [htaccess](https://swisskyrepo.github.io/PayloadsAllTheThings/Upload%20Insecure%20Files/Configuration%20Apache%20.htaccess/)
>
<!-- }}} -->

<!-- Info - File Upload Mindmap {{{-->
> [!info]- File Upload Mindmap
>
> ![[file-upload-mindmap.png]]
>
<!-- }}} -->

___

<!-- Enumeration {{{-->
## Enumeration

Enumerate the file upload functionality

1. Create test script

```sh
echo "<?php echo "Exploited";?>" > test.php
```

2. Upload test script

3. Query the uploaded file
   (*or click `Download`*)

```sh
curl $target/uploads/test.php
```

___
<!-- }}} -->

<!-- Exploit {{{-->
## Exploit

Bypass file upload restrictions

___

<!-- Client-Side Validation {{{-->
### Client-Side Validation

Many web applications only rely on front-end JavaScript code
to validate the selected file format before it is uploaded
and would not upload it if the file is not in the required format

<!-- Info {{{-->
> [!info]-
>
> The File Upload dialog limits the allowed image formats
>
> ![[file-upload-select-file-types.jpg]]
>
<!-- }}} -->

**Back-end Request Modification**

1. Capture the upload request

2. Modify the `filename` parameter

```sh
filename="shell.php"
```

**Disable Client-Side Validation**

1. [Page Inspector](https://firefox-source-docs.mozilla.org/devtools-user/page_inspector/):
   Highlight the upload button/profile picture
   to inspect the surrounding code

<!-- Example {{{-->
> [!example]-
>
> ![[page-inspector.png]]
>
<!-- }}} -->

2. Identify the JavaScript function called from the HTML element
   to validate the file

<!-- Example {{{-->
> [!example]-
>
> [onchange](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event)
> calls a JavaScript function to validate files
>
> ```sh
> <input type="file" name="uploadFile" id="uploadFile" onchange="checkFile(this)" accept=".jpg,.jpeg,.png">
> ```
> ```sh
> onchange="checkFile(this)"
> ```
>
> [onsubmit](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/submit_event)
> calls a JavaScript function to validate files
> within the enclosing `form`
>
> ```sh
> <form action="upload.php" method="POST" enctype="multipart/form-data" id="uploadForm" onsubmit="if(validate()){upload()}">
>         <input type="file" name="uploadFile" id="uploadFile" onchange="showImage()" accept=".jpg,.jpeg,.png">
>         <img src="/profile_images/default.jpg" class="profile-image" id="profile-image">
>         <input type="submit" value="Upload" id="submit">
> </form>
> ```
> ```sh
> onsubmit="if(validate()){upload()}"
> ```
>
<!-- }}} -->

3. Disable client-side validation

<!-- Example {{{-->
> [!example]-
>
> 1. Remove the function call from HTML
>
> [onchange](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event)
>
> ```sh
> onchange="checkFile(this)"
> ```
>
> ```sh
> onchange=""
> ```
>
> [onsubmit](https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/submit_event)
>
> ```sh
> onsubmit="if(validate()){upload()}"
> ```
> ```sh
> onsubmit="upload()"
> ```
>
> 2. [Web Console](https://firefox-source-docs.mozilla.org/devtools-user/web_console/):
>    Delete the JavaScript function (*optional*)
>
<!-- }}} -->

___
<!-- }}} -->

<!-- Extension Filters {{{-->
### Extension Filters

Enumerate extension filters implemented on the back-end

<!-- Tip - Wordlists {{{-->
> [!tip]- Wordlists
>
> [[Seclists#Web Extensions|Seclists]]
>
<!-- }}} -->

Fuzz web file extensions to identify allowed
extensions

1. [[Burp Suite/Proxy#Proxy|Burp Suite]] —
   Intercept file upload request

2.
   Fuzz file extensions

<!-- Example {{{-->
> [!example]-
>
> [[Burp Suite/Intruder|Burp Suite Intruder]]
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-file-extensions.png]]
>
<!-- }}} -->

3. Investigate HTTP responses

<!-- Example {{{-->
> [!example]-
>
> Unsuccessful and successful responses
> usually have different sizes
>
<!-- }}} -->

<!-- Blacklist Filters {{{-->
#### Blacklist Filters

Blacklist filters are testing the file extensions
against a list of disallowed extensions

<!-- Info {{{-->
> [!info]-
>
> The PHP code is taking the file extension (`$extension`)
> from the uploaded file name (`$fileName`)
> and then comparing it against
> a list of blacklisted extensions (`$blacklist`).
>
> ```php
> $fileName = basename($_FILES["uploadFile"]["name"]);
> $extension = pathinfo($fileName, PATHINFO_EXTENSION);
> $blacklist = array('php', 'php7', 'phps');
>
> if (in_array($extension, $blacklist)) {
>     echo "File type not allowed";
>     die();
> }
> ```
>
> <!-- Warning {{{-->
> > [!warning]
> >
> > The blacklist is not comprehensive
> >
> <!-- }}} -->
>
<!-- }}} -->

1. Upload a web shell using a valid extension
   that is not covered by the blacklist

<!-- Example {{{-->
> [!example]-
>
> Upload a PHP shell with `.phar` extension
>
> [[Burp Suite/Repeater|Burp Suite Repeater]]
>
> ![[burp-file-extension.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- Whitelist Filters {{{-->
#### Whitelist Filters

Whitelist filters are testing the file extensions
against a list of allowed file extensions

**Double Extension**

Upload a web shell using double extensions
that is not checked by the whitelist

<!-- Info {{{-->
> [!info]-
>
> The PHP script uses a Regular Expression (*RegEx*)
> to test whether the filename contains
> any whitelisted image extensions
>
> ```sh
> $fileName = basename($_FILES["uploadFile"]["name"]);
>
> if (!preg_match('^.*\.(jpg|jpeg|png|gif)', $fileName)) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
> <!-- Warning {{{-->
> > [!warning]
> >
> > RegEx only checks whether the file name contains the extension
> > and not if it actually ends with it
> > ```sh
> > .jpg.php
> > ```
> > ```sh
> > .png.php5
> > ```
> <!-- }}} -->
>
<!-- }}} -->

1. Use a whitelisted first extension

2. Fuzz allowed double extensions

<!-- Example {{{-->
> [!example]-
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-double-extensions.png]]
>
<!-- }}} -->

**Reverse Double Extension**

Upload a web shell using reverse double extensions
that is not checked by the whitelist

<!-- Info {{{-->
> [!info]-
>
> Apache2's misconfigured `/etc/apache2/mods-enabled/php7.4.conf`
> may allow PHP code execution
>
> ```xml
> <FilesMatch ".+\.ph(ar|p|tml)">
>     SetHandler application/x-httpd-php
> </FilesMatch>
> ```
>
> <!-- Warning {{{ -->
> > [!warning]
> >
> > Files with reverse double extensions may pass the RegEx filter
> > and get executed
> >
> > ```sh
> > .php.jpg
> > ```
> > ```sh
> > .php5.png
> > ```
> <!-- }}} -->
>
<!-- }}} -->

1. Use a whitelisted final extension

2. Fuzz allowed reverse double extensions

<!-- Example {{{-->
> [!example]-
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-reverse-double-extensions.png]]
>
<!-- }}} -->

**Character Injection**

Bypass whitelist filters using character injection
that can cause the web application to misinterpret the filename

<!-- Info {{{-->
> [!info]-
>
> Applications may end parsing the file name after special characters,
> and store the file while passing whitelist
>
> PHP server version `5.X` and earlier end parsing after `%00`
>
> ```sh
> shell.php%00.jpg
> ```
>
> Windows servers may end parsing after `:`
>
> ```sh
> shell.aspx:.jpg
> ```
>
<!-- }}} -->

1. Generate special character permutation wordlist

<!-- Example {{{-->
> [!example]-
>
> Generate all permutations to inject special characters
> before and after both `PHP` and `JPG` extensions
>
> ```sh
> for char in '%20' '%0a' '%00' '%0d0a' '/' '.\\' '.' '…' ':'; do
>     for ext in '.php' '.phps'; do
>         echo "shell$char$ext.jpg" >> wordlist.txt  # shell%20.php.jpg
>         echo "shell$ext$char.jpg" >> wordlist.txt  # shell.php%20.jpg
>         echo "shell.jpg$char$ext" >> wordlist.txt  # shell.jpg%20.php
>         echo "shell.jpg$ext$char" >> wordlist.txt  # shell.jpg.php%20
>     done
> done
> ```
>
<!-- }}} -->

2. Fuzz the file name with injected characters

<!-- Example {{{-->
> [!example]-
>
>
> ![[burp-fuzz-character-injection.png]]
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->

<!-- Type Filters {{{-->
### Type Filters

There are two common methods for validating the file content:
- Content-Type Header
- File Content

<!-- Content-Type {{{-->
#### Content-Type

[[HTTP/Header/Representation/Content-Type|Content-Type]]

<!-- Info {{{-->
> [!info]-
>
> PHP application Content-Type header test to validate the file type
>
> - `$type`: Set from the uploaded file's Content-Type header
>
> ```sh
> $type = $_FILES['uploadFile']['type'];
>
> if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
<!-- }}} -->


<!-- Wordlists {{{-->
> [!tip]- Wordlists
>
> SecLists
>
> [[Seclists#Content Type|Content-Type]]
>
> Filter content types (*optional*)
>
> ```sh
> cat web-all-content-types.txt | grep 'image/' > image-content-types.txt
> ```
>
<!-- }}} -->

1. Fuzz allowed Content-Type header

<!-- Example {{{-->
> [!example]-
>
> <!-- Tip {{{-->
> > [!tip]
> >
> > Disable [Payload Encoding](https://portswigger.net/burp/documentation/desktop/tools/intruder/configure-attack/processing)
> >
> <!-- }}} -->
>
> ![[burp-fuzz-content-type.png]]
>
<!-- }}} -->

2. Set an allowed Content-Type header

<!-- Example {{{-->
> [!example]-
>
> Set Content-Type  header: `image/jpeg`
>
> ![[burp-content-type.png]]
>
<!-- }}} -->

<!-- }}} -->

<!-- MIME-Type {{{-->
#### MIME-Type

[[HTTP/Header/Representation/MIME-Type|MIME-Type]]

<!-- Info {{{-->
> [!info]-
>
> PHP web application MIME type test
>
> ```php
> $type = mime_content_type($_FILES['uploadFile']['tmp_name']);
>
> if (!in_array($type, array('image/jpg', 'image/jpeg', 'image/png', 'image/gif'))) {
>     echo "Only images are allowed";
>     die();
> }
> ```
>
<!-- }}} -->

Create polyglot files to bypass MIME-Type validation

<!-- Example {{{-->
> [!example]-
>
> Create a `GIF8` polyglot file
>
> ```sh
> echo "GIF8" > text.jpg
> ```
>
> ![[burp-polyglot.png]]
>
>
<!-- }}} -->

<!-- }}} -->

___
<!-- }}} -->







<!-- Htaccess Override {{{-->
### Htaccess Override

Override  [[Apache HTTP Server/General#.htaccess|.htaccess]]
to make [[Apache HTTP Server/General|Apache HTTP Server]]
interpret arbitrary file extensions as `.php`

1. Create `.htaccess` file

```sh
AddType mime-type extension [extension ...]
```

<!-- Example {{{-->
> [!example]-
>
> Execute `.png` extensions as `.php`
>
> ```sh
> echo "AddType application/x-httpd.php .png" > .htaccess
> ```
>
> Execute `.exploit` extensions as `.php`
>
> ```sh
> echo "AddType application/x-httpd.php .exploit" > .htaccess
> ```
>
<!-- }}} -->

2. Upload `.htaccess` to the target

___
<!-- }}} -->


___
<!-- }}} -->


















## Extensions/Plugins

## HTTP Verb Tampering

HTTP verb tampering (e.g., `TRACK`, `PUT`, `MOVE`)
